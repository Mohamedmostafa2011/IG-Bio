<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Reproduction in Plants</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Botanical Theme */
            --primary: #db2777; /* Pink-600 */
            --primary-dark: #9d174d;
            --accent: #fbbf24; /* Pollen Gold */
            --bg: #fdf2f8;
            --surface: #ffffff;
            --text: #4a044e;
            --border: #fbcfe8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: var(--text); }
        .btn-accent:hover { background: #f59e0b; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #fce7f3;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #fce7f3; color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--accent); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #fffbeb; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #fbcfe8; padding: 10px; text-align: left; }
        th { background: #fce7f3; color: var(--primary-dark); }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: var(--primary-dark);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #fdf2f8;
            border: 1px solid #fbcfe8;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #fce7f3; border-color: var(--primary); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary);">Generating File...</p>
    </div>

    <header>
        <h1>Reproduction in Plants</h1>
        <p>IGCSE Biology 0610 | Complete Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-flask"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>Understand the lifecycle of plants from flower to fruit. Select a track.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Asexual vs Sexual</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Flower Structure</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Pollination</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Fertilization & Germination</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Asexual vs Sexual</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #fbcfe8; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Types of Reproduction</h3>
                    <ul>
                        <li><strong>Asexual Reproduction:</strong> Process resulting in the production of genetically identical offspring from one parent. (Examples: Potato tubers, Strawberry runners).
                            <br><em>Advantage:</em> Fast, only one parent needed. <em>Disadvantage:</em> No genetic variation.</li>
                        <li><strong>Sexual Reproduction:</strong> Process involving the fusion of the nuclei of two gametes to form a zygote and the production of genetically different offspring.
                            <br><em>Advantage:</em> Genetic variation (adapt to change). <em>Disadvantage:</em> Slower, needs two parents/gametes.</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>2. Flower Structure</h3>
                    <table border="1">
                        <tr><th>Part</th><th>Function</th></tr>
                        <tr><td><strong>Sepal</strong></td><td>Protects flower bud.</td></tr>
                        <tr><td><strong>Petal</strong></td><td>Brightly colored to attract insects.</td></tr>
                        <tr><td><strong>Anther (Male)</strong></td><td>Produces pollen grains.</td></tr>
                        <tr><td><strong>Stigma (Female)</strong></td><td>Platform where pollen lands.</td></tr>
                        <tr><td><strong>Ovary (Female)</strong></td><td>Contains ovules (female gametes).</td></tr>
                    </table>
                </div>

                <div class="note-topic">
                    <h3>3. Pollination</h3>
                    <div class="definition">
                        <strong>Pollination:</strong> The transfer of pollen grains from the anther to the stigma.
                    </div>
                    <ul>
                        <li><strong>Insect-Pollinated:</strong> Large colorful petals, scent, nectar, sticky pollen, sticky stigma inside flower.</li>
                        <li><strong>Wind-Pollinated:</strong> Dull/small petals, no scent, light smooth pollen, feathery stigma outside flower (to catch wind).</li>
                        <li><strong>Self-Pollination:</strong> Same flower/plant. Reduces variation.</li>
                        <li><strong>Cross-Pollination:</strong> Different plant (same species). Increases variation.</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>4. Fertilization & Germination</h3>
                    <p><strong>Fertilization:</strong> Pollen tube grows down the style into the ovary. Male nucleus fuses with female nucleus in the ovule to form a Zygote.</p>
                    <ul>
                        <li>Ovule becomes <strong>Seed</strong>.</li>
                        <li>Ovary becomes <strong>Fruit</strong>.</li>
                    </ul>
                    <p><strong>Germination Requirements (WOW):</strong></p>
                    <ul>
                        <li><strong>W</strong>ater (for enzymes).</li>
                        <li><strong>O</strong>xygen (for respiration).</li>
                        <li><strong>W</strong>armth (optimum temp for enzymes).</li>
                        <li><em>Note: Light is NOT required for germination (most seeds are underground).</em></li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view the reproductive cycle.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">PLANT REPRODUCTION</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: Types -->
                        <div class="mm-column">
                            <div class="mm-category">Types</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Asexual</strong>1 Parent, Clones</div>
                                <div class="mm-node"><strong>Sexual</strong>2 Gametes, Variation</div>
                                <div class="mm-node"><strong>Gametes</strong>Pollen & Ovules</div>
                            </div>
                        </div>

                        <!-- Branch 2: Anatomy -->
                        <div class="mm-column">
                            <div class="mm-category">Flower Parts</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Stamen (M)</strong>Anther + Filament</div>
                                <div class="mm-node"><strong>Carpel (F)</strong>Stigma, Style, Ovary</div>
                                <div class="mm-node"><strong>Petal/Sepal</strong>Attract/Protect</div>
                            </div>
                        </div>

                        <!-- Branch 3: Pollination -->
                        <div class="mm-column">
                            <div class="mm-category">Pollination</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Insect</strong>Sticky pollen, Nectar</div>
                                <div class="mm-node"><strong>Wind</strong>Light pollen, Feathery stigma</div>
                                <div class="mm-node"><strong>Cross</strong>Variation++</div>
                            </div>
                        </div>

                        <!-- Branch 4: Growth -->
                        <div class="mm-column">
                            <div class="mm-category">Growth</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Fertilization</strong>Fusion of nuclei</div>
                                <div class="mm-node"><strong>Seed</strong>From Ovule</div>
                                <div class="mm-node"><strong>Germination</strong>Water, Oxygen, Warmth</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#fce7f3; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--primary);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #fbcfe8; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Asexual vs Sexual Reproduction. Asexual reproduction involves only one parent and produces genetically identical offspring called clones. Examples include runners in strawberries and tubers in potatoes. It is fast but offers no variation. Sexual reproduction involves the fusion of two gametes (pollen and ovule) to form a zygote. This produces genetically different offspring, providing variation which helps species adapt to new environments.",
            "Track 2: Flower Structure. Flowers are the reproductive organs. The male part is the Stamen, consisting of the Anther (makes pollen) and Filament. The female part is the Carpel, consisting of the Stigma (receives pollen), Style, and Ovary (contains ovules). Petals attract insects, while Sepals protect the flower bud.",
            "Track 3: Pollination. Pollination is the transfer of pollen from anther to stigma. Insect-pollinated flowers have large colored petals, scent, nectar, and sticky pollen. Wind-pollinated flowers have small dull petals, no scent, and produce huge amounts of light, smooth pollen. Their stigmas are feathery and hang outside to catch pollen from the air.",
            "Track 4: Fertilization and Germination. After pollination, a pollen tube grows down the style to the ovary. The male nucleus travels down and fuses with the female nucleus in the ovule. This is Fertilization. The Ovule becomes the Seed, and the Ovary becomes the Fruit. For a seed to germinate, it needs Water, Oxygen, and Warmth (WOW). It does NOT need light until it grows leaves."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Asexual vs Sexual", "2. Flower Structure", "3. Pollination", "4. Fertilization & Germination"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(219, 39, 119); // Pink
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Chapter 16: Reproduction in Plants", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Asexual vs Sexual", "2. Flower Structure", "3. Pollination", "4. Fertilization & Germination"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Ch16_PlantReproduction_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Ch16_PlantReproduction_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ch16_PlantReproduction_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "Which term describes reproduction using only one parent?", o: ["Sexual", "Asexual", "Fertilization", "Pollination"], a: 1, e: "Asexual reproduction involves a single parent and produces clones." },
            { q: "Where is pollen produced?", o: ["Stigma", "Ovary", "Anther", "Sepal"], a: 2, e: "The anther is the part of the stamen that produces pollen grains." },
            { q: "Which condition is NOT required for germination?", o: ["Water", "Oxygen", "Light", "Warmth"], a: 2, e: "Most seeds germinate underground and do not need light until leaves form." },
            { q: "What does the ovule become after fertilization?", o: ["Fruit", "Seed", "Stem", "Root"], a: 1, e: "The ovule develops into the seed, while the ovary becomes the fruit." },
            { q: "Which feature is typical of insect-pollinated flowers?", o: ["Small dull petals", "Large feathery stigma", "Sticky pollen", "No scent"], a: 2, e: "Sticky pollen allows grains to attach to the insect's body." },
            { q: "Pollination is the transfer of pollen from...", o: ["Anther to Stigma", "Stigma to Anther", "Ovary to Style", "Petal to Sepal"], a: 0, e: "Pollination moves pollen from male anther to female stigma." },
            { q: "Genetically distinct offspring are produced by...", o: ["Asexual reproduction", "Sexual reproduction", "Binary fission", "Cloning"], a: 1, e: "Fusion of gametes in sexual reproduction creates genetic variation." },
            { q: "Where does the pollen tube grow?", o: ["Up the filament", "Down the style", "Into the anther", "Around the sepal"], a: 1, e: "The pollen tube grows down the style to reach the ovule in the ovary." },
            { q: "Cross-pollination involves...", o: ["Same flower", "Different plants of different species", "Different plants of same species", "Same plant"], a: 2, e: "Cross-pollination moves pollen between different individuals of the same species." },
            { q: "What protects the flower when it is a bud?", o: ["Petals", "Sepals", "Stamen", "Carpel"], a: 1, e: "Sepals are the green leaf-like structures protecting the bud." }
        ];
        
        // Filling remaining questions
        const topics = ["Asexual", "Sexual", "Flower Parts", "Germination"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 4];
            questions.push({
                q: `Question ${i} (${t}): Select the correct statement regarding ${t}.`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(219, 39, 119);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Ch16_PlantReproduction_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
</html>
