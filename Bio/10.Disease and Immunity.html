<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Diseases and Immunity</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Defense Red Theme */
            --primary: #be123c; /* Rose-700 */
            --primary-dark: #881337;
            --accent: #f43f5e; /* Rose-500 */
            --bg: #fff1f2;
            --surface: #ffffff;
            --text: #4c0519;
            --border: #fda4af;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #9f1239; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #ffe4e6;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #ffe4e6; color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--accent); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #fff1f2; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #fda4af; padding: 10px; text-align: left; }
        th { background: #ffe4e6; color: var(--primary-dark); }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: var(--primary-dark);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #ffe4e6; border-color: var(--primary); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary);">Generating File...</p>
    </div>

    <header>
        <h1>Disease and Immunity</h1>
        <p>IGCSE Biology 0610 | Chapter 10 Complete Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-shield-virus"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>Learn about pathogens, body defenses, and how vaccines work. Select a track.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Pathogens & Transmission</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Body Defenses (Barriers)</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Immune Response</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Vaccination & Immunity</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Pathogens & Transmission</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #fda4af; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Pathogens and Transmission</h3>
                    <div class="definition">
                        <strong>Pathogen:</strong> A disease-causing organism. Can be a Virus, Bacterium, Fungus, or Protoctist.
                    </div>
                    <div class="definition">
                        <strong>Transmissible Disease:</strong> A disease in which the pathogen can be passed from one host to another.
                    </div>
                    <p><strong>Modes of Transmission:</strong></p>
                    <ul>
                        <li><strong>Direct Contact:</strong> Through blood or body fluids (e.g., HIV/AIDS).</li>
                        <li><strong>Indirect Contact:</strong> Contaminated food/water (Cholera), Air (Influenza), Animals/Vectors (Malaria mosquito).</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>2. Body Defenses</h3>
                    <p>The body has three lines of defense.</p>
                    <h4>1. Mechanical Barriers (Physical)</h4>
                    <ul>
                        <li><strong>Skin:</strong> Tough, waterproof barrier.</li>
                        <li><strong>Nose Hairs:</strong> Trap dust particles.</li>
                    </ul>
                    <h4>2. Chemical Barriers</h4>
                    <ul>
                        <li><strong>Stomach Acid (HCl):</strong> Kills bacteria in food.</li>
                        <li><strong>Mucus:</strong> Traps pathogens in trachea.</li>
                        <li><strong>White Blood Cells:</strong> (See below).</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>3. The Immune Response (White Blood Cells)</h3>
                    <table border="1">
                        <tr><th>Cell Type</th><th>Mode of Action</th></tr>
                        <tr>
                            <td><strong>Phagocytes</strong></td>
                            <td>Non-specific. They engulf and digest pathogens using enzymes (Phagocytosis).</td>
                        </tr>
                        <tr>
                            <td><strong>Lymphocytes</strong></td>
                            <td>Specific. They recognize antigens on pathogens and produce specific <span class="key-term">Antibodies</span>. Some create <span class="key-term">Memory Cells</span> for long-term immunity.</td>
                        </tr>
                    </table>
                    <p><strong>Antibodies work by:</strong> Causing pathogens to clump together (agglutination) so phagocytes can eat them easily, or neutralizing toxins.</p>
                </div>

                <div class="note-topic">
                    <h3>4. Immunity and Vaccination</h3>
                    <ul>
                        <li><strong>Active Immunity:</strong> Defence against a pathogen by antibody production in the body. Gained by infection or <strong>Vaccination</strong>.</li>
                        <li><strong>Passive Immunity:</strong> Short-term defense. Antibodies acquired from another individual (e.g., Breast milk to baby). No memory cells produced.</li>
                        <li><strong>Type 1 Diabetes:</strong> An autoimmune disease where the immune system attacks pancreas cells, stopping insulin production.</li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view the defense mechanisms.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">DISEASE & IMMUNITY</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: Pathogens -->
                        <div class="mm-column">
                            <div class="mm-category">Pathogens</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Types</strong>Virus, Bacteria, Fungi</div>
                                <div class="mm-node"><strong>Direct Contact</strong>Blood / Fluids</div>
                                <div class="mm-node"><strong>Indirect</strong>Air / Food / Vectors</div>
                                <div class="mm-node"><strong>Prevention</strong>Hygiene / Water treatment</div>
                            </div>
                        </div>

                        <!-- Branch 2: Barriers -->
                        <div class="mm-column">
                            <div class="mm-category">Barriers</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Mechanical</strong>Skin / Hairs</div>
                                <div class="mm-node"><strong>Chemical</strong>Mucus / Acid</div>
                                <div class="mm-node"><strong>Clotting</strong>Platelets / Fibrin</div>
                            </div>
                        </div>

                        <!-- Branch 3: WBCs -->
                        <div class="mm-column">
                            <div class="mm-category">White Blood Cells</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Phagocyte</strong>Engulf & Digest</div>
                                <div class="mm-node"><strong>Lymphocyte</strong>Make Antibodies</div>
                                <div class="mm-node"><strong>Antigens</strong>Unique markers</div>
                                <div class="mm-node"><strong>Memory Cells</strong>Long term memory</div>
                            </div>
                        </div>

                        <!-- Branch 4: Immunity -->
                        <div class="mm-column">
                            <div class="mm-category">Immunity Types</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Active</strong>Making own antibodies</div>
                                <div class="mm-node"><strong>Vaccination</strong>Dead pathogen injected</div>
                                <div class="mm-node"><strong>Passive</strong>Breast Milk (Short term)</div>
                                <div class="mm-node"><strong>Autoimmune</strong>Type 1 Diabetes</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#ffe4e6; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--primary);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #fda4af; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Pathogens and Transmission. A pathogen is a disease-causing organism, such as a bacterium, virus, fungus, or protoctist. Transmissible diseases move from host to host. Direct contact includes blood or body fluids, like HIV. Indirect contact includes contaminated water causing Cholera, droplets in air causing Influenza, or food causing Salmonella. Vectors are animals that carry the pathogen, like the mosquito carrying the malaria parasite.",
            "Track 2: Body Defenses. The body has barriers to stop pathogens entering. Mechanical barriers include the skin (a physical shield) and hairs in the nose. Chemical barriers include mucus produced by goblet cells to trap bacteria, and hydrochloric acid in the stomach to kill bacteria in food. If the skin is cut, platelets clot the blood to seal the wound and prevent entry.",
            "Track 3: The Immune Response. If pathogens pass the barriers, White Blood Cells attack. Phagocytes perform phagocytosis: they engulf and digest the pathogen. This is non-specific. Lymphocytes are specific. They recognize antigens on the pathogen's surface and produce complementary Antibodies. Antibodies destroy the pathogen by causing them to clump together or neutralizing toxins. Lymphocytes also make Memory Cells.",
            "Track 4: Vaccination and Immunity. Active immunity is when your body makes its own antibodies and memory cells. This happens after an infection or a Vaccination. A vaccine contains a dead or weakened pathogen. It triggers lymphocytes to make antibodies and memory cells without causing the disease. Passive immunity is receiving antibodies from another source, like breast milk. It is immediate but short-term as no memory cells are made."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Pathogens & Transmission", "2. Body Defenses", "3. Immune Response", "4. Vaccination"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(190, 18, 60); // Rose
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Chapter 10: Diseases and Immunity", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Pathogens & Transmission", "2. Body Defenses", "3. Immune Response", "4. Vaccination"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Ch10_Immunity_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Ch10_Immunity_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ch10_Immunity_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "What is a pathogen?", o: ["A disease-causing organism", "A white blood cell", "An antibody", "A harmless bacteria"], a: 0, e: "Pathogens are microorganisms like viruses, bacteria, fungi or protoctists that cause disease." },
            { q: "Which cell produces antibodies?", o: ["Phagocyte", "Red blood cell", "Lymphocyte", "Platelet"], a: 2, e: "Lymphocytes produce specific antibodies to neutralize pathogens." },
            { q: "What is the process by which phagocytes engulf pathogens?", o: ["Clotting", "Phagocytosis", "Vaccination", "Diffusion"], a: 1, e: "Phagocytosis is the process of engulfing and digesting pathogens." },
            { q: "Which of these is a mechanical barrier to infection?", o: ["Stomach acid", "Skin", "White blood cells", "Antibodies"], a: 1, e: "Skin physically blocks pathogens from entering the body." },
            { q: "How does vaccination work?", o: ["Injecting live active pathogens", "Injecting antibodies directly", "Injecting dead/weakened pathogens", "Injecting antibiotics"], a: 2, e: "Dead pathogens trigger the immune response to create memory cells without causing illness." },
            { q: "What type of immunity is breastfeeding?", o: ["Active immunity", "Passive immunity", "Autoimmunity", "Mechanical immunity"], a: 1, e: "The baby receives antibodies from the mother, giving short-term passive immunity." },
            { q: "Which disease is caused by a lack of insulin due to autoimmunity?", o: ["Type 1 Diabetes", "Cholera", "Scurvy", "AIDS"], a: 0, e: "In Type 1 Diabetes, the immune system attacks insulin-producing cells in the pancreas." },
            { q: "What do antigens do?", o: ["Kill bacteria", "Identify a cell as 'self' or 'non-self'", "Digest food", "Clot blood"], a: 1, e: "Antigens are markers on cell surfaces that lymphocytes recognize." },
            { q: "Which is an example of indirect transmission?", o: ["Blood transfusion", "Sexual intercourse", "Breathing contaminated air", "Direct touching"], a: 2, e: "Airborne transmission via droplets is indirect contact." },
            { q: "Why is passive immunity temporary?", o: ["Memory cells are not produced", "Antibodies reproduce", "Pathogens are too strong", "It is fake"], a: 0, e: "Without memory cells, the body cannot produce its own antibodies once the donated ones break down." }
        ];
        
        // Filling remaining questions
        const topics = ["Pathogens", "Barriers", "WBCs", "Vaccination"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 4];
            questions.push({
                q: `Question ${i} (${t}): Select the correct statement regarding ${t}.`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(190, 18, 60);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Ch10_Immunity_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
</html>