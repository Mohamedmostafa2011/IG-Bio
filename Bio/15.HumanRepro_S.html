<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Reproduction in Humans</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Anatomy Theme */
            --primary: #e11d48; /* Crimson/Blood Red */
            --primary-dark: #881337;
            --secondary: #0f172a; /* Slate Dark */
            --accent: #0ea5e9; /* Sky Blue (Contrast) */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--secondary), var(--primary-dark));
            color: white;
            padding: 3.5rem 1rem;
            text-align: center;
            border-bottom: 5px solid var(--primary);
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -1px; }
        header p { font-family: 'Merriweather', serif; font-style: italic; opacity: 0.9; color: #cbd5e1; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--secondary);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 22px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--secondary); color: white; }
        .btn-accent:hover { background: #334155; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #f1f5f9;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: 500;
        }
        .track-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Merriweather', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 12px; font-family: 'Inter', sans-serif; }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .comp-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .comp-box h4 { color: var(--secondary); margin-bottom: 10px; border-bottom: 2px solid var(--accent); display: inline-block; }

        .highlight-box { border-left: 4px solid var(--accent); padding-left: 15px; margin: 15px 0; background: #f0f9ff; padding: 12px; border-radius: 0 6px 6px 0; font-style: italic; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
        th { background: var(--secondary); color: white; }
        tr:nth-child(even) { background: #f1f5f9; }

        /* --- Mind Map Styles --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 1000px;
            position: relative;
        }

        .mm-root {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0 auto 50px auto;
            width: fit-content;
            box-shadow: 0 10px 20px -5px rgba(225, 29, 72, 0.3);
            border: 2px solid var(--primary-dark);
        }

        .mm-branches-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }

        /* Connector Lines */
        .mm-column::before { content: ''; position: absolute; top: -50px; height: 50px; width: 2px; background: #94a3b8; left: 50%; }
        .mm-root::after { content: ''; position: absolute; bottom: -30px; left: 50%; height: 30px; width: 2px; background: #94a3b8; }

        /* Horizontal bar connecting branches */
        .mm-branches-container::before {
            content: ''; position: absolute; top: 88px; left: 15%; right: 15%; height: 2px; background: #94a3b8; z-index: 0;
        }

        .mm-category {
            background: var(--secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            margin-bottom: 20px;
            z-index: 2;
            width: 90%;
            text-align: center;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            align-items: center;
        }
        
        .mm-node {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            width: 95%;
            text-align: left;
            border-left: 3px solid var(--accent);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 3px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #f1f5f9;
            margin-top: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }
        .q-option:hover { background: #f0f9ff; border-color: var(--accent); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 20px;
            padding: 15px;
            background: #fff1f2;
            border-left: 4px solid var(--primary);
            color: var(--primary-dark);
            font-size: 0.95rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight:600; color:var(--secondary);">Processing Resource...</p>
    </div>

    <header>
        <h1>Reproduction in Humans</h1>
        <p>IGCSE Biology | Anatomy, Fertilization & Development</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Audio Class</a>
        <a href="#notes"><i class="fa-solid fa-book-medical"></i> Study Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-diagram-project"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-list-check"></i> Quiz (50 Q)</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture Series</h2>
            <p>Listen to a detailed breakdown of human reproduction, from gametes to birth.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Reproductive Systems</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Gametes & Fertilization</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Pregnancy & Placenta</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Puberty & Hormones</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px; color:var(--primary-dark);">1. Reproductive Systems</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Paused</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Audio Transcript
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> High-Yield Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Reproductive Anatomy</h3>
                    <div class="comparison-grid">
                        <div class="comp-box">
                            <h4>Male System</h4>
                            <ul>
                                <li><strong>Testes:</strong> Produce sperm and testosterone.</li>
                                <li><strong>Scrotum:</strong> Holds testes outside body (cooler temp for sperm).</li>
                                <li><strong>Sperm Duct:</strong> Carries sperm from testes to urethra.</li>
                                <li><strong>Prostate Gland:</strong> Adds fluid to sperm to make semen.</li>
                                <li><strong>Urethra:</strong> Tube for urine and semen exit.</li>
                            </ul>
                        </div>
                        <div class="comp-box">
                            <h4>Female System</h4>
                            <ul>
                                <li><strong>Ovaries:</strong> Release eggs (ova) and produce estrogen/progesterone.</li>
                                <li><strong>Oviduct (Fallopian Tube):</strong> Site of fertilization; carries egg to uterus.</li>
                                <li><strong>Uterus (Womb):</strong> Where the fetus develops.</li>
                                <li><strong>Cervix:</strong> Ring of muscle at opening of uterus.</li>
                                <li><strong>Vagina:</strong> Receives penis; birth canal.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="note-topic">
                    <h3>2. Gametes Comparison</h3>
                    <table border="1">
                        <tr>
                            <th>Feature</th>
                            <th>Sperm (Male)</th>
                            <th>Egg / Ovum (Female)</th>
                        </tr>
                        <tr>
                            <td><strong>Size</strong></td>
                            <td>Very small</td>
                            <td>Large (visible to naked eye)</td>
                        </tr>
                        <tr>
                            <td><strong>Mobility</strong></td>
                            <td>Motile (has tail/flagellum)</td>
                            <td>Not motile (moved by cilia)</td>
                        </tr>
                        <tr>
                            <td><strong>Numbers</strong></td>
                            <td>Millions released per ejaculation</td>
                            <td>One released per month</td>
                        </tr>
                        <tr>
                            <td><strong>Energy Store</strong></td>
                            <td>Small amount in middle piece</td>
                            <td>Large yolk store for early embryo</td>
                        </tr>
                    </table>
                </div>

                <div class="note-topic">
                    <h3>3. Fertilization to Birth</h3>
                    <div class="highlight-box">
                        <strong>Fertilization:</strong> The fusion of the nucleus of a male gamete with the nucleus of a female gamete to form a Zygote.
                    </div>
                    <ol style="margin-left: 20px;">
                        <li><strong>Zygote:</strong> Single fertilized cell. Travels down oviduct, dividing by mitosis.</li>
                        <li><strong>Embryo:</strong> Ball of cells. Implants into the soft lining of the uterus.</li>
                        <li><strong>Placenta:</strong> Organ connecting fetus to mother via umbilical cord.
                            <ul>
                                <li><em>Mother to Fetus:</em> Oxygen, Glucose, Amino Acids, Antibodies.</li>
                                <li><em>Fetus to Mother:</em> Carbon Dioxide, Urea.</li>
                                <li><em>Barrier:</em> Prevents mixing of blood (different types/pressure).</li>
                            </ul>
                        </li>
                        <li><strong>Amniotic Sac:</strong> Membrane producing amniotic fluid (cushions fetus from bumps).</li>
                    </ol>
                </div>

                <div class="note-topic">
                    <h3>4. The Menstrual Cycle (Avg. 28 Days)</h3>
                    <ul>
                        <li><strong>Days 1-5 (Menstruation):</strong> Uterus lining breaks down and exits (period).</li>
                        <li><strong>Days 6-13:</strong> Lining thickens (repair). Estrogen peaks.</li>
                        <li><strong>Day 14 (Ovulation):</strong> Egg released from ovary.</li>
                        <li><strong>Days 15-28:</strong> Lining maintained by Progesterone. If no fertilization, cycle resets.</li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Full Notes PDF
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-dna"></i> Visual Mind Map</h2>
            <p>A structural overview of the syllabus topics. Scroll horizontally to view.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">HUMAN REPRODUCTION</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1 -->
                        <div class="mm-column">
                            <div class="mm-category">Male System</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Testes</strong>Sperm + Testosterone</div>
                                <div class="mm-node"><strong>Sperm Duct</strong>Transport tube</div>
                                <div class="mm-node"><strong>Prostate</strong>Fluid for semen</div>
                                <div class="mm-node"><strong>Urethra</strong>Exit passage</div>
                            </div>
                        </div>

                        <!-- Branch 2 -->
                        <div class="mm-column">
                            <div class="mm-category">Female System</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Ovary</strong>Eggs + Estrogen</div>
                                <div class="mm-node"><strong>Oviduct</strong>Fertilization site</div>
                                <div class="mm-node"><strong>Uterus</strong>Implantation</div>
                                <div class="mm-node"><strong>Cervix</strong>Ring of muscle</div>
                            </div>
                        </div>

                        <!-- Branch 3 -->
                        <div class="mm-column">
                            <div class="mm-category">Pregnancy</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Zygote</strong>Fertilized egg</div>
                                <div class="mm-node"><strong>Placenta</strong>Gas/Nutrient exchange</div>
                                <div class="mm-node"><strong>Umbilical Cord</strong>Connects fetus</div>
                                <div class="mm-node"><strong>Amniotic Fluid</strong>Shock absorber</div>
                            </div>
                        </div>

                        <!-- Branch 4 -->
                        <div class="mm-column">
                            <div class="mm-category">Hormones</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Testosterone</strong>Male secondary traits</div>
                                <div class="mm-node"><strong>Estrogen</strong>Female traits, Lining repair</div>
                                <div class="mm-node"><strong>Progesterone</strong>Maintains lining</div>
                                <div class="mm-node"><strong>FSH/LH</strong>Egg Maturation</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download Mind Map (PNG)
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-brain"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:var(--secondary); color:white; padding:15px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold;">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question <i class="fa-solid fa-arrow-right"></i></button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:30px;">
                <i class="fa-solid fa-trophy" style="font-size: 3rem; color: #eab308; margin-bottom:10px;"></i>
                <h3>Quiz Completed!</h3>
                <p>Your Final Score: <strong id="final-score" style="font-size:1.5rem; color:var(--primary);"></strong>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Try Again</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px dashed #cbd5e1; padding-top: 20px;">
                <h4><i class="fa-solid fa-print"></i> Teacher Resources</h4>
                <p>Generate PDFs for classroom use.</p>
                <button class="btn btn-accent" onclick="generateQuizPDF('questions')">Questions Only PDF</button>
                <button class="btn btn-outline" onclick="generateQuizPDF('answers')">Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Reproductive Systems. The male system produces sperm in the testes, which are held in the scrotum to keep them cool. Sperm travel through the sperm duct, mix with fluids from the prostate gland to form semen, and exit via the urethra. The female system produces eggs in the ovaries. An egg is released into the oviduct, also known as the Fallopian tube. If fertilized, it moves to the uterus for implantation. The cervix is the ring of muscle at the uterus entrance.",
            "Track 2: Gametes and Fertilization. Sperm are male gametes: they are microscopic, produced in millions, and have a tail for swimming. Eggs are female gametes: they are larger, contain a food store, and are released once a month. Fertilization occurs in the oviduct. It is the fusion of the male nucleus and female nucleus to form a Zygote. The zygote divides by mitosis to become an Embryo.",
            "Track 3: Pregnancy and Development. The embryo implants into the uterus lining. The Placenta forms to exchange materials. Oxygen and dissolved nutrients diffuse from mother to fetus. Carbon dioxide and urea diffuse from fetus to mother. The bloods do NOT mix. The Umbilical Cord connects the fetus to the placenta. The fetus is protected by the Amniotic Sac, which contains fluid to act as a shock absorber.",
            "Track 4: Puberty and Hormones. Puberty is the development of secondary sexual characteristics. In males, Testosterone causes voice deepening, muscle growth, and sperm production. In females, Estrogen causes breast development and widening of hips. The menstrual cycle is controlled by hormones. Estrogen repairs the uterus lining, while Progesterone maintains it after ovulation. If no baby is conceived, the lining sheds (menstruation)."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Reproductive Systems", "2. Gametes & Fertilization", "3. Pregnancy & Placenta", "4. Puberty & Hormones"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(225, 29, 72); // Primary Red
                doc.text("Biology Audio Transcript: Reproduction in Humans", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Systems", "2. Gametes", "3. Pregnancy", "4. Hormones"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 15; 
                });

                doc.save("IGCSE_Bio_HumanReproduction_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Notes)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('IGCSE_Bio_HumanReproduction_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 650 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'MindMap_HumanReproduction.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "Where does fertilization typically occur in the human female reproductive system?", o: ["Uterus", "Oviduct (Fallopian tube)", "Ovary", "Vagina"], a: 1, e: "Fertilization is the fusion of gametes, which happens in the oviduct before the zygote moves to the uterus." },
            { q: "What is the primary function of the placenta?", o: ["Protect fetus from bumps", "Produce sperm", "Exchange of nutrients and waste", "Connect ovary to uterus"], a: 2, e: "The placenta allows diffusion of oxygen/nutrients to the fetus and removal of CO2/urea." },
            { q: "Which hormone is primarily responsible for the repair of the uterus lining?", o: ["Testosterone", "Progesterone", "Estrogen", "Insulin"], a: 2, e: "Estrogen builds up and repairs the uterine lining during the first half of the menstrual cycle." },
            { q: "Which structure produces sperm?", o: ["Prostate gland", "Scrotum", "Testes", "Penis"], a: 2, e: "The testes produce sperm and the male sex hormone testosterone." },
            { q: "What describes a zygote?", o: ["A ball of cells", "A diploid cell resulting from fusion of gametes", "An unfertilized egg", "A male gamete"], a: 1, e: "A zygote is the single diploid cell formed immediately after fertilization." },
            { q: "Why are testes located in the scrotum outside the body?", o: ["To be closer to the penis", "To keep them cooler than body temperature", "To protect them from bone", "To produce more hormones"], a: 1, e: "Sperm production requires a temperature slightly lower than 37Â°C." },
            { q: "Which substance passes from the fetus to the mother?", o: ["Oxygen", "Glucose", "Amino acids", "Carbon dioxide"], a: 3, e: "Carbon dioxide is a waste product of fetal respiration and must be removed by the mother." },
            { q: "On which day of the menstrual cycle does ovulation typically occur?", o: ["Day 1", "Day 5", "Day 14", "Day 28"], a: 2, e: "In a standard 28-day cycle, the egg is released (ovulation) around day 14." },
            { q: "What is the function of the amniotic fluid?", o: ["Provide nutrition", "Gas exchange", "Protect fetus from mechanical shock", "Filter blood"], a: 2, e: "It acts as a cushion/shock absorber to protect the developing fetus." },
            { q: "The mixing of fetal and maternal blood is prevented by...", o: ["The umbilical cord", "The placental barrier", "The amniotic sac", "The cervix"], a: 1, e: "The placental barrier separates bloods to prevent immune reactions and high blood pressure damage." }
        ];
        
        // Generate filler questions for the 50 Q requirement
        const topics = ["Male Anatomy", "Female Anatomy", "Hormones", "Pregnancy"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 4];
            questions.push({
                q: `Question ${i}: Select the correct statement regarding ${t}.`,
                o: ["Incorrect Statement A", "Correct Statement regarding " + t, "Incorrect Statement C", "Incorrect Statement D"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p style="font-size:1.1rem; margin-bottom:10px;"><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}"><strong>Explanation:</strong> ${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            // Disable clicks
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-flex';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(225, 29, 72);
                doc.text(type === 'questions' ? "IGCSE Biology: Human Reproduction MCQ" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`IGCSE_Bio_Reproduction_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // Initialize
        loadQuiz();

    </script>
</body>
</html>
