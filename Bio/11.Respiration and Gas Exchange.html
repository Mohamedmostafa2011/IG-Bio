<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Gas Exchange & Respiration</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Gradient Theme: Air (Blue) to Energy (Orange) */
            --primary-blue: #0ea5e9; /* Sky-500 */
            --primary-orange: #f59e0b; /* Amber-500 */
            --dark-blue: #0c4a6e;
            --dark-orange: #78350f;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--dark-blue), var(--primary-orange));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary-blue); border-color: var(--primary-orange); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--dark-blue);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 5px solid var(--primary-orange);
            padding-left: 15px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--dark-blue); color: white; }
        .btn-primary:hover { background: var(--primary-blue); }
        .btn-accent { background: var(--primary-orange); color: white; }
        .btn-accent:hover { background: var(--dark-orange); }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #f0f9ff;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary-blue);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--dark-blue); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #e0f2fe; color: var(--dark-blue); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--primary-orange); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #fff7ed; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
        th { background: #f0f9ff; color: var(--dark-blue); }
        
        .equation-box { 
            background: #fffbeb; 
            border: 2px dashed var(--primary-orange); 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
            margin: 15px 0; 
            border-radius: 8px; 
            color: var(--dark-orange);
        }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: linear-gradient(to right, var(--dark-blue), var(--primary-orange));
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }
        
        /* Variation for Respiration branches */
        .mm-column.orange .mm-category { background: var(--primary-orange); }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--dark-blue); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #e0f2fe; border-color: var(--primary-blue); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--primary-orange);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary-blue);">Generating File...</p>
    </div>

    <header>
        <h1>Gas Exchange & Respiration</h1>
        <p>IGCSE Biology 0610 | Complete Unified Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-flask"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>From breathing air in, to releasing energy in cells. Select a track.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Gas Exchange System</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Ventilation Mechanics</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Aerobic Respiration</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Anaerobic & Oxygen Debt</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Gas Exchange System</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <!-- PART 1: GAS EXCHANGE -->
                <div class="note-topic">
                    <h3>1. Structure of Gas Exchange System</h3>
                    <ul>
                        <li><strong>Trachea & Bronchi:</strong> Airways lined with C-shaped cartilage to prevent collapse. Contains <span class="key-term">Goblet Cells</span> (secrete mucus to trap dust) and <span class="key-term">Ciliated Cells</span> (sweep mucus away).</li>
                        <li><strong>Alveoli:</strong> The site of gas exchange by diffusion. Adaptations:
                            <ul>
                                <li>Large surface area.</li>
                                <li>Thin walls (one cell thick) for short diffusion path.</li>
                                <li>Dense capillary network for steep concentration gradient.</li>
                                <li>Moist surface for gases to dissolve.</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>2. Ventilation (Breathing)</h3>
                    <p>Air moves from High Pressure to Low Pressure.</p>
                    <table border="1">
                        <tr><th>Action</th><th>Inspiration (In)</th><th>Expiration (Out)</th></tr>
                        <tr><td><strong>Ext. Intercostals</strong></td><td>Contract</td><td>Relax</td></tr>
                        <tr><td><strong>Diaphragm</strong></td><td>Contracts (Flattens)</td><td>Relaxes (Domes)</td></tr>
                        <tr><td><strong>Volume</strong></td><td>Increases</td><td>Decreases</td></tr>
                        <tr><td><strong>Pressure</strong></td><td>Decreases</td><td>Increases</td></tr>
                    </table>
                </div>

                <!-- PART 2: RESPIRATION -->
                <div class="note-topic">
                    <h3>3. Respiration vs. Breathing</h3>
                    <div class="definition">
                        <strong>Respiration:</strong> The chemical reactions in cells that break down nutrient molecules (glucose) to release energy for metabolism.
                    </div>
                    <p><strong>Uses of Energy (ATP):</strong> Muscle contraction, Protein synthesis, Cell division, Active transport, Growth, Body temperature.</p>
                </div>

                <div class="note-topic">
                    <h3>4. Aerobic vs. Anaerobic Respiration</h3>
                    
                    <h4>A. Aerobic Respiration</h4>
                    <p>Uses oxygen. Releases lots of energy.</p>
                    <div class="equation-box">
                        Glucose + Oxygen &rarr; Carbon Dioxide + Water<br>
                        C<sub>6</sub>H<sub>12</sub>O<sub>6</sub> + 6O<sub>2</sub> &rarr; 6CO<sub>2</sub> + 6H<sub>2</sub>O
                    </div>

                    <h4>B. Anaerobic Respiration</h4>
                    <p>No oxygen. Releases small amount of energy.</p>
                    <p><strong>In Yeast (Fermentation):</strong> Glucose &rarr; Alcohol + CO<sub>2</sub></p>
                    <p><strong>In Human Muscles:</strong> Glucose &rarr; Lactic Acid</p>
                </div>

                <div class="note-topic">
                    <h3>5. Oxygen Debt</h3>
                    <p>During vigorous exercise, anaerobic respiration produces lactic acid (toxic).</p>
                    <ul>
                        <li>Lactic acid builds up in muscles causing fatigue.</li>
                        <li>It must be broken down in the <strong>Liver</strong>.</li>
                        <li>This requires Oxygen.</li>
                        <li><strong>Oxygen Debt:</strong> The extra oxygen needed after exercise to break down lactic acid. This is why you keep breathing heavily after running.</li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view the connection between lungs and cells.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">GAS EXCHANGE & RESPIRATION</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: The Lungs (Blue) -->
                        <div class="mm-column">
                            <div class="mm-category">Structure</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Trachea/Bronchi</strong>Cartilage/Cilia/Mucus</div>
                                <div class="mm-node"><strong>Alveoli</strong>Surface Area/Thin Wall</div>
                                <div class="mm-node"><strong>Capillaries</strong>Transport Gases</div>
                            </div>
                        </div>

                        <!-- Branch 2: Ventilation (Blue) -->
                        <div class="mm-column">
                            <div class="mm-category">Ventilation</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Inhale</strong>Diaphragm Flattens</div>
                                <div class="mm-node"><strong>Pressure</strong>Drops -> Air In</div>
                                <div class="mm-node"><strong>Exhale</strong>Diaphragm Domes</div>
                                <div class="mm-node"><strong>Pressure</strong>Rises -> Air Out</div>
                            </div>
                        </div>

                        <!-- Branch 3: Aerobic (Orange) -->
                        <div class="mm-column orange">
                            <div class="mm-category">Aerobic Resp</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Equation</strong>Glucose+O2 -> CO2+H2O</div>
                                <div class="mm-node"><strong>Energy</strong>High Yield</div>
                                <div class="mm-node"><strong>Location</strong>Mitochondria</div>
                                <div class="mm-node"><strong>Uses</strong>Contraction/Growth</div>
                            </div>
                        </div>

                        <!-- Branch 4: Anaerobic (Orange) -->
                        <div class="mm-column orange">
                            <div class="mm-category">Anaerobic Resp</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Yeast</strong>Ethanol + CO2</div>
                                <div class="mm-node"><strong>Muscle</strong>Lactic Acid</div>
                                <div class="mm-node"><strong>O2 Debt</strong>Lactic acid breakdown</div>
                                <div class="mm-node"><strong>Energy</strong>Low Yield</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#f0f9ff; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--dark-blue);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: The Gas Exchange System. Air enters via the nose or mouth, passes down the trachea, into the bronchi, and finally into the alveoli. The trachea is kept open by C-shaped cartilage. It is lined with goblet cells that make mucus to trap dust and pathogens, and ciliated cells that sweep the mucus away. Gas exchange occurs in the alveoli, which have a large surface area, thin walls, and a good blood supply to facilitate diffusion of Oxygen into the blood and CO2 out.",
            "Track 2: Ventilation Mechanics. Breathing is mechanical. To inhale, external intercostal muscles contract, pulling ribs up. The diaphragm contracts and flattens. This increases volume in the thorax, lowering pressure, so air rushes in. To exhale, muscles relax, ribs fall, diaphragm domes up. Volume decreases, pressure rises, and air is pushed out.",
            "Track 3: Aerobic Respiration. This is the chemical release of energy in cells using oxygen. It happens in mitochondria. The equation is Glucose + Oxygen yields Carbon Dioxide + Water. It releases a large amount of energy for muscle contraction, active transport, and keeping warm. CO2 is a waste product excreted by the lungs.",
            "Track 4: Anaerobic Respiration & Oxygen Debt. If oxygen is scarce (like during sprinting), cells respire anaerobically. In humans, Glucose breaks down to Lactic Acid. This releases only a little energy and the lactic acid is toxic, causing cramps. After exercise, you breathe heavily to get extra oxygen (Oxygen Debt) to break down the lactic acid in the liver."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Gas Exchange System", "2. Ventilation Mechanics", "3. Aerobic Respiration", "4. Anaerobic & O2 Debt"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(12, 74, 110); // Dark Blue
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Gas Exchange & Respiration", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Gas Exchange System", "2. Ventilation Mechanics", "3. Aerobic Respiration", "4. Anaerobic & O2 Debt"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Bio_GasExchange_Respiration_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Bio_GasExchange_Respiration_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'GasExchange_Respiration_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "What is the equation for aerobic respiration?", o: ["Glucose + O2 -> CO2 + H2O", "Glucose -> Lactic Acid", "Glucose -> Ethanol + CO2", "CO2 + H2O -> Glucose + O2"], a: 0, e: "Aerobic respiration uses oxygen to break down glucose completely." },
            { q: "Where does gas exchange occur in humans?", o: ["Trachea", "Bronchi", "Alveoli", "Diaphragm"], a: 2, e: "Alveoli are the air sacs adapted for diffusion of gases." },
            { q: "What happens to the diaphragm during inhalation?", o: ["Relaxes and domes", "Contracts and flattens", "Relaxes and flattens", "Contracts and domes"], a: 1, e: "Contraction flattens the diaphragm to increase thoracic volume." },
            { q: "Which product causes muscle fatigue during anaerobic respiration?", o: ["Ethanol", "Carbon Dioxide", "Water", "Lactic Acid"], a: 3, e: "Lactic acid accumulates in muscles causing pain and fatigue." },
            { q: "What is the function of ciliated cells?", o: ["Make mucus", "Move mucus", "Absorb oxygen", "Filter blood"], a: 1, e: "Cilia beat rhythmically to move mucus with trapped dust away from the lungs." },
            { q: "Oxygen debt is the oxygen needed to...", o: ["Breathe deeper", "Break down lactic acid", "Cool the body", "Digest food"], a: 1, e: "Oxygen debt repays the body by breaking down lactic acid in the liver." },
            { q: "What percentage of exhaled air is Oxygen?", o: ["21%", "16%", "4%", "0.04%"], a: 1, e: "We use about 5% of the oxygen, so it drops from 21% to 16%." },
            { q: "Which feature is NOT an adaptation of alveoli?", o: ["Large surface area", "Thick walls", "Good blood supply", "Moist surface"], a: 1, e: "Alveoli have THIN walls (one cell thick) for fast diffusion." },
            { q: "Anaerobic respiration in yeast produces...", o: ["Lactic Acid", "Ethanol and CO2", "Water only", "Glucose"], a: 1, e: "Yeast fermentation produces alcohol and carbon dioxide." },
            { q: "The breakdown of lactic acid occurs in the...", o: ["Heart", "Kidney", "Liver", "Lungs"], a: 2, e: "The liver converts lactic acid back to glucose or breaks it down." }
        ];
        
        // Filling remaining questions
        const topics = ["Ventilation", "Aerobic", "Anaerobic", "Alveoli"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 4];
            questions.push({
                q: `Question ${i} (${t}): Select the correct statement regarding ${t}.`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(12, 74, 110);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Bio_GasExchange_Respiration_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
</html>