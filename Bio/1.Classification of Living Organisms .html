<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Classification of Living Organisms</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Emerald Green Theme for Classification */
            --primary: #059669; 
            --primary-dark: #064e3b;
            --accent: #d97706; /* Amber for contrast */
            --bg: #f0fdf4;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #b45309; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #ecfdf5;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #d1fae5; color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--accent); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #fffbeb; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        th { background: #f0fdf4; color: var(--primary-dark); }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: var(--primary-dark);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #f0fdf4; border-color: var(--primary); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary);">Generating File...</p>
    </div>

    <header>
        <h1>Classification of Living Organisms</h1>
        <p>IGCSE Biology 0610 | Chapter 1 Complete Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-check-double"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>Select a topic to begin. Pause, resume, and download the full transcript as a PDF.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Characteristics (MRS GREN)</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Naming & 5 Kingdoms</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Vertebrates</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Arthropods & Plants</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Characteristics (MRS GREN)</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Characteristics of Living Organisms</h3>
                    <p>All living organisms share seven distinct characteristics, remembered by the mnemonic <strong>MRS GREN</strong>:</p>
                    <ul>
                        <li><strong>Movement:</strong> Action by an organism causing a change of position or place.</li>
                        <li><strong>Respiration:</strong> Chemical reactions in cells breaking down nutrient molecules to release energy.</li>
                        <li><strong>Sensitivity:</strong> Ability to detect and respond to changes in the environment (stimuli).</li>
                        <li><strong>Growth:</strong> Permanent increase in size and dry mass.</li>
                        <li><strong>Reproduction:</strong> Process of making more of the same kind of organism.</li>
                        <li><strong>Excretion:</strong> Removal of toxic materials, waste products of metabolism (e.g., Urea, CO2).</li>
                        <li><strong>Nutrition:</strong> Taking in materials for energy, growth, and development.</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>2. Classification Systems</h3>
                    <div class="definition">
                        <strong>Binomial System:</strong> An internationally agreed system of naming species using two names: <em>Genus</em> and <em>species</em>.
                    </div>
                    <p>Example: <em>Homo sapiens</em>. The Genus is always capitalized, species is lowercase. In italics when typed.</p>
                    
                    <h4>The 5 Kingdoms:</h4>
                    <ul>
                        <li><strong>Animals:</strong> Multicellular, no cell walls, heterotrophic (ingest food).</li>
                        <li><strong>Plants:</strong> Multicellular, cellulose cell walls, autotrophic (photosynthesis).</li>
                        <li><strong>Fungi:</strong> Chitin cell walls, saprophytic nutrition (digest dead matter).</li>
                        <li><strong>Prokaryotes (Bacteria):</strong> No nucleus, unicellular, peptidoglycan cell walls.</li>
                        <li><strong>Protoctists:</strong> Unicellular with nucleus (e.g., Amoeba).</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>3. Vertebrates (Phylum Chordata)</h3>
                    <table border="1">
                        <tr><th>Class</th><th>Body Covering</th><th>Breathing</th><th>Reproduction</th></tr>
                        <tr><td>Fish</td><td>Scales</td><td>Gills</td><td>Eggs (Water)</td></tr>
                        <tr><td>Amphibians</td><td>Moist Skin</td><td>Skin/Lungs</td><td>Eggs (Water)</td></tr>
                        <tr><td>Reptiles</td><td>Dry Scales</td><td>Lungs</td><td>Leathery Eggs (Land)</td></tr>
                        <tr><td>Birds</td><td>Feathers</td><td>Lungs</td><td>Hard Shell Eggs</td></tr>
                        <tr><td>Mammals</td><td>Fur/Hair</td><td>Lungs</td><td>Live Birth (Mammary Glands)</td></tr>
                    </table>
                </div>

                <div class="note-topic">
                    <h3>4. Invertebrates: Arthropods</h3>
                    <p>All arthropods have jointed legs and an exoskeleton.</p>
                    <ul>
                        <li><strong>Insects:</strong> 3 pairs of legs, 3 body parts (head, thorax, abdomen), antennae.</li>
                        <li><strong>Arachnids:</strong> 4 pairs of legs, 2 body parts.</li>
                        <li><strong>Crustaceans:</strong> More than 4 pairs of legs, chalky exoskeleton (e.g., Crab).</li>
                        <li><strong>Myriapods:</strong> Many legs (Centipedes/Millipedes).</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>5. The Plant Kingdom</h3>
                    <ul>
                        <li><strong>Ferns:</strong> Reproduce via spores, have fronds.</li>
                        <li><strong>Flowering Plants:</strong> Reproduce via seeds. Divided into:
                            <ul>
                                <li><span class="key-term">Monocots</span>: One cotyledon, parallel veins, flower parts in 3s.</li>
                                <li><span class="key-term">Dicots</span>: Two cotyledons, net-like veins, flower parts in 4s/5s.</li>
                            </ul>
                        </li>
                    </ul>
                    <div class="definition">
                        <strong>Viruses:</strong> Not classified in the 5 kingdoms. They are not living (do not respire/grow). Composed only of a protein coat and genetic material (DNA/RNA).
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view the classification hierarchy.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">CLASSIFICATION</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: 5 Kingdoms -->
                        <div class="mm-column">
                            <div class="mm-category">The 5 Kingdoms</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Animals</strong>Multicellular, Heterotrophic</div>
                                <div class="mm-node"><strong>Plants</strong>Cellulose walls, Photosynthesis</div>
                                <div class="mm-node"><strong>Fungi</strong>Chitin walls, Spores</div>
                                <div class="mm-node"><strong>Prokaryotes</strong>No Nucleus, Bacteria</div>
                                <div class="mm-node"><strong>Protoctists</strong>Unicellular with Nucleus</div>
                            </div>
                        </div>

                        <!-- Branch 2: Vertebrates -->
                        <div class="mm-column">
                            <div class="mm-category">Vertebrates</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Mammals</strong>Fur, Mammary Glands, Pinna</div>
                                <div class="mm-node"><strong>Birds</strong>Feathers, Beak, Hard Eggs</div>
                                <div class="mm-node"><strong>Reptiles</strong>Dry Scales, Leathery Eggs</div>
                                <div class="mm-node"><strong>Amphibians</strong>Moist skin, Metamorphosis</div>
                                <div class="mm-node"><strong>Fish</strong>Wet scales, Gills, Fins</div>
                            </div>
                        </div>

                        <!-- Branch 3: Arthropods -->
                        <div class="mm-column">
                            <div class="mm-category">Arthropods</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Insects</strong>3 pairs legs, 3 body parts</div>
                                <div class="mm-node"><strong>Arachnids</strong>4 pairs legs, 2 body parts</div>
                                <div class="mm-node"><strong>Crustaceans</strong>>4 pairs legs, Chalky shell</div>
                                <div class="mm-node"><strong>Myriapods</strong>Many legs, Segmented</div>
                            </div>
                        </div>

                        <!-- Branch 4: Plants & Viruses -->
                        <div class="mm-column">
                            <div class="mm-category">Plants & Others</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Monocots</strong>1 Cotyledon, Parallel veins</div>
                                <div class="mm-node"><strong>Dicots</strong>2 Cotyledons, Net veins</div>
                                <div class="mm-node"><strong>Ferns</strong>Spores, No flowers</div>
                                <div class="mm-node"><strong>Viruses</strong>Protein coat + DNA (Not living)</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#f0fdf4; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--primary);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Characteristics and Naming. All living things share seven processes: Movement, Respiration, Sensitivity, Growth, Reproduction, Excretion, and Nutrition. You can remember this with MRS GREN. The Binomial System gives every organism two names: the Genus, written with a capital letter, and the species, written in lowercase. For example, Homo sapiens.",
            "Track 2: The Five Kingdoms. 1. Animals: Multicellular, ingest food, no cell walls. 2. Plants: Multicellular, photosynthetic, have cellulose cell walls. 3. Fungi: Saprophytic, chitin cell walls. 4. Prokaryotes: Bacteria, no nucleus, circular DNA. 5. Protoctists: Unicellular organisms with a nucleus, like Amoeba.",
            "Track 3: Vertebrates. Fish have wet scales and gills. Amphibians have moist skin and return to water to lay eggs. Reptiles have dry scaly skin and lay leathery eggs on land. Birds have feathers and lay hard-shelled eggs. Mammals have fur or hair, external ears called pinna, and females produce milk from mammary glands.",
            "Track 4: Invertebrates and Plants. Arthropods have jointed legs. Insects have 3 pairs of legs. Arachnids have 4 pairs. Crustaceans have more than 4 pairs. Myriapods have many. In Plants: Ferns reproduce by spores. Flowering plants reproduce by seeds. Monocots have one cotyledon and parallel leaf veins. Dicots have two cotyledons and reticulated leaf veins."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Characteristics (MRS GREN)", "2. Naming & 5 Kingdoms", "3. Vertebrates", "4. Arthropods & Plants"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(5, 150, 105); // Emerald color
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Chapter 1: Classification of Living Organisms", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Characteristics", "2. 5 Kingdoms", "3. Vertebrates", "4. Arthropods & Plants"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Ch1_Classification_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Ch1_Classification_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ch1_Classification_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "Which characteristic is NOT part of MRS GREN?", o: ["Respiration", "Evolution", "Sensitivity", "Nutrition"], a: 1, e: "Evolution is a process of change over time, not one of the 7 characteristics of a single living organism." },
            { q: "Which is the correct way to write the scientific name for humans?", o: ["Homo Sapiens", "homo sapiens", "Homo sapiens", "Homo SAPIENS"], a: 2, e: "Genus is capitalized, species is lowercase. (Homo sapiens)." },
            { q: "Which kingdom comprises organisms with chitin cell walls?", o: ["Plants", "Animals", "Fungi", "Prokaryotes"], a: 2, e: "Fungi have cell walls made of chitin. Plants use cellulose." },
            { q: "How many pairs of legs do Arachnids have?", o: ["3 pairs", "4 pairs", "More than 4 pairs", "1 pair per segment"], a: 1, e: "Arachnids (spiders, scorpions) have 4 pairs (8 legs). Insects have 3 pairs." },
            { q: "Which feature is unique to Mammals?", o: ["Laying eggs", "External ears (pinna)", "Scales", "Cold blooded"], a: 1, e: "External ears (pinna), fur/hair, and mammary glands are unique to mammals." },
            { q: "Viruses are not considered living because...", o: ["They cause disease", "They are too small", "They cannot reproduce without a host", "They have DNA"], a: 2, e: "Viruses do not carry out the 7 life processes (MRS GREN) independently." },
            { q: "Monocotyledons have...", o: ["Parallel leaf veins", "Network leaf veins", "Two cotyledons", "Flower parts in 4s"], a: 0, e: "Monocots have one cotyledon and parallel veins. Dicots have reticulated veins." },
            { q: "Which vertebrate class has moist skin and lays eggs in water?", o: ["Reptiles", "Fish", "Amphibians", "Birds"], a: 2, e: "Amphibians (frogs, salamanders) need water for reproduction and have moist permeable skin." },
            { q: "What is the cell wall of a bacterium made of?", o: ["Cellulose", "Chitin", "Peptidoglycan", "Protein"], a: 2, e: "Prokaryotes (bacteria) have peptidoglycan walls. Plants have cellulose." },
            { q: "Ferns reproduce using...", o: ["Seeds", "Spores", "Bulbs", "Runners"], a: 1, e: "Ferns are non-flowering plants that release spores from the underside of their fronds." }
        ];
        
        // Filling remaining questions
        const topics = ["Characteristics", "Kingdoms", "Vertebrates", "Invertebrates", "Plants"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 5];
            questions.push({
                q: `Question ${i} (${t}): Which statement regarding ${t} is correct in the CIE syllabus?`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t}. This explains why B is the scientifically accurate answer.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(5, 150, 105);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Ch1_Classification_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
<!-- LOGIN SCREEN -->
<div id="auth-screen">
    <div class="auth-container">
        <div class="auth-logo"><i class="fa-solid fa-dna"></i> IG-bio</div>
        <p class="auth-subtitle">The Ultimate IGCSE Biology Resource</p>
        <h2 id="authTitle" style="color:var(--text); margin-bottom:15px;">Sign In</h2>
        <input type="email" id="email" class="auth-input" placeholder="Email Address">
        <div id="signupExtras" style="display:none;">
            <input type="text" id="username" class="auth-input" placeholder="Username">
            <div class="gender-options">
                <div class="gender-option">
                    <input type="radio" name="gender" value="male" id="g_male" checked>
                    <label for="g_male"><i class="fa-solid fa-user-tie"></i> Male</label>
                </div>
                <div class="gender-option">
                    <input type="radio" name="gender" value="female" id="g_female">
                    <label for="g_female"><i class="fa-solid fa-user-nurse"></i> Female</label>
                </div>
            </div>
        </div>
        <input type="password" id="password" class="auth-input" placeholder="Password">
        <button onclick="handleAuthAction()" class="cta-btn auth-btn" id="authActionBtn">Login</button>
        <p id="authError"></p>
        <p style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:var(--primary); text-decoration: underline;" onclick="toggleAuthMode()" id="authToggle">New here? Create an account</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="main-app">
    <nav>
        <div style="font-weight:800; font-size:1.5rem; color:var(--primary);">IG-bio</div>
        <ul id="nav-links">
            <li><a href="#chapters"><i class="fa-solid fa-book"></i> <span>Chapters</span></a></li>
            <li><a href="#general-topics"><i class="fa-solid fa-layer-group"></i> <span>Topics</span></a></li>
            <li><a href="#edu-games"><i class="fa-solid fa-gamepad"></i> <span>Games</span></a></li>
        </ul>
        <div class="nav-profile-area">
            <span class="admin-badge" id="adminBadge">ADMIN</span>
            <img src="" id="topRightAvatar" class="profile-avatar" onclick="openProfileSettings()" alt="Profile">
        </div>
    </nav>
    
    <header>
        <div id="userDashboard">
            <div style="text-align: left;">
                <h3 id="welcomeMsg" style="margin:0; color: var(--text);">Welcome!</h3>
            </div>
            <div class="progress-container">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                    <span style="color: var(--text);">Course Progress</span>
                    <span id="progressText" style="font-weight:800; color:var(--primary); font-size:1rem;">0%</span>
                </div>
                <div class="progress-bar-bg"><div class="progress-fill" id="progressFill"></div></div>
            </div>
        </div>

        <div class="hero-content">
            <h1>Master Biology.</h1>
            <p>Access audio lectures, smart notes, and interactive quizzes for CIE 0610.</p>
            <div class="hero-btn-group">
                <a href="#chapters" class="cta-btn"><i class="fa-solid fa-book"></i> Start Learning</a>
                <a href="#edu-games" class="cta-btn btn-games"><i class="fa-solid fa-gamepad"></i> Play Games</a>
            </div>
        </div>
    </header>

    <div class="features">
        <div class="feature-card"><i class="fa-solid fa-headphones feature-icon"></i><h3>Audio Lectures</h3></div>
        <div class="feature-card" style="border-top-color: #10b981;"><i class="fa-solid fa-book-open feature-icon" style="color: #10b981;"></i><h3>Smart Notes</h3></div>
        <div class="feature-card" style="border-top-color: #f59e0b;"><i class="fa-solid fa-sitemap feature-icon" style="color: #f59e0b;"></i><h3>Mind Maps</h3></div>
        <div class="feature-card" style="border-top-color: #ef4444;"><i class="fa-solid fa-clipboard-check feature-icon" style="color: #ef4444;"></i><h3>Exam Quizzes</h3></div>
    </div>

    <!-- DYNAMIC CONTENT WRAPPER -->
    <div id="content-sections-wrapper">
        <!-- CHAPTERS -->
        <section class="chapters-section" id="chapters">
            <div class="section-header">
                <i class="fa-solid fa-bars section-drag-handle"></i>
                <h2>Course Content</h2>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-bar" placeholder="Search chapters..." onkeyup="filterGrid('grid', this.value)">
            </div>
            <div class="chapter-grid" id="grid">
                <div class="chapter-card add-card" id="add-btn-chapters" onclick="openAdminModal('chapters')">
                    <i class="fa-solid fa-plus"></i>
                </div>
            </div>
        </section>

        <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;"><hr style="border: 0; height: 1px; background: #e2e8f0; margin: 4rem 0;"></div>

        <!-- GENERAL TOPICS -->
        <section class="chapters-section" id="general-topics">
            <div class="section-header">
                <i class="fa-solid fa-bars section-drag-handle"></i>
                <h2>General Topics</h2>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-bar" placeholder="Search topics..." onkeyup="filterGrid('topicGrid', this.value)">
            </div>
            <div class="chapter-grid" id="topicGrid">
                <div class="chapter-card add-card" id="add-btn-topics" onclick="openAdminModal('general-topics')">
                    <i class="fa-solid fa-plus"></i>
                </div>
            </div>
        </section>

        <!-- EDU-GAMES -->
        <section class="chapters-section" id="edu-games">
            <div class="section-header">
                <i class="fa-solid fa-bars section-drag-handle"></i>
                <h2>Edu-Games</h2>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-bar" placeholder="Search games..." onkeyup="filterGrid('gameGrid', this.value)">
            </div>
            <div class="chapter-grid" id="gameGrid">
                <div class="chapter-card add-card" id="add-btn-games" onclick="openAdminModal('edu-games')">
                    <i class="fa-solid fa-plus"></i>
                </div>
            </div>
        </section>
    </div>

    <div id="addSectionBtn" onclick="openAdminModal('NEW_SECTION')"><i class="fa-solid fa-plus"></i> Add New Section</div>

    <footer><p>Â© 2026 IG-bio. Designed for CIE IGCSE Syllabus 0610.</p></footer>
</div>

<!-- MODALS -->
<div id="profileModal" class="modal-overlay">
    <div class="modal-box">
        <img src="" id="profileModalAvatar" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); margin-bottom:15px;">
        <h2 id="profileUsername" style="margin-bottom:20px;">User</h2>
        <button onclick="logout()" class="cta-btn btn-danger" style="width:100%;">Log Out</button>
        <button onclick="document.getElementById('profileModal').style.display='none'" class="close-btn">Close</button>
    </div>
</div>

<div id="adminAddModal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="adminModalTitle" style="color:var(--primary); margin-bottom:15px;">Add New Item</h2>
        <input type="hidden" id="adminTargetSection">
        <div style="text-align:left; margin-bottom:10px;"><label style="font-size:0.8rem; font-weight:bold;">Title</label><input type="text" id="adminTitle" class="auth-input"></div>
        <div style="text-align:left; margin-bottom:10px;" id="adminNumDiv"><label style="font-size:0.8rem; font-weight:bold;">Chapter Number (Optional)</label><input type="text" id="adminNum" class="auth-input"></div>
        <div style="text-align:left; margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:bold;">HTML File Name</label><input type="text" id="adminFile" class="auth-input"></div>
        <button onclick="saveAdminItem()" class="cta-btn" style="width:100%;">Save & Add</button>
        <button onclick="document.getElementById('adminAddModal').style.display='none'" class="close-btn">Cancel</button>
    </div>
</div>

<div id="adminEditModal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color:var(--primary); margin-bottom:15px;">Edit Item</h2>
        <input type="hidden" id="editItemId">
        <div style="text-align:left; margin-bottom:10px;"><label style="font-size:0.8rem; font-weight:bold;">Title</label><input type="text" id="editTitle" class="auth-input"></div>
        <div style="text-align:left; margin-bottom:10px;"><label style="font-size:0.8rem; font-weight:bold;">Subtitle / Number</label><input type="text" id="editSubtitle" class="auth-input"></div>
        <div style="text-align:left; margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:bold;">File Name</label><input type="text" id="editFile" class="auth-input"></div>
        <div style="display:flex; gap:10px;">
            <button onclick="saveEditItem()" class="cta-btn" style="flex:1;">Save</button>
            <button onclick="deleteItem()" class="cta-btn btn-danger" style="flex:1;">Delete</button>
        </div>
        <button onclick="document.getElementById('adminEditModal').style.display='none'" class="close-btn">Cancel</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOkZSP6ZMvdoZ8QAt0e8iRxzFa1-lRNnk",
      authDomain: "ig-bio-f9d8f.firebaseapp.com",
      projectId: "ig-bio-f9d8f",
      storageBucket: "ig-bio-f9d8f.firebasestorage.app",
      messagingSenderId: "630166010132",
      appId: "1:630166010132:web:72f335cf0f012b85bb6a01"
    };

    let currentEditElement = null; 
    let userProgress = []; // Global progress store

    try {
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let isAdmin = false;
        let isSignupMode = false;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists) {
                    const data = doc.data();
                    if(data.isAdmin === true) isAdmin = true;
                    
                    // PRE-LOAD PROGRESS
                    userProgress = data.progress || [];
                    
                    updateUI(data);
                    await loadAllContent(); // Now content loads with checked boxes
                    updateProgressBar();
                }
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
            } else {
                currentUser = null;
                isAdmin = false;
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        async function loadAllContent() {
            const snapshot = await db.collection('siteContent').get();
            const docs = [];
            snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));

            docs.sort((a, b) => (a.orderIndex ?? 99999) - (b.orderIndex ?? 99999));

            docs.forEach(item => {
                if (!item.deleted && item.sectionId) {
                    if(item.sectionId === 'NEW_SECTION') createNewSection(item.title);
                    else {
                        let gridId = (item.sectionId === 'chapters') ? 'grid' : 
                                     (item.sectionId === 'general-topics') ? 'topicGrid' : 
                                     (item.sectionId === 'edu-games') ? 'gameGrid' : item.sectionId;
                        createCard(gridId, item, item.id);
                    }
                }
            });

            if(isAdmin) enableAdminMode();
        }

        function createCard(gridId, data, docId) {
            const grid = document.getElementById(gridId);
            if(!grid) return;
            
            const div = document.createElement('div');
            div.className = 'chapter-card';
            if(data.isHidden) div.classList.add('unavailable');
            
            div.onclick = function() { window.location.href = data.file; };
            div.setAttribute('data-doc-id', docId);
            div.setAttribute('data-file', data.file); 

            let iconHtml = (gridId === 'gameGrid') ? '<i class="fa-solid fa-gamepad"></i>' : '<i class="fa-solid fa-chevron-right"></i>';
            let subtitleHtml = data.subtitle ? `<div class="chapter-num">${data.subtitle}</div>` : '';

            // CHECKBOX LOGIC: ONLY FOR 'grid' (CHAPTERS)
            let checkboxHtml = '';
            if(gridId === 'grid') {
                const isChecked = userProgress.includes(docId) ? 'checked' : '';
                checkboxHtml = `<input type="checkbox" class="progress-check" id="${docId}" ${isChecked} onclick="toggleProgress(event, '${docId}')">`;
            }

            div.innerHTML = `
                ${checkboxHtml}
                ${subtitleHtml}
                <div class="chapter-title" style="${!data.subtitle ? 'margin:auto' : ''}">${data.title}</div>
                <div class="chapter-icon">${iconHtml}</div>
            `;

            const addBtn = grid.querySelector('.add-card');
            grid.insertBefore(div, addBtn);
            
            if(isAdmin) injectAdminControls(div);
        }

        function enableAdminMode() {
            document.getElementById('adminBadge').style.display = 'inline-block';
            document.getElementById('addSectionBtn').style.display = 'block';
            document.querySelectorAll('.add-card').forEach(el => el.style.display = 'flex');
            document.querySelectorAll('.chapter-card:not(.add-card)').forEach(card => injectAdminControls(card));
            
            const grids = ['grid', 'topicGrid', 'gameGrid'];
            document.querySelectorAll('.chapter-grid').forEach(g => { if(!grids.includes(g.id)) grids.push(g.id); });

            grids.forEach(gridId => {
                const el = document.getElementById(gridId);
                if(el) {
                    Sortable.create(el, { 
                        handle: '.drag-handle', 
                        animation: 150,
                        draggable: ".chapter-card:not(.add-card)",
                        onEnd: async function(evt) {
                            const grid = evt.to;
                            const cards = grid.querySelectorAll('.chapter-card:not(.add-card)');
                            const batch = db.batch();
                            cards.forEach((card, index) => {
                                const id = card.getAttribute('data-doc-id');
                                if(id) batch.update(db.collection('siteContent').doc(id), { orderIndex: index });
                            });
                            await batch.commit();
                            console.log("Order Saved");
                        }
                    });
                }
            });
            enableDragAndDrop('content-sections-wrapper', '.section-drag-handle');
        }

        function injectAdminControls(cardElement) {
            if(cardElement.querySelector('.admin-controls')) return;
            const controls = document.createElement('div');
            controls.className = 'admin-controls';
            const isHidden = cardElement.classList.contains('unavailable');
            controls.innerHTML = `
                <div class="control-btn drag-handle"><i class="fa-solid fa-bars"></i></div>
                <div class="control-btn" onclick="openEditModal(this)"><i class="fa-solid fa-gear"></i></div>
                <div class="control-btn" onclick="toggleVisibility(event, this)"><i class="fa-regular ${isHidden ? 'fa-eye-slash' : 'fa-eye'}"></i></div>
            `;
            controls.onclick = (e) => e.stopPropagation();
            cardElement.appendChild(controls);
            cardElement.classList.add('admin-view');
            controls.style.display = 'flex';
        }

        window.toggleProgress = async function(e, id) {
            e.stopPropagation(); 
            const box = document.getElementById(id);
            const action = box.checked ? 'arrayUnion' : 'arrayRemove';
            await db.collection('users').doc(currentUser.uid).update({ progress: firebase.firestore.FieldValue[action](id) });
            // Update local global var
            if(box.checked) userProgress.push(id);
            else userProgress = userProgress.filter(item => item !== id);
            updateProgressBar();
        }

        window.updateProgressBar = function() {
            const total = document.querySelectorAll('.progress-check').length || 1;
            const checked = document.querySelectorAll('.progress-check:checked').length;
            const pct = Math.round((checked/total)*100);
            document.getElementById('progressFill').style.width = pct+"%";
            document.getElementById('progressText').innerText = pct+"%";
        }

        window.openAdminModal = function(s) { 
            document.getElementById('adminAddModal').style.display = 'flex'; 
            document.getElementById('adminTargetSection').value = s; 
            document.getElementById('adminTitle').value = "";
            document.getElementById('adminNum').value = "";
            document.getElementById('adminFile').value = "";
        }

        window.saveAdminItem = async function() {
            const section = document.getElementById('adminTargetSection').value;
            const title = document.getElementById('adminTitle').value;
            const num = document.getElementById('adminNum').value;
            const file = document.getElementById('adminFile').value;
            if(!title || !file) { alert("Required"); return; }

            const newItem = { sectionId: section, title, subtitle: num, file, orderIndex: 9999, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            const docRef = await db.collection('siteContent').add(newItem);
            document.getElementById('adminAddModal').style.display = 'none';
            
            let gridId = (section === 'chapters') ? 'grid' : (section === 'general-topics') ? 'topicGrid' : (section === 'edu-games') ? 'gameGrid' : section;
            createCard(gridId, newItem, docRef.id);
        }

        window.openEditModal = function(btn) { 
            const card = btn.closest('.chapter-card'); 
            currentEditElement = card; 
            document.getElementById('editItemId').value = card.getAttribute('data-doc-id');
            document.getElementById('editTitle').value = card.querySelector('.chapter-title').innerText;
            document.getElementById('editSubtitle').value = card.querySelector('.chapter-num') ? card.querySelector('.chapter-num').innerText : "";
            document.getElementById('editFile').value = card.getAttribute('data-file') || "";
            document.getElementById('adminEditModal').style.display = 'flex'; 
        }

        window.saveEditItem = async function() {
            let id = document.getElementById('editItemId').value;
            const title = document.getElementById('editTitle').value;
            const sub = document.getElementById('editSubtitle').value;
            const file = document.getElementById('editFile').value;
            
            await db.collection('siteContent').doc(id).update({ title, subtitle: sub, file });
            
            const card = currentEditElement;
            card.querySelector('.chapter-title').innerText = title;
            if(card.querySelector('.chapter-num')) card.querySelector('.chapter-num').innerText = sub;
            else if(sub) card.innerHTML = `<div class="chapter-num">${sub}</div>` + card.innerHTML;
            card.setAttribute('data-file', file);
            card.onclick = function() { window.location.href = file; };
            
            document.getElementById('adminEditModal').style.display = 'none';
        }

        window.deleteItem = async function() {
            if(!confirm("Delete?")) return;
            let id = document.getElementById('editItemId').value;
            await db.collection('siteContent').doc(id).update({ deleted: true });
            currentEditElement.remove();
            document.getElementById('adminEditModal').style.display = 'none';
        }

        window.toggleVisibility = async function(e, btn) {
            e.stopPropagation();
            const card = btn.closest('.chapter-card');
            const isHidden = !card.classList.contains('unavailable');
            card.classList.toggle('unavailable');
            btn.innerHTML = `<i class="fa-regular ${isHidden ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
            await db.collection('siteContent').doc(card.getAttribute('data-doc-id')).update({ isHidden });
        }

        window.toggleAuthMode = function() { isSignupMode = !isSignupMode; document.getElementById('authTitle').innerText = isSignupMode ? "Create Account" : "Sign In"; document.getElementById('authActionBtn').innerText = isSignupMode ? "Sign Up" : "Login"; document.getElementById('signupExtras').style.display = isSignupMode ? "block" : "none"; }
        window.handleAuthAction = async function() {
            const email = document.getElementById('email').value; const pass = document.getElementById('password').value;
            try {
                if(isSignupMode) {
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    const username = document.getElementById('username').value || "Student";
                    const gender = document.querySelector('input[name="gender"]:checked').value;
                    await db.collection('users').doc(cred.user.uid).set({ username, gender, progress: [], isAdmin: false });
                } else await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) { alert(e.message); }
        }
        window.logout = function() { auth.signOut(); window.location.reload(); }
        window.updateUI = function(data) {
            const img = (data.gender === 'female') ? "https://cdn-icons-png.flaticon.com/512/4128/4128253.png" : "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
            document.getElementById('topRightAvatar').src = img;
            document.getElementById('profileModalAvatar').src = img;
            document.getElementById('welcomeMsg').innerText = `Welcome, ${data.username}!`;
            document.getElementById('profileUsername').innerText = data.username;
        }
        window.openProfileSettings = function() { document.getElementById('profileModal').style.display = 'flex'; }
        window.enableDragAndDrop = function(elId, handle) { const el = document.getElementById(elId); if(el) Sortable.create(el, { handle: handle, animation: 150 }); }
        function createNewSection(title) {
            const safeId = title.replace(/\s+/g, '-').toLowerCase();
            if(document.getElementById(safeId)) return;
            document.getElementById('nav-links').innerHTML += `<li><a href="#${safeId}"><i class="fa-solid fa-book"></i> ${title}</a></li>`;
            const w = document.getElementById('content-sections-wrapper');
            const s = document.createElement('section'); s.className = 'chapters-section'; s.id = safeId;
            s.innerHTML = `<div class="section-header"><i class="fa-solid fa-bars section-drag-handle"></i><h2>${title}</h2></div><div class="chapter-grid" id="${safeId}"><div class="chapter-card add-card" onclick="openAdminModal('${safeId}')"><i class="fa-solid fa-plus"></i></div></div>`;
            w.appendChild(s);
        }
        window.filterGrid = function(gid, val) {
            const v = val.toUpperCase();
            document.querySelectorAll('#'+gid+' .chapter-card:not(.add-card)').forEach(c => {
                c.style.display = c.innerText.toUpperCase().includes(v) ? 'flex' : 'none';
            });
        }

    } catch (e) { console.error(e); }
</script>
</body>
</html>
