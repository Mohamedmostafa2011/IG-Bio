<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG-bio | The Ultimate IGCSE Biology Resource</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; 
            --primary-dark: #1e40af;
            --accent: #f59e0b; 
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* ================= AUTH SCREEN ================= */
        #auth-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .auth-container {
            background: white; width: 90%; max-width: 450px; padding: 3rem;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center; animation: fadeIn 0.5s ease-out;
        }
        .auth-logo { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 0.5rem; display: inline-block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ================= MAIN APP ================= */
        #main-app { display: none; }

        nav {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 0.8rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        nav ul { display: flex; gap: 30px; list-style: none; margin: 0; padding: 0; }
        nav a {
            text-decoration: none; color: var(--text); font-weight: 700;
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        nav a:hover { color: var(--primary); transform: translateY(-2px); }

        .nav-profile-area { display: flex; align-items: center; gap: 15px; }
        .profile-avatar {
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            border: 2px solid var(--primary); padding: 2px; object-fit: cover; background: white;
        }
        .admin-badge {
            background: var(--accent); color: white; padding: 2px 8px;
            border-radius: 10px; font-size: 0.7rem; font-weight: 800;
            display: none; text-transform: uppercase; letter-spacing: 1px;
        }

        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            color: white; padding: 5rem 1rem; text-align: center;
            position: relative; overflow: hidden;
        }
        .hero-content { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; }
        header h1 {
            font-size: 4rem; font-weight: 800; letter-spacing: -2px; margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, #93c5fd);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .cta-btn {
            display: inline-block; background: var(--primary); color: white;
            padding: 15px 35px; border-radius: 50px; font-weight: 600;
            text-decoration: none; transition: 0.3s; border: 2px solid transparent; cursor: pointer;
            font-size: 1rem;
        }
        .cta-btn:hover { background: transparent; border-color: var(--primary); color: var(--primary); }
        .btn-games { background: var(--success); border-color: var(--success); }
        .btn-games:hover { color: var(--success); }
        .btn-danger { background: var(--danger); border-color: var(--danger); }
        .btn-danger:hover { color: var(--danger); }

        #userDashboard {
            background: white; padding: 20px; margin: 20px auto; max-width: 1200px;
            border-radius: 12px; border-left: 5px solid var(--success);
            display: flex; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            justify-content: space-between; align-items: center;
        }
        .progress-container { flex: 1; margin: 0 20px; }
        .progress-bar-bg { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }

        .features {
            max-width: 1200px; margin: -50px auto 3rem auto; padding: 0 1rem;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; position: relative; z-index: 2;
        }
        .feature-card {
            background: var(--surface); padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center;
            border-top: 5px solid var(--primary);
        }

        .chapters-section { max-width: 1200px; margin: 4rem auto; padding: 0 1rem; }
        .section-header { text-align: center; margin-bottom: 3rem; position: relative;} 
        .section-header h2 { font-size: 2.5rem; color: var(--text); }

        .search-container { max-width: 500px; margin: 0 auto 3rem auto; position: relative; }
        .search-bar { width: 100%; padding: 15px 20px 15px 50px; border-radius: 50px; border: 2px solid #e2e8f0; }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .chapter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .chapter-card {
            background: var(--surface); border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 1.5rem; text-decoration: none; color: var(--text);
            display: flex; flex-direction: column; transition: 0.2s ease; position: relative; overflow: hidden;
            cursor: pointer; min-height: 180px;
        }
        .chapter-card:hover { border-color: var(--primary); transform: scale(1.02); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.1); }
        
        .chapter-card.unavailable { opacity: 0.5; filter: grayscale(100%); pointer-events: none; }
        .chapter-card.unavailable .admin-controls { pointer-events: auto; }

        .chapter-num { font-size: 0.8rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .chapter-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: var(--primary-dark); }
        .chapter-icon {
            align-self: flex-end; font-size: 1.5rem; color: var(--bg); background: var(--primary);
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; margin-top: auto; transition: 0.3s;
        }
        .progress-check {
            position: absolute; top: 15px; right: 15px;
            width: 25px; height: 25px; cursor: pointer; accent-color: var(--success); z-index: 10; transform: scale(1.5);
        }

        /* ================= ADMIN SPECIFIC STYLES ================= */
        .add-card {
            border: 2px dashed var(--primary);
            background: rgba(37, 99, 235, 0.05);
            justify-content: center; align-items: center;
            min-height: 200px;
            display: none; 
        }
        .add-card:hover { background: rgba(37, 99, 235, 0.1); transform: scale(1.05); }
        .add-card i { font-size: 3rem; color: var(--primary); }

        .admin-controls {
            position: absolute; bottom: 15px; left: 15px;
            display: none; gap: 10px; z-index: 20;
        }
        .control-btn { 
            background: #e2e8f0; width: 30px; height: 30px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text); transition: 0.2s; font-size: 0.8rem;
        }
        .control-btn:hover { background: var(--primary); color: white; }
        .drag-handle { cursor: grab; }
        .section-drag-handle {
            display: none; font-size: 1.5rem; color: #cbd5e1; 
            cursor: grab; position: absolute; left: -40px; top: 10px;
        }
        
        #addSectionBtn {
            display: none; margin: 4rem auto; max-width: 300px;
            background: var(--text); color: white; text-align: center;
            padding: 1rem; border-radius: 10px; cursor: pointer;
        }
        #addSectionBtn:hover { background: var(--primary); }

        /* ================= MODALS ================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 2rem; border-radius: 15px;
            width: 100%; max-width: 500px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
            animation: fadeIn 0.3s;
        }
        .close-btn { background: transparent; border: none; color: #999; margin-top: 10px; cursor: pointer; font-size: 0.9rem; }
        .auth-input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; background: #f8fafc;
        }
        .gender-options { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        #authError { color: #ef4444; margin-top: 10px; font-size: 0.9rem; display: none; font-weight: 600; }

        @media(max-width: 600px) {
            header h1 { font-size: 2.5rem; }
            nav ul { display: none; }
            #userDashboard { flex-direction: column; align-items: flex-start; gap: 10px; }
            .progress-container { width: 100%; margin: 0; }
        }
    </style>
</head>
<body>

    <!-- ================= 1. LOGIN SCREEN ================= -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-logo"><i class="fa-solid fa-dna"></i> IG-bio</div>
            <p class="auth-subtitle">The Ultimate IGCSE Biology Resource</p>
            
            <h2 id="authTitle" style="color:var(--text); margin-bottom:15px;">Sign In</h2>
            <input type="email" id="email" class="auth-input" placeholder="Email Address">
            <div id="signupExtras" style="display:none;">
                <input type="text" id="username" class="auth-input" placeholder="Username">
                <div class="gender-options">
                    <div class="gender-option">
                        <input type="radio" name="gender" value="male" id="g_male" checked>
                        <label for="g_male">Male</label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" name="gender" value="female" id="g_female">
                        <label for="g_female">Female</label>
                    </div>
                </div>
            </div>
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button onclick="handleAuthAction()" class="cta-btn auth-btn" style="width:100%; margin-top:15px;" id="authActionBtn">Login</button>
            <p id="authError"></p>
            <p style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:var(--primary); text-decoration: underline;" onclick="toggleAuthMode()" id="authToggle">New here? Create an account</p>
        </div>
    </div>

    <!-- ================= 2. MAIN APPLICATION ================= -->
    <div id="main-app">
        <nav>
            <div style="font-weight:800; font-size:1.5rem; color:var(--primary);">IG-bio</div>
            <ul id="nav-links">
                <li><a href="#chapters"><i class="fa-solid fa-book"></i> <span>Chapters</span></a></li>
                <li><a href="#general-topics"><i class="fa-solid fa-layer-group"></i> <span>Topics</span></a></li>
                <li><a href="#edu-games"><i class="fa-solid fa-gamepad"></i> <span>Games</span></a></li>
            </ul>
            <div class="nav-profile-area">
                <span class="admin-badge" id="adminBadge">ADMIN</span>
                <img src="" id="topRightAvatar" class="profile-avatar" onclick="openProfileSettings()" alt="Profile">
            </div>
        </nav>
        
        <header>
            <div id="userDashboard">
                <div style="text-align: left;">
                    <h3 id="welcomeMsg" style="margin:0; color: var(--text);">Welcome!</h3>
                </div>
                <div class="progress-container">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                        <span>Course Progress</span><span id="progressText">0%</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-fill" id="progressFill"></div></div>
                </div>
            </div>

            <div class="hero-content">
                <h1>Master Biology.</h1>
                <p>Access audio lectures, smart notes, and interactive quizzes.</p>
                <div class="hero-btn-group">
                    <a href="#chapters" class="cta-btn">Start Learning</a>
                    <a href="#edu-games" class="cta-btn btn-games">Play Games</a>
                </div>
            </div>
        </header>

        <div class="features">
            <div class="feature-card"><i class="fa-solid fa-headphones feature-icon"></i><h3>Audio Lectures</h3></div>
            <div class="feature-card" style="border-top-color: #10b981;"><i class="fa-solid fa-book-open feature-icon" style="color: #10b981;"></i><h3>Smart Notes</h3></div>
            <div class="feature-card" style="border-top-color: #f59e0b;"><i class="fa-solid fa-sitemap feature-icon" style="color: #f59e0b;"></i><h3>Mind Maps</h3></div>
            <div class="feature-card" style="border-top-color: #ef4444;"><i class="fa-solid fa-clipboard-check feature-icon" style="color: #ef4444;"></i><h3>Exam Quizzes</h3></div>
        </div>

        <!-- DYNAMIC WRAPPER -->
        <div id="content-sections-wrapper">
            <!-- CHAPTERS -->
            <section class="chapters-section" id="chapters">
                <div class="section-header">
                    <i class="fa-solid fa-bars section-drag-handle"></i>
                    <h2>Course Content</h2>
                    <p>Select a chapter to begin your mastery.</p>
                </div>
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" class="search-bar" placeholder="Search chapters..." onkeyup="filterGrid('grid', this.value)">
                </div>
                <div class="chapter-grid" id="grid">
                    <!-- 20 CHAPTERS -->
                    <div onclick="openContent('1.Classification of Living Organisms .html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch1" onclick="toggleProgress(event, 'ch1')">
                        <div class="chapter-num">Chapter 1</div>
                        <div class="chapter-title">Characteristics of Living Organisms</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('2.Organisation of the organisms.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch2" onclick="toggleProgress(event, 'ch2')">
                        <div class="chapter-num">Chapter 2</div>
                        <div class="chapter-title">Organization of the Organism</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('3.Movements in & out of cells.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch3" onclick="toggleProgress(event, 'ch3')">
                        <div class="chapter-num">Chapter 3</div>
                        <div class="chapter-title">Movement In & Out of Cells</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('4.Biological Molecules.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch4" onclick="toggleProgress(event, 'ch4')">
                        <div class="chapter-num">Chapter 4</div>
                        <div class="chapter-title">Biological Molecules</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('5.Enzymes.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch5" onclick="toggleProgress(event, 'ch5')">
                        <div class="chapter-num">Chapter 5</div>
                        <div class="chapter-title">Enzymes</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('6.Plant Nutrition.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch6" onclick="toggleProgress(event, 'ch6')">
                        <div class="chapter-num">Chapter 6</div>
                        <div class="chapter-title">Plant Nutrition</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('7.Human Nutrition.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch7" onclick="toggleProgress(event, 'ch7')">
                        <div class="chapter-num">Chapter 7</div>
                        <div class="chapter-title">Human Nutrition</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('8.Transport in Plants.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch8" onclick="toggleProgress(event, 'ch8')">
                        <div class="chapter-num">Chapter 8</div>
                        <div class="chapter-title">Transport in Plants</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('9.Transport in humans.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch9" onclick="toggleProgress(event, 'ch9')">
                        <div class="chapter-num">Chapter 9</div>
                        <div class="chapter-title">Transport in Animals</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('10.Disease and Immunity.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch10" onclick="toggleProgress(event, 'ch10')">
                        <div class="chapter-num">Chapter 10</div>
                        <div class="chapter-title">Diseases and Immunity</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('11.Respiration and Gas Exchange.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch11" onclick="toggleProgress(event, 'ch11')">
                        <div class="chapter-num">Chapter 11</div>
                        <div class="chapter-title">Gas Exchange and Respiration</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('12.Coordination and Response.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch12" onclick="toggleProgress(event, 'ch12')">
                        <div class="chapter-num">Chapter 12</div>
                        <div class="chapter-title">Coordination and Response</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('13.Excretion And Homeostasis.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch13" onclick="toggleProgress(event, 'ch13')">
                        <div class="chapter-num">Chapter 13</div>
                        <div class="chapter-title">Excretion And Homeostasis</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('14.Reproduction In Plants.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch14" onclick="toggleProgress(event, 'ch14')">
                        <div class="chapter-num">Chapter 14</div>
                        <div class="chapter-title">Reproduction In Plants</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('15.Reproduction In Humans.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch15" onclick="toggleProgress(event, 'ch15')">
                        <div class="chapter-num">Chapter 15</div>
                        <div class="chapter-title">Reproduction In Humans</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('16.Chromosomes, Genes and Proteins.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch16" onclick="toggleProgress(event, 'ch16')">
                        <div class="chapter-num">Chapter 16</div>
                        <div class="chapter-title">Chromosomes, Genes and Proteins</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('17.Variation and Selection.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch17" onclick="toggleProgress(event, 'ch17')">
                        <div class="chapter-num">Chapter 17</div>
                        <div class="chapter-title">Variation and Selection</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('18.Organisms and their Environment.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch18" onclick="toggleProgress(event, 'ch18')">
                        <div class="chapter-num">Chapter 18</div>
                        <div class="chapter-title">Organisms and their Environment</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('19.Human Influences on Ecosystems.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch19" onclick="toggleProgress(event, 'ch19')">
                        <div class="chapter-num">Chapter 19</div>
                        <div class="chapter-title">Human Influences on Ecosystems</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('20.Biotechnology & Genetic Modification.html')" class="chapter-card">
                        <input type="checkbox" class="progress-check" id="ch20" onclick="toggleProgress(event, 'ch20')">
                        <div class="chapter-num">Chapter 20</div>
                        <div class="chapter-title">Biotechnology & Genetic Modification</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    
                    <!-- ADMIN ADD BUTTON -->
                    <div class="chapter-card add-card" id="add-btn-chapters" onclick="openAdminModal('chapters')">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
            </section>

            <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;"><hr style="border: 0; height: 1px; background: #e2e8f0; margin: 4rem 0;"></div>

            <!-- GENERAL TOPICS -->
            <section class="chapters-section" id="general-topics">
                <div class="section-header">
                    <i class="fa-solid fa-bars section-drag-handle"></i>
                    <h2>General Topics</h2>
                    <p>Additional resources.</p>
                </div>
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" class="search-bar" placeholder="Search topics..." onkeyup="filterGrid('topicGrid', this.value)">
                </div>
                <div class="chapter-grid" id="topicGrid">
                    <div onclick="openContent('specialised cells.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Specialised Cells</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('smoking.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Smoking</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('CHD.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">CHD</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('Blood.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Blood</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div onclick="openContent('defense.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Defense Against Diseases</div>
                        <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <!-- ADMIN ADD BUTTON -->
                    <div class="chapter-card add-card" id="add-btn-topics" onclick="openAdminModal('general-topics')">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
            </section>

            <!-- EDU-GAMES -->
            <section class="chapters-section" id="edu-games">
                <div class="section-header">
                    <i class="fa-solid fa-bars section-drag-handle"></i>
                    <h2>Edu-Games</h2>
                    <p>Interactive simulations.</p>
                </div>
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" class="search-bar" placeholder="Search games..." onkeyup="filterGrid('gameGrid', this.value)">
                </div>
                <div class="chapter-grid" id="gameGrid">
                    <div onclick="openContent('game1.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Classification Game</div>
                        <div class="chapter-icon"><i class="fa-solid fa-gamepad"></i></div>
                    </div>
                    <div onclick="openContent('game2.html')" class="chapter-card">
                        <div class="chapter-title" style="margin: auto;">Organisation Game</div>
                        <div class="chapter-icon"><i class="fa-solid fa-gamepad"></i></div>
                    </div>
                    <!-- ADMIN ADD BUTTON -->
                    <div class="chapter-card add-card" id="add-btn-games" onclick="openAdminModal('edu-games')">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
            </section>
        </div>

        <!-- ADMIN: ADD SECTION -->
        <div id="addSectionBtn" onclick="openAdminModal('NEW_SECTION')"><i class="fa-solid fa-plus"></i> Add New Section</div>

        <footer><p>Â© 2026 IG-bio. Designed for CIE IGCSE Syllabus 0610.</p></footer>
    </div>

    <!-- ================= PROFILE MODAL ================= -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <img src="" id="profileModalAvatar" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); margin-bottom:15px;">
            <h2 id="profileUsername">User</h2>
            <button onclick="logout()" class="cta-btn" style="width:100%; margin-top:10px; background:#ef4444;">Log Out</button>
            <button onclick="document.getElementById('profileModal').style.display='none'" class="close-btn">Close</button>
        </div>
    </div>

    <!-- ================= ADMIN ADD MODAL ================= -->
    <div id="adminAddModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="adminModalTitle" style="color:var(--primary); margin-bottom:15px;">Add New Item</h2>
            <input type="hidden" id="adminTargetSection">
            
            <div style="text-align:left;">
                <label style="font-size:0.8rem; font-weight:bold;">Title</label>
                <input type="text" id="adminTitle" class="auth-input" placeholder="e.g., Transport in Animals">
            </div>
            <div style="text-align:left; display:none;" id="adminNumDiv">
                <label style="font-size:0.8rem; font-weight:bold;">Chapter Number (Optional)</label>
                <input type="text" id="adminNum" class="auth-input" placeholder="e.g., Chapter 21">
            </div>
            <div style="text-align:left; margin-top:10px;">
                <label style="font-size:0.8rem; font-weight:bold;">HTML File Name</label>
                <input type="text" id="adminFile" class="auth-input" placeholder="e.g., chapter21.html">
            </div>

            <button onclick="saveAdminItem()" class="cta-btn" style="width:100%; margin-top:15px;">Save & Add</button>
            <button onclick="document.getElementById('adminAddModal').style.display='none'" class="close-btn">Cancel</button>
        </div>
    </div>

    <!-- ================= ADMIN EDIT/DELETE MODAL ================= -->
    <div id="adminEditModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:var(--primary); margin-bottom:15px;">Edit Item</h2>
            <input type="hidden" id="editItemId"> <!-- Firestore ID if exists -->
            
            <div style="text-align:left;">
                <label style="font-size:0.8rem; font-weight:bold;">Title</label>
                <input type="text" id="editTitle" class="auth-input">
            </div>
            <div style="text-align:left;">
                <label style="font-size:0.8rem; font-weight:bold;">Subtitle / Number</label>
                <input type="text" id="editSubtitle" class="auth-input">
            </div>
            <div style="text-align:left; margin-top:10px;">
                <label style="font-size:0.8rem; font-weight:bold;">File Name</label>
                <input type="text" id="editFile" class="auth-input">
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="saveEditItem()" class="cta-btn" style="flex:1;">Save Changes</button>
                <button onclick="deleteItem()" class="cta-btn btn-danger" style="flex:1;">Delete</button>
            </div>
            <button onclick="document.getElementById('adminEditModal').style.display='none'" class="close-btn">Cancel</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBOkZSP6ZMvdoZ8QAt0e8iRxzFa1-lRNnk",
          authDomain: "ig-bio-f9d8f.firebaseapp.com",
          projectId: "ig-bio-f9d8f",
          storageBucket: "ig-bio-f9d8f.firebasestorage.app",
          messagingSenderId: "630166010132",
          appId: "1:630166010132:web:72f335cf0f012b85bb6a01"
        };

        let currentEditElement = null; 

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;
            let isAdmin = false;
            let isSignupMode = false;

            auth.onAuthStateChanged(async (user) => {
                const authScreen = document.getElementById('auth-screen');
                const mainApp = document.getElementById('main-app');

                if (user) {
                    currentUser = user;
                    const doc = await db.collection('users').doc(user.uid).get();
                    if(doc.exists) {
                        const data = doc.data();
                        if(data.isAdmin === true) {
                            isAdmin = true;
                            enableAdminMode();
                        }
                        updateUI(data);
                        loadProgress(data.progress || []);
                        loadDynamicContent();
                    }
                    authScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                } else {
                    currentUser = null;
                    isAdmin = false;
                    authScreen.style.display = 'flex';
                    mainApp.style.display = 'none';
                }
            });

            function enableAdminMode() {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('addSectionBtn').style.display = 'block';
                document.querySelectorAll('.add-card').forEach(el => el.style.display = 'flex');
                document.querySelectorAll('.chapter-card:not(.add-card)').forEach(card => injectAdminControls(card));
                
                enableDragAndDrop('content-sections-wrapper', '.section-drag-handle');
                enableDragAndDrop('grid', '.drag-handle');
                enableDragAndDrop('topicGrid', '.drag-handle');
                enableDragAndDrop('gameGrid', '.drag-handle');
            }

            function injectAdminControls(cardElement) {
                if(cardElement.querySelector('.admin-controls')) return;
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                controls.innerHTML = `
                    <div class="control-btn drag-handle"><i class="fa-solid fa-bars"></i></div>
                    <div class="control-btn" onclick="openEditModal(this)"><i class="fa-solid fa-gear"></i></div>
                    <div class="control-btn" onclick="toggleVisibility(event, this)"><i class="fa-regular fa-eye"></i></div>
                `;
                controls.onclick = (e) => e.stopPropagation();
                cardElement.appendChild(controls);
                controls.style.display = 'flex';
            }

            // --- ADD ITEM (NO RELOAD) ---
            window.openAdminModal = function(sectionId) {
                if(!isAdmin) return;
                document.getElementById('adminAddModal').style.display = 'flex';
                document.getElementById('adminTargetSection').value = sectionId;
                
                const numDiv = document.getElementById('adminNumDiv');
                if(sectionId === 'NEW_SECTION') {
                     document.getElementById('adminModalTitle').innerText = "Add New Section";
                     numDiv.style.display = 'none';
                } else {
                    document.getElementById('adminModalTitle').innerText = "Add Item";
                    numDiv.style.display = (sectionId.includes('grid') || sectionId === 'chapters') ? 'block' : 'none';
                }
            }

            window.saveAdminItem = async function() {
                const section = document.getElementById('adminTargetSection').value;
                const title = document.getElementById('adminTitle').value;
                const num = document.getElementById('adminNum').value;
                const file = document.getElementById('adminFile').value;

                if(!title || !file) { alert("Title and File required"); return; }

                const newItem = { sectionId: section, title: title, subtitle: num, file: file, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                const docRef = await db.collection('siteContent').add(newItem);
                
                document.getElementById('adminAddModal').style.display = 'none';
                
                // Update DOM immediately without reload
                if(section === 'NEW_SECTION') {
                    createNewSection(title);
                } else {
                    let gridId = (section === 'chapters') ? 'grid' : (section === 'general-topics') ? 'topicGrid' : (section === 'edu-games') ? 'gameGrid' : section;
                    createCard(gridId, newItem, docRef.id);
                    if(isAdmin) {
                        // Re-apply admin controls to the new item
                        const grid = document.getElementById(gridId);
                        const cards = grid.querySelectorAll('.chapter-card');
                        // The second to last card is our new one (before the Add button)
                        const newCard = cards[cards.length - 2]; 
                        if(newCard) injectAdminControls(newCard);
                    }
                }
            }

            // --- EDIT / DELETE (NO RELOAD) ---
            window.openEditModal = function(btn) {
                if(!isAdmin) return;
                const card = btn.closest('.chapter-card');
                currentEditElement = card; 

                const titleEl = card.querySelector('.chapter-title');
                const subEl = card.querySelector('.chapter-num');
                
                let fileVal = "";
                const clickStr = card.getAttribute('onclick');
                if(clickStr) { const match = clickStr.match(/'([^']+)'/); if(match) fileVal = match[1]; }
                const dbId = card.getAttribute('data-doc-id') || "";

                document.getElementById('editItemId').value = dbId;
                document.getElementById('editTitle').value = titleEl ? titleEl.innerText.trim() : "";
                document.getElementById('editSubtitle').value = subEl ? subEl.innerText.trim() : "";
                document.getElementById('editFile').value = fileVal;
                document.getElementById('adminEditModal').style.display = 'flex';
            }

            window.saveEditItem = async function() {
                const id = document.getElementById('editItemId').value;
                const title = document.getElementById('editTitle').value;
                const sub = document.getElementById('editSubtitle').value;
                const file = document.getElementById('editFile').value;

                if(id) {
                    await db.collection('siteContent').doc(id).update({ title: title, subtitle: sub, file: file });
                }
                
                // Update DOM Element
                if(currentEditElement) {
                    const titleEl = currentEditElement.querySelector('.chapter-title');
                    const subEl = currentEditElement.querySelector('.chapter-num');
                    if(titleEl) titleEl.innerText = title;
                    if(subEl) subEl.innerText = sub;
                    currentEditElement.setAttribute('onclick', `openContent('${file}')`);
                }
                document.getElementById('adminEditModal').style.display = 'none';
            }

            window.deleteItem = async function() {
                if(!confirm("Delete item?")) return;
                const id = document.getElementById('editItemId').value;
                if(id) await db.collection('siteContent').doc(id).delete();
                if(currentEditElement) currentEditElement.remove();
                document.getElementById('adminEditModal').style.display = 'none';
            }

            // --- LOAD DYNAMIC CONTENT ---
            window.loadDynamicContent = async function() {
                const snapshot = await db.collection('siteContent').orderBy('createdAt').get();
                snapshot.forEach(doc => {
                    const item = doc.data();
                    if(item.sectionId === 'NEW_SECTION') {
                        createNewSection(item.title);
                    } else {
                        let gridId = (item.sectionId === 'chapters') ? 'grid' : 
                                     (item.sectionId === 'general-topics') ? 'topicGrid' : 
                                     (item.sectionId === 'edu-games') ? 'gameGrid' : item.sectionId;
                        createCard(gridId, item, doc.id);
                    }
                });
                if(isAdmin) enableAdminMode();
            }

            function createCard(gridId, data, docId) {
                const grid = document.getElementById(gridId);
                if(!grid) return;
                const div = document.createElement('div');
                div.className = 'chapter-card';
                div.onclick = function() { openContent(data.file); };
                if(docId) div.setAttribute('data-doc-id', docId);

                let iconHtml = (gridId === 'gameGrid') ? '<i class="fa-solid fa-gamepad"></i>' : '<i class="fa-solid fa-chevron-right"></i>';
                let subtitleHtml = data.subtitle ? `<div class="chapter-num">${data.subtitle}</div>` : '';
                
                div.innerHTML = `
                    ${subtitleHtml}
                    <div class="chapter-title" style="${!data.subtitle ? 'margin:auto' : ''}">${data.title}</div>
                    <div class="chapter-icon">${iconHtml}</div>
                `;
                const addBtn = grid.querySelector('.add-card');
                if(addBtn) grid.insertBefore(div, addBtn);
                else grid.appendChild(div);
            }

            function createNewSection(title) {
                const safeId = title.replace(/\s+/g, '-').toLowerCase();
                document.getElementById('nav-links').innerHTML += `<li><a href="#${safeId}"><i class="fa-solid fa-folder"></i> <span>${title}</span></a></li>`;
                const wrapper = document.getElementById('content-sections-wrapper');
                const section = document.createElement('section');
                section.className = 'chapters-section';
                section.id = safeId;
                section.innerHTML = `
                    <div class="section-header">
                        <i class="fa-solid fa-bars section-drag-handle"></i>
                        <h2>${title}</h2>
                    </div>
                    <div class="chapter-grid" id="${safeId}">
                        <div class="chapter-card add-card" onclick="openAdminModal('${safeId}')"><i class="fa-solid fa-plus"></i></div>
                    </div>
                `;
                wrapper.appendChild(section);
            }

            // --- GENERAL UTILS ---
            window.toggleAuthMode = function() {
                isSignupMode = !isSignupMode;
                document.getElementById('authTitle').innerText = isSignupMode ? "Create Account" : "Sign In";
                document.getElementById('authActionBtn').innerText = isSignupMode ? "Sign Up" : "Login";
                document.getElementById('authToggle').innerText = isSignupMode ? "Have account? Login" : "New here? Create an account";
                document.getElementById('signupExtras').style.display = isSignupMode ? "block" : "none";
            }
            window.handleAuthAction = async function() {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                if(!email || !pass) return;
                try {
                    if(isSignupMode) {
                        const cred = await auth.createUserWithEmailAndPassword(email, pass);
                        const username = document.getElementById('username').value || "Student";
                        const gender = document.querySelector('input[name="gender"]:checked').value;
                        await db.collection('users').doc(cred.user.uid).set({ username: username, gender: gender, progress: [], isAdmin: false });
                    } else {
                        await auth.signInWithEmailAndPassword(email, pass);
                    }
                } catch (err) { document.getElementById('authError').innerText = err.message; document.getElementById('authError').style.display = 'block'; }
            }
            window.logout = function() { auth.signOut(); window.location.reload(); }
            window.updateUI = function(data) {
                const img = (data.gender === 'female') ? "https://cdn-icons-png.flaticon.com/512/4128/4128253.png" : "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
                document.getElementById('topRightAvatar').src = img;
                document.getElementById('profileModalAvatar').src = img;
                document.getElementById('welcomeMsg').innerText = `Welcome, ${data.username}!`;
                document.getElementById('profileUsername').innerText = data.username;
            }
            window.openProfileSettings = function() { document.getElementById('profileModal').style.display = 'flex'; }
            window.openContent = function(url) { window.location.href = url; }
            
            window.toggleProgress = async function(e, id) {
                e.stopPropagation(); if(!currentUser) return;
                const box = document.getElementById(id);
                if(box.checked) await db.collection('users').doc(currentUser.uid).update({ progress: firebase.firestore.FieldValue.arrayUnion(id) });
                else await db.collection('users').doc(currentUser.uid).update({ progress: firebase.firestore.FieldValue.arrayRemove(id) });
                updateProgressBar();
            }
            window.loadProgress = function(arr) { arr.forEach(id => { const b = document.getElementById(id); if(b) b.checked=true; }); updateProgressBar(); }
            window.updateProgressBar = function() {
                const t = document.querySelectorAll('.progress-check').length || 1;
                const c = document.querySelectorAll('.progress-check:checked').length;
                const p = Math.round((c/t)*100);
                document.getElementById('progressFill').style.width = p+"%";
                document.getElementById('progressText').innerText = p+"%";
            }
            window.filterGrid = function(gid, val) {
                const v = val.toUpperCase();
                document.querySelectorAll('#'+gid+' .chapter-card:not(.add-card)').forEach(c => {
                    c.style.display = c.innerText.toUpperCase().includes(v) ? 'flex' : 'none';
                });
            }
            window.toggleVisibility = function(e, btn) {
                e.stopPropagation();
                const card = btn.closest('.chapter-card');
                card.classList.toggle('unavailable');
                const icon = card.classList.contains('unavailable') ? 'fa-eye-slash' : 'fa-eye';
                btn.innerHTML = `<i class="fa-regular ${icon}"></i>`;
            }
            window.enableDragAndDrop = function(elId, handle) {
                const el = document.getElementById(elId);
                if(el) Sortable.create(el, { handle: handle, animation: 150 });
            }

        } catch (e) { console.error(e); }
    </script>
</body>
</html>
