<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG-bio | The Ultimate IGCSE Biology Resource</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb; 
            --primary-dark: #1e40af;
            --accent: #f59e0b; 
            --success: #10b981;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* ================= AUTH SCREEN (LOGIN PAGE) ================= */
        /* Displayed by DEFAULT (flex), hidden by JS only after success */
        #auth-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            display: flex; 
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-container {
            background: white;
            width: 90%;
            max-width: 450px;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .auth-logo {
            font-size: 2.5rem; font-weight: 800; color: var(--primary);
            margin-bottom: 0.5rem; display: inline-block;
        }
        
        .auth-subtitle { color: var(--text-light); margin-bottom: 2rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ================= MAIN APP STYLES ================= */
        /* Hidden by DEFAULT */
        #main-app { display: none; }

        /* --- Navigation --- */
        nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 0.8rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        nav ul { display: flex; gap: 30px; list-style: none; margin: 0; padding: 0; }

        nav a {
            text-decoration: none; color: var(--text); font-weight: 700;
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        nav a:hover { color: var(--primary); transform: translateY(-2px); }

        .nav-profile-area { display: flex; align-items: center; gap: 15px; }
        .profile-avatar {
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            border: 2px solid var(--primary); padding: 2px; transition: 0.3s;
            object-fit: cover; background: white;
        }
        .profile-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); }

        /* --- Hero Section --- */
        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            color: white; padding: 5rem 1rem; text-align: center;
            position: relative; overflow: hidden;
        }

        .hero-content { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; }

        header h1 {
            font-size: 4rem; font-weight: 800; letter-spacing: -2px; margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, #93c5fd);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        header p { font-size: 1.3rem; color: #cbd5e1; margin-bottom: 2rem; font-family: 'Lora', serif; }

        .cta-btn {
            display: inline-block; background: var(--primary); color: white;
            padding: 15px 35px; border-radius: 50px; font-weight: 600;
            text-decoration: none; transition: 0.3s; border: 2px solid transparent; cursor: pointer;
            font-size: 1rem;
        }
        .cta-btn:hover { background: transparent; border-color: var(--primary); color: var(--primary); transform: translateY(-3px); }
        
        .auth-btn { width: 100%; margin-top: 15px; background: var(--primary); border:none; color:white; }
        .auth-btn:hover { background: var(--primary-dark); color: white; transform: translateY(-2px); }

        .hero-btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
        .btn-topics { background: var(--accent); border-color: var(--accent); }
        .btn-topics:hover { color: var(--accent); background: transparent; }
        .btn-games { background: var(--success); border-color: var(--success); }
        .btn-games:hover { color: var(--success); background: transparent; }

        /* --- Dashboard --- */
        #userDashboard {
            background: white; padding: 20px; margin: 20px auto; max-width: 1200px;
            border-radius: 12px; border-left: 5px solid var(--success);
            display: flex; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            justify-content: space-between; align-items: center;
        }

        .progress-container { flex: 1; margin: 0 20px; }
        .progress-bar-bg { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }

        /* --- Features --- */
        .features {
            max-width: 1200px; margin: -50px auto 3rem auto; padding: 0 1rem;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; position: relative; z-index: 2;
        }
        .feature-card {
            background: var(--surface); padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center;
            transition: 0.3s; border-top: 5px solid var(--primary);
        }
        .feature-card:hover { transform: translateY(-10px); }
        .feature-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }

        /* --- Content Sections --- */
        .chapters-section { max-width: 1200px; margin: 4rem auto; padding: 0 1rem; }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-header h2 { font-size: 2.5rem; color: var(--text); }

        .search-container { max-width: 500px; margin: 0 auto 3rem auto; position: relative; }
        .search-bar { width: 100%; padding: 15px 20px 15px 50px; border-radius: 50px; border: 2px solid #e2e8f0; }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .chapter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .chapter-card {
            background: var(--surface); border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 1.5rem; text-decoration: none; color: var(--text);
            display: flex; flex-direction: column; transition: 0.2s ease; position: relative; overflow: hidden;
            cursor: pointer;
        }
        .chapter-card:hover { border-color: var(--primary); transform: scale(1.02); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.1); }
        
        .chapter-num { font-size: 0.8rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .chapter-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: var(--primary-dark); }
        .chapter-icon {
            align-self: flex-end; font-size: 1.5rem; color: var(--bg); background: var(--primary);
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; margin-top: auto; transition: 0.3s;
        }
        .chapter-card:hover .chapter-icon { background: var(--primary-dark); }

        .progress-check {
            position: absolute; top: 15px; right: 15px;
            width: 25px; height: 25px; cursor: pointer; accent-color: var(--success); z-index: 10; transform: scale(1.5);
        }

        /* --- Form Inputs --- */
        .auth-input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; background: #f8fafc;
        }
        .auth-input:focus { border-color: var(--primary); outline: none; background: white; }

        .gender-options { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        .gender-option label { cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9rem; color: var(--text-light); }
        .gender-option input { width: 20px; height: 20px; accent-color: var(--primary); }

        #authError { color: #ef4444; margin-top: 10px; font-size: 0.9rem; display: none; font-weight: 600; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 2rem; border-radius: 15px;
            width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
        }
        .close-btn { background: transparent; border: none; color: #999; margin-top: 10px; cursor: pointer; font-size: 0.9rem; }

        footer { background: #0f172a; color: #94a3b8; text-align: center; padding: 3rem 1rem; margin-top: 5rem; }

        @media(max-width: 600px) {
            header h1 { font-size: 2.5rem; }
            nav ul { display: none; }
            .hero-btn-group { flex-direction: column; width: 100%; }
            .cta-btn { width: 100%; text-align: center; }
            .auth-container { padding: 1.5rem; width: 95%; }
            #userDashboard { flex-direction: column; align-items: flex-start; gap: 10px; }
            .progress-container { width: 100%; margin: 0; }
        }
    </style>
</head>
<body>

    <!-- ================= 1. LOGIN SCREEN (VISIBLE BY DEFAULT) ================= -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-logo"><i class="fa-solid fa-dna"></i> IG-bio</div>
            <p class="auth-subtitle">The Ultimate IGCSE Biology Resource</p>
            
            <h2 id="authTitle" style="color:var(--text); margin-bottom:15px;">Sign In</h2>
            
            <input type="email" id="email" class="auth-input" placeholder="Email Address">
            
            <div id="signupExtras" style="display:none;">
                <input type="text" id="username" class="auth-input" placeholder="Username">
                <p style="text-align:left; font-size:0.9rem; color:var(--text-light); margin-top:10px;">Select Avatar:</p>
                <div class="gender-options">
                    <div class="gender-option">
                        <input type="radio" name="gender" value="male" id="g_male" checked>
                        <label for="g_male"><i class="fa-solid fa-user-tie" style="font-size:1.5rem; color:#2563eb;"></i> Male</label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" name="gender" value="female" id="g_female">
                        <label for="g_female"><i class="fa-solid fa-user-nurse" style="font-size:1.5rem; color:#ec4899;"></i> Female</label>
                    </div>
                </div>
            </div>
            
            <input type="password" id="password" class="auth-input" placeholder="Password">
            
            <button onclick="handleAuthAction()" class="cta-btn auth-btn" id="authActionBtn">Login</button>
            
            <p id="authError"></p>

            <p style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:var(--primary); text-decoration: underline;" onclick="toggleAuthMode()" id="authToggle">
                New here? Create an account
            </p>
        </div>
    </div>

    <!-- ================= 2. MAIN APPLICATION (HIDDEN BY DEFAULT) ================= -->
    <div id="main-app">
        
        <nav>
            <div style="font-weight:800; font-size:1.5rem; color:var(--primary);">IG-bio</div>
            <ul>
                <li><a href="#chapters"><i class="fa-solid fa-book"></i> <span>Chapters</span></a></li>
                <li><a href="#general-topics"><i class="fa-solid fa-layer-group"></i> <span>Topics</span></a></li>
                <li><a href="#edu-games"><i class="fa-solid fa-gamepad"></i> <span>Games</span></a></li>
            </ul>
            <div class="nav-profile-area">
                <img src="" id="topRightAvatar" class="profile-avatar" onclick="openProfileSettings()" alt="Profile" title="Click to Log Out">
            </div>
        </nav>
        
        <header>
            <div id="userDashboard">
                <div style="text-align: left;">
                    <h3 id="welcomeMsg" style="margin:0; color: var(--text);">Welcome!</h3>
                    <small style="color:#64748b;">Progress synced online.</small>
                </div>
                <div class="progress-container">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                        <span style="color: var(--text);">Course Progress</span>
                        <span id="progressText" style="color: var(--text);">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <div class="hero-content">
                <h1>Master Biology.</h1>
                <p>Access audio lectures, smart notes, and interactive quizzes for CIE 0610.</p>
                <div class="hero-btn-group">
                    <a href="#chapters" class="cta-btn"><i class="fa-solid fa-book"></i> Start Learning</a>
                    <a href="#edu-games" class="cta-btn btn-games"><i class="fa-solid fa-gamepad"></i> Play Games</a>
                </div>
            </div>
        </header>

        <div class="features">
            <div class="feature-card">
                <i class="fa-solid fa-headphones feature-icon"></i>
                <h3>Audio Lectures</h3>
                <p>Detailed explanations of complex concepts.</p>
            </div>
            <div class="feature-card" style="border-top-color: #10b981;">
                <i class="fa-solid fa-book-open feature-icon" style="color: #10b981;"></i>
                <h3>Smart Notes</h3>
                <p>Concise, bullet-pointed notes for revision.</p>
            </div>
            <div class="feature-card" style="border-top-color: #f59e0b;">
                <i class="fa-solid fa-sitemap feature-icon" style="color: #f59e0b;"></i>
                <h3>Mind Maps</h3>
                <p>Visual hierarchies to help memorize connections.</p>
            </div>
            <div class="feature-card" style="border-top-color: #ef4444;">
                <i class="fa-solid fa-clipboard-check feature-icon" style="color: #ef4444;"></i>
                <h3>Exam Quizzes</h3>
                <p>MCQ challenges with instant feedback.</p>
            </div>
        </div>

        <!-- CHAPTERS -->
        <section class="chapters-section" id="chapters">
            <div class="section-header">
                <h2>Course Content</h2>
                <p>Select a chapter to begin your mastery.</p>
            </div>

            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" class="search-bar" placeholder="Search chapters..." onkeyup="filterChapters()">
            </div>

            <div class="chapter-grid" id="grid">
                
                <!-- 1 -->
                <div onclick="openContent('1.Classification of Living Organisms .html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch1" onclick="toggleProgress(event, 'ch1')">
                    <div class="chapter-num">Chapter 1</div>
                    <div class="chapter-title">Characteristics of Living Organisms</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 2 -->
                <div onclick="openContent('2.Organisation of the organisms.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch2" onclick="toggleProgress(event, 'ch2')">
                    <div class="chapter-num">Chapter 2</div>
                    <div class="chapter-title">Organization of the Organism</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 3 -->
                <div onclick="openContent('3.Movements in & out of cells.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch3" onclick="toggleProgress(event, 'ch3')">
                    <div class="chapter-num">Chapter 3</div>
                    <div class="chapter-title">Movement In & Out of Cells</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 4 -->
                <div onclick="openContent('4.Biological Molecules.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch4" onclick="toggleProgress(event, 'ch4')">
                    <div class="chapter-num">Chapter 4</div>
                    <div class="chapter-title">Biological Molecules</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 5 -->
                <div onclick="openContent('5.Enzymes.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch5" onclick="toggleProgress(event, 'ch5')">
                    <div class="chapter-num">Chapter 5</div>
                    <div class="chapter-title">Enzymes</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 6 -->
                <div onclick="openContent('6.Plant Nutrition.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch6" onclick="toggleProgress(event, 'ch6')">
                    <div class="chapter-num">Chapter 6</div>
                    <div class="chapter-title">Plant Nutrition</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 7 -->
                <div onclick="openContent('7.Human Nutrition.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch7" onclick="toggleProgress(event, 'ch7')">
                    <div class="chapter-num">Chapter 7</div>
                    <div class="chapter-title">Human Nutrition</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 8 -->
                <div onclick="openContent('8.Transport in Plants.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch8" onclick="toggleProgress(event, 'ch8')">
                    <div class="chapter-num">Chapter 8</div>
                    <div class="chapter-title">Transport in Plants</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 9 -->
                <div onclick="openContent('9.Transport in humans.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch9" onclick="toggleProgress(event, 'ch9')">
                    <div class="chapter-num">Chapter 9</div>
                    <div class="chapter-title">Transport in Animals</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 10 -->
                <div onclick="openContent('10.Disease and Immunity.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch10" onclick="toggleProgress(event, 'ch10')">
                    <div class="chapter-num">Chapter 10</div>
                    <div class="chapter-title">Diseases and Immunity</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 11 -->
                <div onclick="openContent('11.Respiration and Gas Exchange.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch11" onclick="toggleProgress(event, 'ch11')">
                    <div class="chapter-num">Chapter 11</div>
                    <div class="chapter-title">Gas Exchange and Respiration</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 12 -->
                <div onclick="openContent('12.Coordination and Response.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch12" onclick="toggleProgress(event, 'ch12')">
                    <div class="chapter-num">Chapter 12</div>
                    <div class="chapter-title">Coordination and Response</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 13 -->
                <div onclick="openContent('13.Excretion And Homeostasis.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch13" onclick="toggleProgress(event, 'ch13')">
                    <div class="chapter-num">Chapter 13</div>
                    <div class="chapter-title">Excretion And Homeostasis</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 14 -->
                <div onclick="openContent('14.Reproduction In Plants.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch14" onclick="toggleProgress(event, 'ch14')">
                    <div class="chapter-num">Chapter 14</div>
                    <div class="chapter-title">Reproduction In Plants</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 15 -->
                <div onclick="openContent('15.Reproduction In Humans.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch15" onclick="toggleProgress(event, 'ch15')">
                    <div class="chapter-num">Chapter 15</div>
                    <div class="chapter-title">Reproduction In Humans</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 16 -->
                <div onclick="openContent('16.Chromosomes, Genes and Proteins.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch16" onclick="toggleProgress(event, 'ch16')">
                    <div class="chapter-num">Chapter 16</div>
                    <div class="chapter-title">Chromosomes, Genes and Proteins</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 17 -->
                <div onclick="openContent('17.Variation and Selection.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch17" onclick="toggleProgress(event, 'ch17')">
                    <div class="chapter-num">Chapter 17</div>
                    <div class="chapter-title">Variation and Selection</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 18 -->
                <div onclick="openContent('18.Organisms and their Environment.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch18" onclick="toggleProgress(event, 'ch18')">
                    <div class="chapter-num">Chapter 18</div>
                    <div class="chapter-title">Organisms and their Environment</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 19 -->
                <div onclick="openContent('19.Human Influences on Ecosystems.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch19" onclick="toggleProgress(event, 'ch19')">
                    <div class="chapter-num">Chapter 19</div>
                    <div class="chapter-title">Human Influences on Ecosystems</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <!-- 20 -->
                <div onclick="openContent('20.Biotechnology & Genetic Modification.html')" class="chapter-card">
                    <input type="checkbox" class="progress-check" id="ch20" onclick="toggleProgress(event, 'ch20')">
                    <div class="chapter-num">Chapter 20</div>
                    <div class="chapter-title">Biotechnology & Genetic Modification</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            
            </div>
        </section>

        <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;"><hr style="border: 0; height: 1px; background: #e2e8f0; margin: 4rem 0;"></div>

        <!-- GENERAL TOPICS -->
        <section class="chapters-section" id="general-topics">
            <div class="section-header">
                <h2>General Topics</h2>
                <p>Additional resources and broader biological concepts.</p>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="topicSearchInput" class="search-bar" placeholder="Search general topics..." onkeyup="filterTopics()">
            </div>
            <div class="chapter-grid" id="topicGrid">
                <div onclick="openContent('specialised cells.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Specialised Cells</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div onclick="openContent('smoking.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Smoking</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div onclick="openContent('CHD.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">CHD</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div onclick="openContent('Blood.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Blood</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                <div onclick="openContent('defense.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Defense Against Diseases</div>
                    <div class="chapter-icon"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            </div>
        </section>

        <!-- EDU-GAMES -->
        <section class="chapters-section" id="edu-games">
            <div class="section-header">
                <h2>Edu-Games</h2>
                <p>Interactive simulations to master complex topics.</p>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="gameSearchInput" class="search-bar" placeholder="Search games..." onkeyup="filterGames()">
            </div>
            <div class="chapter-grid" id="gameGrid">
                <div onclick="openContent('game1.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Classification Game</div>
                    <div class="chapter-icon"><i class="fa-solid fa-gamepad"></i></div>
                </div>
                <div onclick="openContent('game2.html')" class="chapter-card">
                    <div class="chapter-title" style="margin: auto;">Organisation Game</div>
                    <div class="chapter-icon"><i class="fa-solid fa-gamepad"></i></div>
                </div>
            </div>
        </section>

        <footer>
            <p>© 2026 IG-bio. Designed for CIE IGCSE Syllabus 0610.</p>
        </footer>
    </div>

    <!-- ================= PROFILE SETTINGS MODAL ================= -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <img src="" id="profileModalAvatar" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary); margin-bottom:15px;">
            <h2 id="profileUsername" style="color:var(--primary-dark); margin-bottom:5px;">User</h2>
            <p style="font-size:0.9rem; color:var(--text-light); margin-bottom:20px;">Security Settings</p>
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="font-size:0.8rem; font-weight:bold;">Current Password</label>
                <input type="password" id="currentPassInput" class="auth-input" placeholder="••••••">
            </div>
            <div style="text-align: left; margin-bottom: 20px;">
                <label style="font-size:0.8rem; font-weight:bold;">New Password</label>
                <input type="password" id="newPassInput" class="auth-input" placeholder="Enter new password">
            </div>
            <button onclick="attemptPasswordChange()" class="cta-btn" style="width:100%; background:var(--success);">Update Password</button>
            <button onclick="logout()" class="cta-btn" style="width:100%; margin-top:10px; background:#ef4444;">Log Out</button>
            <button onclick="document.getElementById('profileModal').style.display='none'" class="close-btn">Close</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBOkZSP6ZMvdoZ8QAt0e8iRxzFa1-lRNnk",
          authDomain: "ig-bio-f9d8f.firebaseapp.com",
          projectId: "ig-bio-f9d8f",
          storageBucket: "ig-bio-f9d8f.firebasestorage.app",
          messagingSenderId: "630166010132",
          appId: "1:630166010132:web:72f335cf0f012b85bb6a01"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            const MALE_AVATAR = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
            const FEMALE_AVATAR = "https://cdn-icons-png.flaticon.com/512/4128/4128253.png";
            let currentUser = null;
            let isSignupMode = false;

            // *** THE NUCLEAR OPTION: FORCE SIGN OUT ON PAGE LOAD ***
            auth.signOut().then(() => {
                // After signing out, disable persistence completely
                return auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
            });

            // ===========================================================
            // CORE AUTH LISTENER
            // ===========================================================
            auth.onAuthStateChanged(async (user) => {
                const authScreen = document.getElementById('auth-screen');
                const mainApp = document.getElementById('main-app');

                if (user) {
                    // LOGIN SUCCESS: Hide login, show app
                    currentUser = user;
                    const doc = await db.collection('users').doc(user.uid).get();
                    if(doc.exists) {
                        const data = doc.data();
                        updateUI(data);
                        loadProgress(data.progress || []);
                    }
                    authScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                } else {
                    // LOGIN REQUIRED: Show login, hide app
                    currentUser = null;
                    authScreen.style.display = 'flex';
                    mainApp.style.display = 'none';
                    
                    // Clean up UI elements
                    document.querySelectorAll('.progress-check').forEach(c => c.checked = false);
                    document.getElementById('progressFill').style.width = "0%";
                    document.getElementById('progressText').innerText = "0%";
                }
            });

            window.toggleAuthMode = function() {
                isSignupMode = !isSignupMode;
                document.getElementById('authTitle').innerText = isSignupMode ? "Create Account" : "Sign In";
                document.getElementById('authActionBtn').innerText = isSignupMode ? "Sign Up" : "Login";
                document.getElementById('authToggle').innerText = isSignupMode ? "Have account? Login" : "New here? Create an account";
                document.getElementById('signupExtras').style.display = isSignupMode ? "block" : "none";
                document.getElementById('authError').style.display = 'none';
            }

            window.handleAuthAction = async function() {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                const errorTxt = document.getElementById('authError');
                
                if(!email || !pass) {
                    errorTxt.innerText = "Please fill in all fields.";
                    errorTxt.style.display = 'block';
                    return;
                }

                errorTxt.style.display = 'none';
                const btn = document.getElementById('authActionBtn');
                btn.innerText = "Processing...";

                try {
                    if(isSignupMode) {
                        const cred = await auth.createUserWithEmailAndPassword(email, pass);
                        const username = document.getElementById('username').value || "Student";
                        const gender = document.querySelector('input[name="gender"]:checked').value;
                        
                        await db.collection('users').doc(cred.user.uid).set({
                            username: username,
                            gender: gender,
                            progress: []
                        });
                    } else {
                        await auth.signInWithEmailAndPassword(email, pass);
                    }
                } catch (err) {
                    errorTxt.innerText = err.message.replace("Firebase: ", "");
                    errorTxt.style.display = 'block';
                    btn.innerText = isSignupMode ? "Sign Up" : "Login";
                }
            }

            window.logout = function() { 
                auth.signOut(); 
                window.location.reload(); // Force reload to ensure clean state
            }

            window.updateUI = function(data) {
                const imgUrl = (data.gender === 'female') ? FEMALE_AVATAR : MALE_AVATAR;
                document.getElementById('topRightAvatar').src = imgUrl;
                document.getElementById('welcomeMsg').innerText = `Welcome, ${data.username}!`;
                document.getElementById('profileModalAvatar').src = imgUrl;
                document.getElementById('profileUsername').innerText = data.username;
            }

            window.openProfileSettings = function() {
                document.getElementById('currentPassInput').value = "";
                document.getElementById('newPassInput').value = "";
                document.getElementById('profileModal').style.display = 'flex';
            }

            window.attemptPasswordChange = async function() {
                const oldPass = document.getElementById('currentPassInput').value;
                const newPass = document.getElementById('newPassInput').value;
                if(!oldPass || !newPass) { alert("Please fill in all fields."); return; }
                
                const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, oldPass);
                try {
                    await currentUser.reauthenticateWithCredential(cred);
                    await currentUser.updatePassword(newPass);
                    alert("Password updated successfully!");
                    document.getElementById('profileModal').style.display = 'none';
                } catch (err) { alert("Error: Incorrect current password."); }
            }

            window.openContent = function(url) {
                if (currentUser) {
                    window.location.href = url; 
                } else {
                    alert("Authentication error. Please reload.");
                }
            }

            window.toggleProgress = async function(event, id) {
                event.stopPropagation();
                const checkbox = document.getElementById(id);
                
                if(!currentUser) return;

                const userRef = db.collection('users').doc(currentUser.uid);
                if(checkbox.checked) {
                    await userRef.update({ progress: firebase.firestore.FieldValue.arrayUnion(id) });
                } else {
                    await userRef.update({ progress: firebase.firestore.FieldValue.arrayRemove(id) });
                }
                updateProgressBar();
            }

            window.loadProgress = function(progressArray) {
                progressArray.forEach(id => {
                    const box = document.getElementById(id);
                    if(box) box.checked = true;
                });
                updateProgressBar();
            }

            window.updateProgressBar = function() {
                const total = document.querySelectorAll('.progress-check').length;
                const checked = document.querySelectorAll('.progress-check:checked').length;
                const pct = total === 0 ? 0 : Math.round((checked / total) * 100);
                document.getElementById('progressFill').style.width = pct + "%";
                document.getElementById('progressText').innerText = pct + "%";
            }

            window.filterChapters = function() {
                const input = document.getElementById('searchInput').value.toUpperCase();
                document.querySelectorAll('#grid .chapter-card').forEach(card => {
                    card.style.display = card.innerText.toUpperCase().indexOf(input) > -1 ? "flex" : "none";
                });
            }
            window.filterTopics = function() {
                const input = document.getElementById('topicSearchInput').value.toUpperCase();
                document.querySelectorAll('#topicGrid .chapter-card').forEach(card => {
                    card.style.display = card.innerText.toUpperCase().indexOf(input) > -1 ? "flex" : "none";
                });
            }
            window.filterGames = function() {
                const input = document.getElementById('gameSearchInput').value.toUpperCase();
                document.querySelectorAll('#gameGrid .chapter-card').forEach(card => {
                    card.style.display = card.innerText.toUpperCase().indexOf(input) > -1 ? "flex" : "none";
                });
            }

        } catch (e) {
            console.error("Firebase Init Error", e);
        }
    </script>
</body>
</html>
