<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioBot - CIE 0610 Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-green-600 text-white p-4 shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">üß¨ BioBot CIE 0610</h1>
            <p class="text-xs text-green-100">IGCSE Biology Specialist</p>
        </div>
        <a href="/" class="text-sm bg-green-700 px-3 py-1 rounded hover:bg-green-800 transition">Back to Home</a>
    </header>

    <!-- Chat Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex flex-col space-y-2 max-w-3xl mx-auto">
            <div class="flex items-start">
                <div class="bg-green-100 text-green-900 p-3 rounded-lg rounded-tl-none shadow-sm border border-green-200 max-w-[85%]">
                    <p><strong>System Ready.</strong> I am trained on the Cambridge IGCSE Biology (0610) syllabus.</p>
                    <p class="mt-2 text-sm">Ask me anything about Biology!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="p-4 bg-white border-t border-gray-200">
        <div class="max-w-3xl mx-auto flex gap-2">
            <input type="text" id="user-input" 
                class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500"
                placeholder="Ask a biology question..." 
                onkeydown="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" 
                class="bg-green-600 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center hover:bg-green-700 transition">
                ‚û§
            </button>
        </div>
    </footer>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        // ‚¨áÔ∏è PASTE YOUR *PERSONAL GMAIL* KEY HERE ‚¨áÔ∏è
        let API_KEY = "AIzaSyAQoHG6eI3vYdznWrhmLkBvaME0_UPA1Gs"; 
        
        API_KEY = API_KEY.trim(); // Removes spaces

        const SYSTEM_PROMPT = `
        You are an expert IGCSE Biology Tutor for CIE 0610. 
        1. Only answer biology questions. 
        2. Keep answers concise and suitable for IGCSE level students.
        3. If the user asks for an image/diagram, reply ONLY with: "GENERATE_IMAGE: [description]".
        `;

        // ==========================================
        // LOGIC
        // ==========================================
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            const loadingId = addLoading();

            try {
                // Using v1 (Stable) endpoint instead of v1beta
                // Using gemini-1.5-flash as it is the most reliable free model
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: SYSTEM_PROMPT + "\n\nQuestion: " + text }] }]
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (!response.ok) {
                    // This helps debugging directly in the chat
                    let errorMsg = data.error ? data.error.message : "Unknown Error";
                    addMessage(`‚ö†Ô∏è Google Error: ${errorMsg}. (Tip: If it says 'Model not found', use a Personal Gmail Key)`, 'bot');
                    return;
                }

                const botText = data.candidates[0].content.parts[0].text;

                if (botText.includes("GENERATE_IMAGE:")) {
                    const imagePrompt = botText.replace("GENERATE_IMAGE:", "").trim();
                    addImage(imagePrompt);
                } else {
                    addMessage(botText, 'bot');
                }

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addMessage("Connection Error. Please check your internet.", 'bot');
                console.error(error);
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'user' ? "flex justify-end" : "flex justify-start";
            
            const bubble = document.createElement('div');
            bubble.className = sender === 'user' 
                ? "bg-green-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%]" 
                : "bg-white text-gray-800 p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 max-w-[85%] prose prose-sm";
            
            if (sender === 'bot') bubble.innerHTML = marked.parse(text);
            else bubble.textContent = text;

            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addImage(prompt) {
            const div = document.createElement('div');
            div.className = "flex justify-start";
            
            const container = document.createElement('div');
            container.className = "bg-white p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 max-w-[85%]";
            
            const caption = document.createElement('p');
            caption.className = "text-xs text-gray-500 mb-2 font-bold";
            caption.textContent = "üß¨ Generated Diagram: " + prompt;

            const img = document.createElement('img');
            const safePrompt = encodeURIComponent(prompt + " biology diagram scientific white background clean lines illustration");
            img.src = `https://image.pollinations.ai/prompt/${safePrompt}`;
            img.className = "rounded-md w-full h-auto min-h-[200px] bg-gray-50";
            
            container.appendChild(caption);
            container.appendChild(img);
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex justify-start";
            div.innerHTML = `<div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm border border-gray-200 flex space-x-1"><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
