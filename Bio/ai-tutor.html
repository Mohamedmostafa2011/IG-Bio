<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG-Bio GPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000;
            background-image: linear-gradient(135deg, #0f0f0f 0%, #000 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(30, 30, 30, 0.4);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar { width: 0px; } 

        .prose h1, .prose h2 { color: white; font-weight: 700; margin-top: 1.2em; }
        .prose strong { color: #fff; font-weight: 800; }
        .prose ul { list-style-type: disc; color: #bbb; padding-left: 1rem; }
        .prose p { color: #ccc; line-height: 1.6; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        
        .typing-dot { width: 6px; height: 6px; background: white; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    </style>
</head>
<body class="flex flex-col relative">

    <!-- HEADER -->
    <header class="glass-panel z-50 h-20 flex justify-between items-center px-6 absolute top-0 w-full rounded-b-3xl">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center font-bold text-xl">
                <i class="fa-solid fa-dna"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">IG-Bio GPT</h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">CIE 0610 Expert</p>
            </div>
        </div>
        <a href="/" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
            <i class="fa-solid fa-xmark text-white"></i>
        </a>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-24 pb-48 px-4 sm:px-6 space-y-6">
        <!-- New Welcome Message -->
        <div class="flex justify-start w-full msg-anim">
            <div class="glass-panel p-6 rounded-[2rem] rounded-tl-none max-w-2xl">
                <h3 class="font-bold text-xl mb-2">Hello, Student.</h3>
                <p class="text-gray-400">I am <strong>IG-Bio GPT</strong>. I am trained specifically on the Cambridge 0610 syllabus.</p>
                <p class="text-gray-500 text-sm mt-2">Ask me to explain a concept, compare structures, or provide exam tips.</p>
            </div>
        </div>
    </main>

    <!-- INPUT AREA -->
    <footer class="absolute bottom-0 w-full z-50">
        <div class="bg-black/80 backdrop-blur-xl border-t border-white/10 p-4 pb-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <div class="max-w-4xl mx-auto flex items-end gap-3">
                
                <!-- Text Input -->
                <textarea id="user-input" rows="1" 
                    class="flex-1 bg-white/5 border border-white/10 rounded-3xl focus:ring-1 focus:ring-white/30 focus:outline-none text-white placeholder-gray-500 text-lg py-3 px-5 resize-none max-h-32 transition-all"
                    placeholder="Ask a biology question..."
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleAction(); }"></textarea>

                <!-- Action Button (Send or Stop) -->
                <button id="action-btn" onclick="handleAction()" class="w-12 h-12 bg-white text-black rounded-full hover:bg-gray-200 transition flex items-center justify-center shrink-0 shadow-lg shadow-white/10">
                    <i id="action-icon" class="fa-solid fa-arrow-up text-lg"></i>
                </button>
            </div>
        </div>
    </footer>

    <script>
        // CONFIG
        const BASE_URL = "https://ig-bio.vercel.app";
        const CHAPTER_MAP = {
            "cell": "cells", "movement": "diffusion", "enzyme": "enzymes",
            "plant": "plant-nutrition", "human nutrition": "human-nutrition",
            "heart": "transport", "disease": "diseases", "respiration": "respiration",
            "kidney": "excretion", "eye": "coordination", "hormone": "hormones",
            "drug": "drugs", "reproduction": "reproduction", "dna": "inheritance",
            "ecosystem": "ecology"
        };

        const SYSTEM_PROMPT = `
        ACT AS: An Expert Cambridge IGCSE Biology (0610) Tutor named IG-Bio GPT.
        RULES:
        1. Answer strictly based on Biology.
        2. Answers must be DETAILED (Structure, Function, Mechanism).
        3. Use Bullet points and Bold text.
        4. NEVER output JSON, code blocks, or debug data. Output only the final explanation.
        `;

        // STATE VARIABLES
        let abortController = null; // Controls the API request
        let isGenerating = false;   // Tracks if AI is busy

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const actionBtn = document.getElementById('action-btn');
        const actionIcon = document.getElementById('action-icon');

        // ==========================================
        // MAIN ACTION HANDLER (Switch between Send & Stop)
        // ==========================================
        function handleAction() {
            if (isGenerating) {
                stopGeneration();
            } else {
                sendMessage();
            }
        }

        // ==========================================
        // STOP LOGIC
        // ==========================================
        function stopGeneration() {
            if (abortController) {
                abortController.abort(); // Kills the fetch request
                abortController = null;
            }
            
            // Remove the loading bubble
            const loader = document.getElementById('current-loading');
            if (loader) loader.remove();

            // Reset UI
            isGenerating = false;
            updateButtonStyle(false);
            userInput.focus();
        }

        // ==========================================
        // SEND LOGIC
        // ==========================================
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Set UI to "Generating" State
            isGenerating = true;
            updateButtonStyle(true);
            
            // Create Loading Bubble
            const loadingId = addLoading("Thinking...");

            // Create new AbortController for this specific request
            abortController = new AbortController();
            const signal = abortController.signal;

            try {
                const fullPrompt = SYSTEM_PROMPT + "\nUser Question: " + text;
                const seed = Math.floor(Math.random() * 99999);
                const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}?model=openai&seed=${seed}`;

                // Fetch with signal (allows aborting)
                const response = await fetch(url, { signal });
                let botText = await response.text();
                
                // Clean up loading UI
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                // Clean Text
                botText = botText.replace(/\{"role":[\s\S]*?\}/g, ""); 
                botText = botText.replace(/reasoning_content/g, "");
                botText = botText.replace(/^"|"$/g, "");
                
                addBotMessage(botText);
                generateSmartLinks(text + " " + botText);

            } catch (error) {
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                // If error is "AbortError", it means user clicked stop. Don't show error message.
                if (error.name === 'AbortError') {
                    console.log("Generation stopped by user.");
                } else {
                    addBotMessage("Network error. Please try again.");
                }
            } finally {
                // Reset UI to "Ready" State
                isGenerating = false;
                updateButtonStyle(false);
                abortController = null;
            }
        }

        // Updates button icon (Arrow vs Stop Square)
        function updateButtonStyle(generating) {
            if (generating) {
                actionIcon.classList.remove('fa-arrow-up');
                actionIcon.classList.add('fa-stop'); // Square icon
                actionBtn.classList.replace('bg-white', 'bg-red-500'); // Optional: Red color for stop
                actionBtn.classList.replace('text-black', 'text-white');
            } else {
                actionIcon.classList.remove('fa-stop');
                actionIcon.classList.add('fa-arrow-up');
                actionBtn.classList.replace('bg-red-500', 'bg-white');
                actionBtn.classList.replace('text-white', 'text-black');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex w-full msg-anim ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            if (sender === 'user') {
                bubble.className = "flex flex-col items-end gap-2 max-w-[85%]";
                if (text) {
                    const txtDiv = document.createElement('div');
                    txtDiv.className = "bg-white text-black px-5 py-3 rounded-[1.5rem] rounded-tr-sm font-medium shadow-lg";
                    txtDiv.textContent = text;
                    bubble.appendChild(txtDiv);
                }
            }
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(text) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-start msg-anim";
            const container = document.createElement('div');
            container.className = "glass-panel p-6 rounded-[2rem] rounded-tl-sm max-w-3xl w-full border border-white/5";
            
            const content = document.createElement('div');
            content.className = "prose prose-invert max-w-none"; 
            content.innerHTML = marked.parse(text);
            container.appendChild(content);

            const btnBar = document.createElement('div');
            btnBar.className = "mt-6 pt-4 border-t border-white/10 flex justify-end";
            
            const pdfBtn = document.createElement('button');
            pdfBtn.className = "text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white border border-white/10 px-4 py-2 rounded-full hover:bg-white/10 transition flex items-center gap-2";
            pdfBtn.innerHTML = '<i class="fa-solid fa-file-arrow-down"></i> Save as PDF';
            
            pdfBtn.onclick = () => {
                const clone = content.cloneNode(true);
                const pdfContainer = document.createElement('div');
                pdfContainer.style.background = 'white';
                pdfContainer.style.color = '#1a1a1a';
                pdfContainer.style.padding = '40px';
                pdfContainer.style.fontFamily = 'Helvetica, Arial, sans-serif';
                
                const allText = clone.querySelectorAll('*');
                allText.forEach(el => { el.style.color = '#1a1a1a'; el.style.textShadow = 'none'; });
                
                pdfContainer.appendChild(clone);
                
                const opt = {
                    margin: 0.5,
                    filename: 'BioBot_Notes.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(pdfContainer).save();
            };
            
            btnBar.appendChild(pdfBtn);
            container.appendChild(btnBar);
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function generateSmartLinks(contextText) {
            contextText = contextText.toLowerCase();
            const linksDiv = document.createElement('div');
            linksDiv.className = "flex flex-wrap gap-3 ml-0 mt-4 animate-pulse justify-end";
            let found = false;

            for (const [key, slug] of Object.entries(CHAPTER_MAP)) {
                if (contextText.includes(key)) {
                    found = true;
                    const btn1 = document.createElement('a');
                    btn1.href = `${BASE_URL}/#${slug}`; 
                    btn1.target = "_blank";
                    btn1.className = "glass-panel px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition flex items-center gap-2 text-white no-underline";
                    btn1.innerHTML = `<i class="fa-solid fa-globe"></i> IG-Bio`;
                    linksDiv.appendChild(btn1);
                    break; 
                }
            }
            if (found) {
                const lastMsg = chatContainer.lastElementChild.querySelector('.glass-panel');
                if(lastMsg) lastMsg.appendChild(linksDiv);
                scrollToBottom();
            }
        }

        function addLoading(text) {
            const id = 'current-loading'; 
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex w-full justify-start mt-2";
            div.innerHTML = `<div class="glass-panel px-4 py-3 rounded-full flex gap-2 items-center"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> <span class="text-xs text-gray-400 ml-2 uppercase tracking-wider">${text}</span></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
