<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioBot - CIE 0610 Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-green-600 text-white p-4 shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">ðŸ§¬ BioBot CIE 0610</h1>
            <p class="text-xs text-green-100">IGCSE Biology Specialist</p>
        </div>
        <a href="/" class="text-sm bg-green-700 px-3 py-1 rounded hover:bg-green-800 transition">Back to Home</a>
    </header>

    <!-- Chat Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex flex-col space-y-2 max-w-3xl mx-auto">
            <div class="flex items-start">
                <div class="bg-green-100 text-green-900 p-3 rounded-lg rounded-tl-none shadow-sm border border-green-200 max-w-[85%]">
                    <p><strong>System Ready.</strong> I am trained on the Cambridge IGCSE Biology (0610) syllabus.</p>
                    <p class="mt-2 text-sm">Ask me anything about Biology, or ask for a diagram!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="p-4 bg-white border-t border-gray-200">
        <div class="max-w-3xl mx-auto flex gap-2">
            <input type="text" id="user-input" 
                class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500"
                placeholder="Ask a biology question..." 
                onkeydown="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" 
                class="bg-green-600 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center hover:bg-green-700 transition">
                âž¤
            </button>
        </div>
    </footer>

    <script>
        // ==========================================
        // CONFIGURATION (NO KEY NEEDED!)
        // ==========================================
        
        const SYSTEM_PROMPT = `
        You are an expert IGCSE Biology Tutor for CIE 0610. 
        Your rules:
        1. Only answer biology questions. 
        2. Keep answers concise and suitable for IGCSE students.
        3. If the user explicitly asks for an image, diagram, or drawing, reply ONLY with: "GENERATE_IMAGE: [description]".
        4. Do not include markdown bolding like **this**, just plain text.
        `;

        // ==========================================
        // LOGIC
        // ==========================================
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            const loadingId = addLoading();

            try {
                // Combine system prompt and user question
                const fullPrompt = `${SYSTEM_PROMPT}\n\nUser Question: ${text}`;
                
                // Using Pollinations.ai Text API (Free, No Key)
                // We generate a random seed to make the cache fresh every time
                const randomSeed = Math.floor(Math.random() * 1000000);
                const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}?seed=${randomSeed}&model=openai`;

                const response = await fetch(url);
                
                if (!response.ok) throw new Error("Pollinations API Error");

                const botText = await response.text();
                
                document.getElementById(loadingId).remove();

                // Check for Image command
                if (botText.includes("GENERATE_IMAGE:")) {
                    const imagePrompt = botText.replace("GENERATE_IMAGE:", "").trim();
                    addImage(imagePrompt);
                } else {
                    addMessage(botText, 'bot');
                }

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addMessage("Sorry, the AI is taking a nap. Please try again.", 'bot');
                console.error(error);
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'user' ? "flex justify-end" : "flex justify-start";
            
            const bubble = document.createElement('div');
            bubble.className = sender === 'user' 
                ? "bg-green-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%]" 
                : "bg-white text-gray-800 p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 max-w-[85%] prose prose-sm";
            
            // Basic markdown parsing
            if (sender === 'bot') {
                bubble.innerHTML = marked.parse(text);
            } else {
                bubble.textContent = text;
            }

            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addImage(prompt) {
            const div = document.createElement('div');
            div.className = "flex justify-start";
            
            const container = document.createElement('div');
            container.className = "bg-white p-3 rounded-lg rounded-tl-none shadow-sm border border-gray-200 max-w-[85%]";
            
            const caption = document.createElement('p');
            caption.className = "text-xs text-gray-500 mb-2 font-bold";
            caption.textContent = "ðŸ§¬ Generated Diagram: " + prompt;

            const img = document.createElement('img');
            // Pollinations Image API
            const safePrompt = encodeURIComponent(prompt + " biology diagram scientific white background clean lines illustration");
            img.src = `https://image.pollinations.ai/prompt/${safePrompt}`;
            img.className = "rounded-md w-full h-auto min-h-[200px] bg-gray-50";
            
            container.appendChild(caption);
            container.appendChild(img);
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex justify-start";
            div.innerHTML = `<div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm border border-gray-200 flex space-x-1"><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
