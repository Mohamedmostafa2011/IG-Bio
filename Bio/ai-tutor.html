<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioBot Noir</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown & PDF -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* GLASS EFFECT */
        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* TYPOGRAPHY */
        .prose h1, .prose h2, .prose h3 { color: white; font-weight: 800; margin-top: 1.5em; }
        .prose strong { color: white; border-bottom: 1px solid #444; }
        .prose ul { list-style-type: square; color: #888; }
        .prose p { color: #bbb; line-height: 1.8; }

        /* ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: slideUp 0.4s ease-out forwards; }
        
        .typing-dot { width: 5px; height: 5px; background: white; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body class="flex flex-col relative">

    <!-- HEADER -->
    <header class="glass-panel z-50 h-16 flex justify-between items-center px-6 absolute top-0 w-full">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white text-black rounded flex items-center justify-center font-bold">IO</div>
            <h1 class="font-bold tracking-widest text-sm">BIO<span class="opacity-50">BOT</span></h1>
        </div>
        <a href="/" class="text-xs font-bold uppercase tracking-widest border border-white/20 px-4 py-2 rounded hover:bg-white hover:text-black transition">Exit</a>
    </header>

    <!-- CHAT AREA -->
    <!-- Added pb-48 (padding-bottom: 12rem) to ensure buttons are never hidden -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-64 px-4 sm:px-8 space-y-8 scroll-smooth">
        <div class="flex justify-start w-full msg-anim">
            <div class="glass-panel p-6 rounded-lg max-w-2xl border-l-2 border-white">
                <h3 class="font-bold text-lg mb-2">System Online.</h3>
                <p class="text-gray-400 text-sm">I am trained on CIE 0610. Ask me for definitions, explanations, or diagrams.</p>
            </div>
        </div>
    </main>

    <!-- INPUT AREA (FIXED BOTTOM) -->
    <footer class="absolute bottom-0 w-full p-4 z-50 bg-gradient-to-t from-black via-black to-transparent pt-10">
        <div class="max-w-4xl mx-auto glass-panel rounded-2xl p-2 flex items-end gap-2 shadow-2xl bg-black/80">
            
            <button onclick="document.getElementById('file-upload').click()" class="w-12 h-12 rounded-xl hover:bg-white/10 text-gray-400 transition flex items-center justify-center">
                <i class="fa-solid fa-paperclip"></i>
            </button>
            <input type="file" id="file-upload" class="hidden" onchange="handleFile(this)">
            
            <button onclick="requestImage()" class="w-12 h-12 rounded-xl hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center" title="Generate Diagram">
                <i class="fa-solid fa-pen-nib"></i>
            </button>

            <textarea id="user-input" rows="1" 
                class="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-gray-600 text-lg py-3 px-2 resize-none max-h-32"
                placeholder="Ask a biology question..."
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>

            <button onclick="sendMessage()" class="w-12 h-12 bg-white text-black rounded-xl hover:bg-gray-200 transition flex items-center justify-center mb-0.5">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </footer>

    <script>
        // ==========================================
        // 1. LINKING CONFIGURATION
        // ==========================================
        const BASE_URL = "https://ig-bio.vercel.app";
        
        // This maps a topic keyword to a specific Hash/ID on your website.
        // Example: If user asks about "Eye", button goes to ig-bio.vercel.app/#eye
        const CHAPTER_MAP = {
            "cell": "cells",
            "movement": "diffusion",
            "enzyme": "enzymes",
            "plant": "plant-nutrition",
            "human nutrition": "human-nutrition",
            "heart": "transport",
            "disease": "diseases",
            "respiration": "respiration",
            "kidney": "excretion",
            "eye": "coordination",
            "hormone": "hormones",
            "drug": "drugs",
            "reproduction": "reproduction",
            "dna": "inheritance",
            "ecosystem": "ecology"
        };

        const SYSTEM_PROMPT = `
        ACT AS: A strict Cambridge IGCSE Biology (0610) Professor.
        OUTPUT RULES:
        1. Use Markdown. Bold Keywords.
        2. Answers must be LONG (200+ words). Structure: Definition -> Mechanism -> Exam Tip.
        3. If asked for image/diagram: Return ONLY "GENERATE_IMAGE: [scientific description]".
        `;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';
            userInput.style.height = 'auto';
            const loadingId = addLoading();

            try {
                const fullPrompt = SYSTEM_PROMPT + "\n\nQuestion: " + text;
                const seed = Math.floor(Math.random() * 99999);
                const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}?model=openai&seed=${seed}`;

                const response = await fetch(url);
                const botText = await response.text();
                
                document.getElementById(loadingId).remove();

                if (botText.includes("GENERATE_IMAGE:")) {
                    const imgPrompt = botText.replace("GENERATE_IMAGE:", "").trim();
                    addBotMessage("Generating schematic...", true);
                    addImage(imgPrompt);
                } else {
                    addBotMessage(botText);
                    // Generate links based on the User's Question + Bot's Answer
                    generateSmartLinks(text + " " + botText);
                }

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addBotMessage("Network Error. Retrying...");
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex w-full msg-anim ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            if (sender === 'user') {
                bubble.className = "bg-white text-black px-5 py-3 rounded-2xl rounded-tr-none max-w-[85%] font-medium";
                bubble.textContent = text;
            }
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(text, isTemp = false) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-start msg-anim";
            const container = document.createElement('div');
            container.className = "glass-panel p-6 rounded-2xl rounded-tl-none max-w-3xl w-full border border-white/10";
            
            const content = document.createElement('div');
            content.className = "prose prose-invert max-w-none"; 
            content.innerHTML = marked.parse(text);
            container.appendChild(content);

            if (!isTemp) {
                const btnBar = document.createElement('div');
                btnBar.className = "mt-6 pt-4 border-t border-white/10 flex justify-end";
                const pdfBtn = document.createElement('button');
                pdfBtn.className = "text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white border border-white/10 px-4 py-2 rounded hover:bg-white/5 transition flex items-center gap-2";
                pdfBtn.innerHTML = '<i class="fa-solid fa-download"></i> PDF';
                pdfBtn.onclick = () => {
                    html2pdf().from(content).save('Biology_Explanation.pdf');
                };
                btnBar.appendChild(pdfBtn);
                container.appendChild(btnBar);
            }
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addImage(prompt) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-start msg-anim";
            const container = document.createElement('div');
            container.className = "glass-panel p-4 rounded-2xl rounded-tl-none max-w-2xl border border-white/20";
            
            const style = " technical drawing, blueprint style, white on black background, schematic, high contrast";
            const safePrompt = encodeURIComponent(prompt + style);
            const imgUrl = `https://image.pollinations.ai/prompt/${safePrompt}?model=flux&width=1000&height=700&nologo=true&seed=${Math.random()}`;

            container.innerHTML = `<img src="${imgUrl}" class="w-full rounded bg-black border border-white/10 grayscale invert filter brightness-90">`;
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // ==========================================
        // 2. SMART LINK LOGIC (The "Logical" Search)
        // ==========================================
        function generateSmartLinks(contextText) {
            contextText = contextText.toLowerCase();
            const linksDiv = document.createElement('div');
            linksDiv.className = "flex flex-wrap gap-3 ml-0 mt-4 animate-pulse justify-end";
            let found = false;

            // Loop through our map. If the topic is found in the text, show the button.
            for (const [key, slug] of Object.entries(CHAPTER_MAP)) {
                if (contextText.includes(key)) {
                    found = true;
                    
                    // Button 1: Full Notes (Goes to specific section)
                    const btn1 = document.createElement('a');
                    btn1.href = `${BASE_URL}/#${slug}`; 
                    btn1.target = "_blank";
                    btn1.className = "glass-panel px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition flex items-center gap-2 text-white no-underline";
                    btn1.innerHTML = `<i class="fa-solid fa-book-open"></i> Full Topic`;

                    // Button 2: Summary (Goes to home with Summary hash)
                    const btn2 = document.createElement('a');
                    btn2.href = `${BASE_URL}/summary/#${slug}`; 
                    btn2.target = "_blank";
                    btn2.className = "glass-panel px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition flex items-center gap-2 text-white no-underline";
                    btn2.innerHTML = `<i class="fa-solid fa-bolt"></i> Summary`;

                    linksDiv.appendChild(btn1);
                    linksDiv.appendChild(btn2);
                    
                    // Only show buttons for the first relevant topic found to avoid clutter
                    break; 
                }
            }

            if (found) {
                // Append buttons to the last message
                const lastMsg = chatContainer.lastElementChild.querySelector('.glass-panel');
                if(lastMsg) lastMsg.appendChild(linksDiv);
                scrollToBottom();
            }
        }

        function addLoading() {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex w-full justify-start mt-2";
            div.innerHTML = `<div class="glass-panel px-4 py-3 rounded-full flex gap-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function requestImage() {
            const val = userInput.value;
            if(!val) return alert("Describe the diagram first.");
            userInput.value = "Generate a scientific diagram of: " + val;
            sendMessage();
        }

        function handleFile(input) { if(input.files[0]) addMessage(`[Attached: ${input.files[0].name}]`, 'user'); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
