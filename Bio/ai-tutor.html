<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioBot OneUI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000;
            background-image: linear-gradient(135deg, #0f0f0f 0%, #000 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* SAMSUNG ONE UI GLASS STYLE */
        .glass-panel {
            background: rgba(30, 30, 30, 0.4);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 0px; } /* Hidden scrollbar like mobile */

        /* TYPOGRAPHY */
        .prose h1, .prose h2 { color: white; font-weight: 700; margin-top: 1.2em; }
        .prose strong { color: #fff; font-weight: 800; }
        .prose ul { list-style-type: disc; color: #bbb; padding-left: 1rem; }
        .prose p { color: #ccc; line-height: 1.6; }

        /* ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        
        .typing-dot { width: 6px; height: 6px; background: white; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* PREVIEW THUMBNAILS */
        .img-preview {
            width: 60px; height: 60px; object-fit: cover; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="flex flex-col relative">

    <!-- HEADER -->
    <header class="glass-panel z-50 h-20 flex justify-between items-center px-6 absolute top-0 w-full rounded-b-3xl">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center font-bold text-xl">B</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">BioBot</h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">CIE 0610 AI</p>
            </div>
        </div>
        <a href="/" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
            <i class="fa-solid fa-xmark text-white"></i>
        </a>
    </header>

    <!-- CHAT AREA -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-24 pb-48 px-4 sm:px-6 space-y-6">
        <div class="flex justify-start w-full msg-anim">
            <div class="glass-panel p-6 rounded-[2rem] rounded-tl-none max-w-2xl">
                <h3 class="font-bold text-xl mb-2">Hello.</h3>
                <p class="text-gray-400">Upload your biology questions or images, and I will explain them in detail.</p>
            </div>
        </div>
    </main>

    <!-- INPUT AREA -->
    <footer class="absolute bottom-0 w-full z-50">
        <!-- Image Preview Container (Appears when images are added) -->
        <div id="preview-container" class="hidden px-6 pb-2 flex gap-3 overflow-x-auto">
            <!-- Dynamic thumbnails go here -->
        </div>

        <!-- Input Bar -->
        <div class="bg-black/60 backdrop-blur-xl border-t border-white/10 p-4 pb-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <div class="max-w-4xl mx-auto flex items-end gap-3">
                
                <!-- Upload Button -->
                <button onclick="document.getElementById('file-upload').click()" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 text-white transition flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
                <input type="file" id="file-upload" class="hidden" multiple accept="image/*" onchange="handleFiles(this)">

                <!-- Text Input -->
                <textarea id="user-input" rows="1" 
                    class="flex-1 bg-white/5 border border-white/10 rounded-3xl focus:ring-1 focus:ring-white/30 focus:outline-none text-white placeholder-gray-500 text-lg py-3 px-5 resize-none max-h-32 transition-all"
                    placeholder="Message..."
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>

                <!-- Send Button -->
                <button onclick="sendMessage()" class="w-12 h-12 bg-white text-black rounded-full hover:bg-gray-200 transition flex items-center justify-center shrink-0 shadow-lg shadow-white/10">
                    <i class="fa-solid fa-arrow-up text-lg"></i>
                </button>
            </div>
        </div>
    </footer>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const BASE_URL = "https://ig-bio.vercel.app";
        const CHAPTER_MAP = {
            "cell": "cells", "movement": "diffusion", "enzyme": "enzymes",
            "plant": "plant-nutrition", "human nutrition": "human-nutrition",
            "heart": "transport", "disease": "diseases", "respiration": "respiration",
            "kidney": "excretion", "eye": "coordination", "hormone": "hormones",
            "drug": "drugs", "reproduction": "reproduction", "dna": "inheritance",
            "ecosystem": "ecology"
        };

        const SYSTEM_PROMPT = `
        ACT AS: An Expert Cambridge IGCSE Biology (0610) Tutor.
        RULES:
        1. Answer strictly based on Biology.
        2. Answers must be DETAILED (Structure, Function, Mechanism).
        3. Use Bullet points and Bold text.
        4. Do NOT generate images. Focus on explaining.
        5. If the user attaches an image, use the text they provide to understand the context.
        `;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const previewContainer = document.getElementById('preview-container');
        let attachedFiles = []; // Stores the file objects

        // ==========================================
        // FILE HANDLING
        // ==========================================
        function handleFiles(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            files.forEach(file => {
                attachedFiles.push(file);
            });

            renderPreviews();
            input.value = ''; // Reset input to allow re-uploading same file
        }

        function renderPreviews() {
            previewContainer.innerHTML = '';
            
            if (attachedFiles.length > 0) {
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
                return;
            }

            attachedFiles.forEach((file, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = "relative group shrink-0";

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = "img-preview";

                const removeBtn = document.createElement('button');
                removeBtn.className = "absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center shadow-md hover:scale-110 transition";
                removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                removeBtn.onclick = () => removeFile(index);

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                previewContainer.appendChild(wrapper);
            });
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            renderPreviews();
        }

        // ==========================================
        // MESSAGING LOGIC
        // ==========================================
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && attachedFiles.length === 0) return;

            // 1. Create User Message Bubble
            addMessage(text, 'user', [...attachedFiles]); // Pass copy of files
            
            // 2. Clear Inputs
            userInput.value = '';
            userInput.style.height = 'auto';
            attachedFiles = []; // Clear array
            renderPreviews();   // Clear UI
            
            const loadingId = addLoading();

            try {
                // Since we don't have a paid vision API, we simulate context by adding file info to prompt
                let contextNote = "";
                if(attachedFiles.length > 0) {
                    contextNote = `[User has attached ${attachedFiles.length} image(s) related to this question. Assume the images show standard biological diagrams related to the text topic.] `;
                }

                const fullPrompt = SYSTEM_PROMPT + "\n\n" + contextNote + "Question: " + text;
                const seed = Math.floor(Math.random() * 99999);
                const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}?model=openai&seed=${seed}`;

                const response = await fetch(url);
                const botText = await response.text();
                
                document.getElementById(loadingId).remove();
                addBotMessage(botText);
                generateSmartLinks(text + " " + botText);

            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addBotMessage("Network error. Please try again.");
            }
        }

        function addMessage(text, sender, files = []) {
            const div = document.createElement('div');
            div.className = `flex w-full msg-anim ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            
            if (sender === 'user') {
                bubble.className = "flex flex-col items-end gap-2 max-w-[85%]";
                
                // Render Images in Chat Bubble
                if (files.length > 0) {
                    const imgGrid = document.createElement('div');
                    imgGrid.className = "flex gap-2 flex-wrap justify-end";
                    files.forEach(file => {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.className = "rounded-2xl w-32 h-32 object-cover border border-white/20";
                        imgGrid.appendChild(img);
                    });
                    bubble.appendChild(imgGrid);
                }

                if (text) {
                    const txtDiv = document.createElement('div');
                    txtDiv.className = "bg-white text-black px-5 py-3 rounded-[1.5rem] rounded-tr-sm font-medium shadow-lg";
                    txtDiv.textContent = text;
                    bubble.appendChild(txtDiv);
                }
            }
            
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(text) {
            const div = document.createElement('div');
            div.className = "flex w-full justify-start msg-anim";
            
            const container = document.createElement('div');
            container.className = "glass-panel p-6 rounded-[2rem] rounded-tl-sm max-w-3xl w-full border border-white/5";
            
            // Content Container
            const content = document.createElement('div');
            content.className = "prose prose-invert max-w-none"; 
            content.innerHTML = marked.parse(text);
            container.appendChild(content);

            // PDF Action Bar
            const btnBar = document.createElement('div');
            btnBar.className = "mt-6 pt-4 border-t border-white/10 flex justify-end";
            
            const pdfBtn = document.createElement('button');
            pdfBtn.className = "text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white border border-white/10 px-4 py-2 rounded-full hover:bg-white/10 transition flex items-center gap-2";
            pdfBtn.innerHTML = '<i class="fa-solid fa-file-arrow-down"></i> Save as PDF';
            
            // === HIGH QUALITY PDF LOGIC ===
            pdfBtn.onclick = () => {
                // 1. Create a clone of the text
                const clone = content.cloneNode(true);
                
                // 2. Create a specific container for the PDF (White bg, Black text)
                const pdfContainer = document.createElement('div');
                pdfContainer.style.background = 'white';
                pdfContainer.style.color = 'black';
                pdfContainer.style.padding = '20px';
                pdfContainer.style.fontFamily = 'Arial, sans-serif';
                
                // 3. Force text colors to black for the print
                const allText = clone.querySelectorAll('*');
                allText.forEach(el => {
                    el.style.color = 'black';
                });
                
                pdfContainer.appendChild(clone);
                
                // 4. Generate PDF from this hidden container
                const opt = {
                    margin: 0.5,
                    filename: 'BioBot_Notes.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(pdfContainer).save();
            };
            
            btnBar.appendChild(pdfBtn);
            container.appendChild(btnBar);
            div.appendChild(container);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function generateSmartLinks(contextText) {
            contextText = contextText.toLowerCase();
            const linksDiv = document.createElement('div');
            linksDiv.className = "flex flex-wrap gap-3 ml-0 mt-4 animate-pulse justify-end";
            let found = false;

            for (const [key, slug] of Object.entries(CHAPTER_MAP)) {
                if (contextText.includes(key)) {
                    found = true;
                    
                    const btn1 = document.createElement('a');
                    btn1.href = `${BASE_URL}/#${slug}`; 
                    btn1.target = "_blank";
                    btn1.className = "glass-panel px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition flex items-center gap-2 text-white no-underline";
                    btn1.innerHTML = `<i class="fa-solid fa-book-open"></i> Full Topic`;

                    const btn2 = document.createElement('a');
                    btn2.href = `${BASE_URL}/summary/#${slug}`; 
                    btn2.target = "_blank";
                    btn2.className = "glass-panel px-5 py-2 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-black transition flex items-center gap-2 text-white no-underline";
                    btn2.innerHTML = `<i class="fa-solid fa-bolt"></i> Summary`;

                    linksDiv.appendChild(btn1);
                    linksDiv.appendChild(btn2);
                    break; 
                }
            }

            if (found) {
                const lastMsg = chatContainer.lastElementChild.querySelector('.glass-panel');
                if(lastMsg) lastMsg.appendChild(linksDiv);
                scrollToBottom();
            }
        }

        function addLoading() {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex w-full justify-start mt-2";
            div.innerHTML = `<div class="glass-panel px-4 py-3 rounded-full flex gap-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
