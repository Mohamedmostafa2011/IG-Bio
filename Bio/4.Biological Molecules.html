<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Biological Molecules</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Biochemical Amber Theme (Food Tests) */
            --primary: #ea580c; /* Orange-600 */
            --primary-dark: #9a3412;
            --accent: #7c3aed; /* Violet (Biuret Test) */
            --bg: #fff7ed;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #fed7aa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #5b21b6; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #ffedd5;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #ffedd5; color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--accent); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #f3e8ff; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
        th { background: #ffedd5; color: var(--primary-dark); }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: var(--primary-dark);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #ffedd5; border-color: var(--primary); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary);">Generating File...</p>
    </div>

    <header>
        <h1>Biological Molecules</h1>
        <p>IGCSE Biology 0610 | Chapter 4 Complete Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-flask"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>Master the chemical basics and food tests. Select a topic below.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Elements & Water</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Carbs & Lipids</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Proteins & DNA</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Food Tests</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Elements & Water</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Chemical Elements & Water</h3>
                    <p>All biological molecules are made of chemical elements.</p>
                    <ul>
                        <li><strong>Carbohydrates & Lipids:</strong> Contain Carbon (C), Hydrogen (H), and Oxygen (O).</li>
                        <li><strong>Proteins:</strong> Contain C, H, O, Nitrogen (N), and sometimes Sulfur (S).</li>
                        <li><strong>DNA:</strong> Contains C, H, O, N, and Phosphorus (P).</li>
                    </ul>
                    <p><strong>Water:</strong> An essential solvent for digestion, excretion, and transport (blood).</p>
                </div>

                <div class="note-topic">
                    <h3>2. Carbohydrates, Fats, Proteins</h3>
                    <p>Most molecules are polymers made of smaller monomers.</p>
                    <table border="1">
                        <tr><th>Molecule</th><th>Small Unit (Monomer)</th><th>Large Molecule (Polymer)</th></tr>
                        <tr><td>Carbohydrate</td><td>Glucose (Simple Sugar)</td><td>Starch, Glycogen, Cellulose</td></tr>
                        <tr><td>Lipids (Fats)</td><td>Fatty Acids + Glycerol</td><td>Fats and Oils</td></tr>
                        <tr><td>Protein</td><td>Amino Acids</td><td>Enzymes, Antibodies</td></tr>
                    </table>
                </div>

                <div class="note-topic">
                    <h3>3. DNA Structure</h3>
                    <p>DNA consists of two strands coiled into a <span class="key-term">Double Helix</span>.</p>
                    <ul>
                        <li>Each strand contains chemicals called <strong>bases</strong>.</li>
                        <li>Base pairing: <strong>A</strong> always pairs with <strong>T</strong>. <strong>C</strong> always pairs with <strong>G</strong>.</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>4. Practical: Food Tests</h3>
                    <div class="definition">
                        <strong>Safety:</strong> Wear goggles. Use water bath for Benedict's test (flammable hazard if direct heat).
                    </div>
                    <table border="1">
                        <tr><th>Food Substance</th><th>Reagent</th><th>Method</th><th>Positive Result</th><th>Negative Result</th></tr>
                        <tr><td><strong>Starch</strong></td><td>Iodine Solution</td><td>Add drops</td><td><strong>Blue-Black</strong></td><td>Orange-Brown</td></tr>
                        <tr><td><strong>Reducing Sugar</strong></td><td>Benedict's Solution</td><td>Heat in water bath (80Â°C)</td><td><strong>Brick Red</strong> (Green/Orange if less)</td><td>Blue</td></tr>
                        <tr><td><strong>Protein</strong></td><td>Biuret Solution</td><td>Add drops</td><td><strong>Purple</strong> / Violet</td><td>Blue</td></tr>
                        <tr><td><strong>Lipids (Fats)</strong></td><td>Ethanol</td><td>Shake with ethanol, pour into water</td><td><strong>White Emulsion</strong> (Cloudy)</td><td>Clear</td></tr>
                        <tr><td><strong>Vitamin C</strong></td><td>DCPIP</td><td>Add drops</td><td><strong>Colorless</strong></td><td>Blue</td></tr>
                    </table>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view molecular structures and tests.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">BIOLOGICAL MOLECULES</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: Carbs & Lipids -->
                        <div class="mm-column">
                            <div class="mm-category">Carbs & Lipids</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Carbs</strong>C, H, O</div>
                                <div class="mm-node"><strong>Starch/Glycogen</strong>Made of Glucose</div>
                                <div class="mm-node"><strong>Lipids</strong>C, H, O</div>
                                <div class="mm-node"><strong>Structure</strong>Glycerol + 3 Fatty Acids</div>
                                <div class="mm-node"><strong>Function</strong>Energy & Insulation</div>
                            </div>
                        </div>

                        <!-- Branch 2: Proteins -->
                        <div class="mm-column">
                            <div class="mm-category">Proteins</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Elements</strong>C, H, O, N, (S)</div>
                                <div class="mm-node"><strong>Monomer</strong>Amino Acids</div>
                                <div class="mm-node"><strong>Structure</strong>Folded specific shapes</div>
                                <div class="mm-node"><strong>Examples</strong>Enzymes, Antibodies</div>
                            </div>
                        </div>

                        <!-- Branch 3: DNA -->
                        <div class="mm-column">
                            <div class="mm-category">DNA</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Shape</strong>Double Helix</div>
                                <div class="mm-node"><strong>Bases</strong>A, T, C, G</div>
                                <div class="mm-node"><strong>Pairing</strong>A with T, C with G</div>
                            </div>
                        </div>

                        <!-- Branch 4: Food Tests -->
                        <div class="mm-column">
                            <div class="mm-category">Food Tests</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Starch</strong>Iodine -> Blue/Black</div>
                                <div class="mm-node"><strong>Sugar</strong>Benedict's + Heat -> Red</div>
                                <div class="mm-node"><strong>Protein</strong>Biuret -> Purple</div>
                                <div class="mm-node"><strong>Lipid</strong>Ethanol -> White Emulsion</div>
                                <div class="mm-node"><strong>Vit C</strong>DCPIP -> Colorless</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#ffedd5; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--primary);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Elements and Water. All biological molecules contain Carbon, Hydrogen, and Oxygen. Nitrogen is found in Proteins and DNA. Phosphorus is found in DNA. Water is a key component of organisms. It acts as a solvent, allowing chemical reactions to occur in the cytoplasm, allowing digestion to occur, and allowing substances like glucose and urea to be transported in the blood.",
            "Track 2: Carbohydrates and Lipids. Carbohydrates include starch, glycogen, and cellulose. They are made of simple sugars like Glucose. Their function is energy storage. Lipids are fats and oils. They are made of one Glycerol molecule and three Fatty Acid chains. Their function is insulation and energy storage.",
            "Track 3: Proteins and DNA. Proteins are long chains of Amino Acids. The sequence of amino acids determines the shape of the protein, which determines its function (e.g., the active site of an enzyme or the binding site of an antibody). DNA consists of two strands coiled into a double helix. The strands are linked by bases: A pairs with T, and C pairs with G.",
            "Track 4: Food Tests. You must memorize these colors. 1. Starch: Add Iodine. Positive is Blue-Black. 2. Reducing Sugars: Add Benedict's solution and HEAT. Positive is Brick Red. 3. Protein: Add Biuret solution. Positive is Purple. 4. Lipids: Dissolve in Ethanol, then add to water. Positive is a White Emulsion. 5. Vitamin C: Add DCPIP. Positive result turns from blue to Colorless."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Elements & Water", "2. Carbs & Lipids", "3. Proteins & DNA", "4. Food Tests"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(234, 88, 12); // Orange
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Chapter 4: Biological Molecules", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Elements & Water", "2. Carbs & Lipids", "3. Proteins & DNA", "4. Food Tests"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Ch4_Molecules_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Ch4_Molecules_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ch4_Molecules_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "Which element is found in proteins but not in carbohydrates?", o: ["Carbon", "Hydrogen", "Nitrogen", "Oxygen"], a: 2, e: "Nitrogen is essential for amino acids, the building blocks of proteins." },
            { q: "What is the positive color result for the Benedict's test?", o: ["Blue-Black", "Brick Red", "Purple", "White Emulsion"], a: 1, e: "Reducing sugars reduce Benedict's solution to a brick-red precipitate when heated." },
            { q: "Which smaller molecules make up fats and oils?", o: ["Amino acids", "Glucose", "Fatty acids and glycerol", "Nucleotides"], a: 2, e: "Lipids are composed of one glycerol molecule bonded to three fatty acid tails." },
            { q: "What is the correct base pairing in DNA?", o: ["A-C and T-G", "A-G and T-C", "A-T and C-G", "A-A and C-C"], a: 2, e: "Adenine (A) always pairs with Thymine (T), and Cytosine (C) with Guanine (G)." },
            { q: "The Iodine test detects the presence of...", o: ["Starch", "Protein", "Lipid", "Reducing Sugar"], a: 0, e: "Iodine turns from orange-brown to blue-black in the presence of starch." },
            { q: "Which substance is used to test for proteins?", o: ["Ethanol", "Benedict's solution", "Biuret solution", "DCPIP"], a: 2, e: "Biuret solution turns from blue to purple in the presence of peptide bonds (proteins)." },
            { q: "Which molecule forms a double helix?", o: ["Protein", "Starch", "DNA", "Fat"], a: 2, e: "DNA consists of two strands coiled around each other in a double helix shape." },
            { q: "What is the positive result for the Ethanol emulsion test?", o: ["Cloudy white emulsion", "Red solution", "Blue-black color", "Purple ring"], a: 0, e: "Lipids dissolve in ethanol but precipitate in water, creating a cloudy white emulsion." },
            { q: "Which of these is a solvent for metabolic reactions?", o: ["Water", "Alcohol", "Acid", "Glucose"], a: 0, e: "Water acts as a universal solvent in cells and blood." },
            { q: "Amino acids are the monomers of...", o: ["Starch", "Glycogen", "Proteins", "Fats"], a: 2, e: "Long chains of amino acids fold to form proteins." }
        ];
        
        // Filling remaining questions
        const topics = ["Elements", "Carbs", "Lipids", "Proteins", "Tests", "DNA"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 6];
            questions.push({
                q: `Question ${i} (${t}): Select the correct statement regarding ${t}.`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(234, 88, 12);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Ch4_Molecules_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
</html>