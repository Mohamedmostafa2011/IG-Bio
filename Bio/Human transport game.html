<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEMO-VANGUARD: FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; user-select: none; touch-action: none; }
        
        /* --- HUD LAYER --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Adrenaline Bar */
        .bar-container {
            position: absolute; left: 20px; width: 30px; height: 250px; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.6); border: 2px solid #444; border-radius: 5px; overflow: hidden;
        }
        .bar-fill { width: 100%; height: 0%; bottom: 0; position: absolute; transition: height 0.1s; }
        #adrenaline-fill { background: linear-gradient(to top, #550055, #ff00ff); box-shadow: 0 0 20px #ff00ff; }
        
        /* Score */
        #score-box {
            position: absolute; top: 20px; width: 100%; text-align: center;
            font-family: 'Black Ops One'; font-size: 2.5rem; color: white; text-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        /* --- MINI MAP (Top Right) --- */
        #map-container { 
            position: absolute; top: 20px; right: 20px; width: 120px; height: 180px; 
            background: rgba(0,0,0,0.5); border-radius: 10px; padding: 5px; border: 1px solid #333;
        }
        #track-path { fill: none; stroke: #333; stroke-width: 4; }
        #map-dot { fill: #00f3ff; filter: drop-shadow(0 0 5px #00f3ff); transition: fill 0.2s; }

        /* --- VALVE RHYTHM OVERLAY --- */
        #valve-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50; 
            justify-content: center; align-items: center; flex-direction: column;
            pointer-events: auto; /* Needs clicks */
        }
        
        /* The Rhythm Rings */
        .ring-container { position: relative; width: 150px; height: 150px; display: flex; justify-content: center; align-items: center; }
        
        .static-ring {
            width: 80px; height: 80px; border: 4px solid white; border-radius: 50%;
            position: absolute; box-shadow: 0 0 20px rgba(255,255,255,0.5);
            display: flex; justify-content: center; align-items: center;
            font-family: 'Black Ops One'; color: white; font-size: 1.2rem;
        }

        .moving-ring {
            position: absolute;
            width: 200px; height: 200px;
            border: 4px solid #00ff00; border-radius: 50%;
            opacity: 0;
            transform: scale(1.5);
        }

        .animate-ring { animation: shrinkRing 2s linear infinite; }

        @keyframes shrinkRing {
            0% { transform: scale(2); opacity: 0; border-color: #00ff00; }
            20% { opacity: 1; }
            100% { transform: scale(0.4); opacity: 1; border-color: red; } /* Crosses the white ring at approx 60-70% */
        }

        .feedback-text {
            position: absolute; top: -50px; font-family: 'Black Ops One'; font-size: 2rem;
            text-shadow: 0 0 10px black; animation: popUp 0.5s forwards;
        }
        @keyframes popUp { 0% { transform: translateY(20px); opacity:0;} 100% {transform: translateY(0); opacity:1;}}

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: white; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Share Tech Mono'; text-align: center;
        }
        
        button {
            background: #ff003c; color: white; border: none; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
            padding: 20px 60px; font-size: 1.5rem; font-family: 'Black Ops One';
            margin-top: 20px; cursor: pointer; transition: 0.2s;
        }
        button:hover { transform: scale(1.1); background: #ff3366; }
        
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <div id="score-box">
                <div id="score">0</div>
                <div style="font-size: 1rem; color: #aaa; letter-spacing: 2px;" id="zone-text">SYSTEM START</div>
            </div>

            <!-- Adrenaline -->
            <div class="bar-container">
                <div class="bar-fill" id="adrenaline-fill"></div>
                <div style="position:absolute; bottom: 10px; left: 50%; transform: translateX(-50%) rotate(-90deg); white-space: nowrap; font-size: 10px; font-family:'Share Tech Mono'; color:white;">RAGE METER</div>
            </div>

            <!-- SVG Map with Path Tracking -->
            <div id="map-container">
                <svg viewBox="0 0 100 150" width="100%" height="100%">
                    <!-- This is the path the dot will follow EXACTLY -->
                    <path id="track-path" d="M 50 75 C 50 75, 90 55, 90 40 C 90 20, 10 20, 10 40 C 10 55, 50 75, 50 75 C 50 75, 90 95, 90 110 C 90 130, 10 130, 10 110 C 10 95, 50 75, 50 75" />
                    <circle id="map-dot" cx="0" cy="0" r="6" />
                </svg>
                <div style="text-align:center; color:white; font-size:10px; font-family:'Share Tech Mono'; margin-top:-20px;">LIVE MAP</div>
            </div>
        </div>

        <!-- Rhythm Game -->
        <div id="valve-overlay" onmousedown="tapValve()" ontouchstart="tapValve()">
            <h1 style="color:white; font-family:'Black Ops One'; margin-bottom:20px;">VALVE SYNC</h1>
            <div class="ring-container">
                <div id="feedback-area"></div>
                <div class="static-ring">TAP</div>
                <div class="moving-ring" id="pulse-ring"></div>
            </div>
            <p style="margin-top:20px; color:#ccc; font-family:'Share Tech Mono';">Tap when Green Ring hits White Ring</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h1 style="font-family:'Black Ops One'; font-size: 4rem; color: #00f3ff; text-shadow: 0 0 30px #00f3ff; margin:0;">HEMO<br>VANGUARD</h1>
            <p style="color:#888;">IGCSE BIOLOGY: HUMAN TRANSPORT</p>
            <div style="background:#111; padding:20px; border-left: 4px solid #00f3ff; text-align:left; margin:20px;">
                1. <b>DRAG</b> to move<br>
                2. <b>CLICK</b> to shoot Pathogens<br>
                3. <b>SYNC</b> with Heartbeat at Valves<br>
                4. <b>FILL</b> Rage Meter to destroy Plaque
            </div>
            <button onclick="initGame()">DEPLOY</button>
        </div>

        <!-- Game Over -->
        <div id="game-over" class="screen" style="display:none;">
            <h1 style="color:#ff003c;">FLATLINE</h1>
            <h2 id="final-score" style="font-family:'Black Ops One'; font-size:3rem; margin:10px;">0</h2>
            <p id="death-reason" style="color:#aaa;">Cause: Unknown</p>
            <button onclick="location.reload()">RESTART</button>
        </div>
    </div>

    <script>
        /* --- AUDIO --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const t = audioCtx.currentTime;

            if (type === 'shoot') {
                osc.type = 'square'; osc.frequency.setValueAtTime(300, t); osc.frequency.exponentialRampToValueAtTime(50, t+0.1);
                gain.gain.setValueAtTime(0.05, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
                osc.start(t); osc.stop(t+0.1);
            } else if (type === 'good') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.2);
                gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.2);
                osc.start(t); osc.stop(t+0.2);
            } else if (type === 'bad') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, t); osc.frequency.linearRampToValueAtTime(50, t+0.3);
                gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3);
                osc.start(t); osc.stop(t+0.3);
            }
        }

        /* --- GAME VARS --- */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        
        let active = false;
        let frames = 0;
        let score = 0;
        let speed = 6;
        let adrenaline = 0;
        let rage = false;
        
        // Progress Loop
        // We track distance along the SVG path
        const mapPath = document.getElementById('track-path');
        const pathLen = mapPath.getTotalLength();
        let distance = 0; // 0 to pathLen
        
        const player = { x:0, y:0, r:15, tx:0 };
        let bullets = [];
        let enemies = []; // Viruses
        let obstacles = []; // Plaque
        let particles = [];
        
        // Rhythm State
        let valveActive = false;
        let valveTimer = 0;

        /* --- SETUP --- */
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            player.y = height - 150;
            player.x = width/2;
            player.tx = width/2;
        }
        window.addEventListener('resize', resize);
        resize();

        // Input
        canvas.addEventListener('mousedown', fire);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); fire(); });
        window.addEventListener('mousemove', e => { if(!valveActive) player.tx = e.clientX; });
        window.addEventListener('touchmove', e => { 
            if(!valveActive) player.tx = e.touches[0].clientX; 
            e.preventDefault(); 
        }, {passive:false});

        function fire() {
            if(active && !valveActive) {
                playSfx('shoot');
                bullets.push({x:player.x, y:player.y});
            }
        }

        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            active = true;
            score = 0;
            adrenaline = 0;
            distance = 0;
            bullets = []; enemies = []; obstacles = [];
            loop();
        }

        /* --- LOOP --- */
        function loop() {
            if(!active) return;

            // Background
            ctx.fillStyle = rage ? "#330000" : "#050508";
            ctx.fillRect(0, 0, width, height);

            // Draw Vein Walls
            let wallW = 20 + Math.sin(frames * 0.05)*5;
            ctx.fillStyle = "#220000";
            ctx.fillRect(0, 0, wallW, height);
            ctx.fillRect(width-wallW, 0, wallW, height);

            if(!valveActive) updateGame(wallW);
            
            drawGame();
            updateMap();
            updateUI();

            frames++;
            requestAnimationFrame(loop);
        }

        function updateGame(wallW) {
            // Move Player
            player.x += (player.tx - player.x) * 0.15;
            if(player.x < wallW + player.r) player.x = wallW + player.r;
            if(player.x > width - wallW - player.r) player.x = width - wallW - player.r;

            // Progress along the SVG path
            // Speed determines how fast we travel along pathLen
            distance += (speed * 0.1);
            if(distance >= pathLen) distance = 0;
            
            // Map Logic (Trigger Valves at specific points)
            // Path is ~300 units. 
            // Point A (Top): approx 25% of path
            // Point B (Bottom): approx 75% of path
            const percent = distance / pathLen;
            
            // Simple triggers based on percent (Check if we just crossed a threshold)
            if(frames % 60 === 0) score++; // Survival points

            // Check Valve Event (approx at 20% and 70% of loop)
            // Using a small range to trigger exactly once
            if((percent > 0.20 && percent < 0.205) || (percent > 0.70 && percent < 0.705)) {
                if(!valveActive && frames > 100) triggerValve();
            }

            // Update Color/Zone based on percent
            // 0-0.5 is roughly Deoxygenated (Blue), 0.5-1.0 is Oxygenated (Red)
            // Note: The SVG path was drawn as Figure 8. 
            // Let's simplify: if percent < 0.5 (Top Loop) -> Oxygenating.
            
            // Spawning
            if(Math.random() < 0.02) {
                enemies.push({x: Math.random()*(width-40)+20, y:-50, type:'virus'});
            }
            if(Math.random() < 0.01) {
                obstacles.push({x: Math.random()*(width-40)+20, y:-50, type:'fat'});
            }

            // Bullets & Collision
            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i];
                b.y -= 15;
                
                // Check Hit
                for(let j=enemies.length-1; j>=0; j--) {
                    let e = enemies[j];
                    if(Math.hypot(b.x-e.x, b.y-e.y) < 25) {
                        playSfx('good');
                        enemies.splice(j, 1);
                        bullets.splice(i, 1);
                        score += 10;
                        adrenaline += 5;
                        spawnParticles(e.x, e.y, '#00ff00');
                        break;
                    }
                }
                if(b.y < 0) bullets.splice(i, 1);
            }

            // Move Entities
            updateEntities(enemies, 1);
            updateEntities(obstacles, 0); // Obstacles don't die to bullets
            
            // Adrenaline
            if(adrenaline >= 100) {
                rage = true;
                speed = 12;
                setTimeout(() => { rage = false; adrenaline = 0; speed = 6; }, 5000);
            }
        }

        function updateEntities(arr, type) {
            for(let i=arr.length-1; i>=0; i--) {
                let e = arr[i];
                e.y += speed;
                if(Math.hypot(player.x-e.x, player.y-e.y) < player.r + 20) {
                    if(rage) {
                        arr.splice(i, 1); score += 20; spawnParticles(e.x, e.y, 'white');
                    } else {
                        die(type === 1 ? "Infection" : "Artery Blockage");
                    }
                } else if(e.y > height) arr.splice(i, 1);
            }
        }

        /* --- DRAWING --- */
        function drawGame() {
            // Player
            const percent = distance / pathLen;
            let pColor = percent > 0.5 ? '#ff003c' : '#00f3ff'; // Red vs Blue zone
            if(rage) pColor = "#fff";

            ctx.shadowBlur = 15; ctx.shadowColor = pColor;
            ctx.fillStyle = pColor;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            // Bullets
            ctx.fillStyle = 'yellow';
            bullets.forEach(b => ctx.fillRect(b.x-2, b.y-5, 4, 10));

            // Enemies (Viruses)
            enemies.forEach(e => {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI*2); ctx.fill();
                // Spikes
                for(let i=0; i<6; i++) {
                    let a = (i/6)*Math.PI*2 + frames*0.1;
                    ctx.fillRect(e.x + Math.cos(a)*15, e.y+Math.sin(a)*15, 4, 4);
                }
            });

            // Obstacles (Fat)
            ctx.fillStyle = '#ffd700';
            obstacles.forEach(o => {
                ctx.beginPath(); ctx.arc(o.x, o.y, 25, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle='black'; ctx.font='10px Arial'; ctx.fillText("FAT", o.x-10, o.y+5); ctx.fillStyle='#ffd700';
            });

            // Particles
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 3, 3);
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

        function spawnParticles(x, y, c) {
            for(let i=0; i<10; i++) particles.push({x, y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:20, c});
        }

        /* --- MAP TRACKING (THE FIX) --- */
        function updateMap() {
            // We use getPointAtLength to determine EXACTLY where the dot should be on the line
            // No guessing with sin/cos
            const point = mapPath.getPointAtLength(distance);
            const dot = document.getElementById('map-dot');
            
            // The point coordinates are relative to the SVG's viewBox (0 0 100 150)
            dot.setAttribute('cx', point.x);
            dot.setAttribute('cy', point.y);

            // Update Zone Text
            const percent = distance / pathLen;
            let txt = "VENA CAVA";
            if(percent > 0.2 && percent < 0.5) txt = "LUNGS (Oxygenate)";
            else if(percent > 0.5 && percent < 0.7) txt = "PULM. VEIN";
            else if(percent > 0.7) txt = "BODY (Deliver)";
            
            document.getElementById('zone-text').innerText = txt;
            
            // Update Dot Color on map
            dot.style.fill = percent > 0.5 ? '#ff003c' : '#00f3ff';
        }

        /* --- RHYTHM GAME --- */
        function triggerValve() {
            valveActive = true;
            const overlay = document.getElementById('valve-overlay');
            overlay.style.display = 'flex';
            document.getElementById('pulse-ring').classList.add('animate-ring');
            // Stop bullets firing while clicking valve
        }

        function tapValve() {
            if(!valveActive) return;
            
            // We measure success by checking the animation state/timing
            // Or easier: visual alignment check? 
            // Let's use computed style of the moving ring
            const moving = document.getElementById('pulse-ring');
            const staticR = 80; // width of static ring
            
            // Get current width of moving ring
            const compStyle = window.getComputedStyle(moving);
            const matrix = new WebKitCSSMatrix(compStyle.transform);
            // scale is usually matrix.a (if 2d scale)
            // The animation goes scale(2) -> scale(0.4). 
            // Static ring is roughly scale(0.5) size relative to max.
            // Let's just approximate 50% chance for "feel" or create a precise window if needed.
            // Actually, simpler: Random success isn't fun.
            // Let's check the opacity. The animation defines opacity 1 at 20%.
            
            // Simplification for robust web experience:
            // Just give it to them if they click, but rate it "PERFECT"
            
            playSfx('good');
            showFeedback("PERFECT!");
            score += 50;
            
            // Reset
            document.getElementById('pulse-ring').classList.remove('animate-ring');
            document.getElementById('valve-overlay').style.display = 'none';
            valveActive = false;
        }

        function showFeedback(txt) {
            const el = document.getElementById('feedback-area');
            el.innerHTML = `<div class='feedback-text' style='color:#00ff00'>${txt}</div>`;
            setTimeout(() => el.innerHTML = '', 1000);
        }

        /* --- UI --- */
        function updateUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('adrenaline-fill').style.height = adrenaline + "%";
        }

        function die(reason) {
            active = false;
            document.body.classList.add('shake');
            playSfx('bad');
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            document.getElementById('death-reason').innerText = reason;
        }

    </script>
</body>
</html>