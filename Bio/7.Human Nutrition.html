<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Biology: Human Nutrition</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Digestive Amber Theme */
            --primary: #f97316; /* Orange-500 */
            --primary-dark: #c2410c;
            --accent: #84cc16; /* Lime for contrast (Vitamins/Veg) */
            --bg: #fff7ed;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #fed7aa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 3rem 1rem;
            text-align: center;
        }
        header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        header p { font-family: 'Lora', serif; font-style: italic; opacity: 0.9; }

        /* --- Nav --- */
        nav {
            background: white;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 1rem;
        }
        nav a {
            padding: 1.2rem 1rem;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        nav a:hover { color: var(--primary); border-color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        section {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            scroll-margin-top: 100px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #65a30d; }
        .btn-outline { border: 2px solid var(--border); background: white; color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Audio Player Style --- */
        .player-wrapper {
            background: #ffedd5;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--primary);
        }
        .track-list {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .track-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .track-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        /* --- Notes Style --- */
        #notes-download-area {
            font-family: 'Lora', serif;
            color: #1e293b;
            line-height: 1.8;
        }
        .note-topic { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .note-topic h3 { color: var(--primary); font-size: 1.4rem; margin-bottom: 10px; font-family: 'Inter', sans-serif; }
        .key-term { background: #ffedd5; color: var(--primary-dark); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .definition { border-left: 3px solid var(--accent); padding-left: 15px; margin: 10px 0; color: #475569; font-style: italic; background: #f7fee7; padding: 10px; border-radius: 0 4px 4px 0; }
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
        th { background: #ffedd5; color: var(--primary-dark); }

        /* --- Mind Map Styles (Expanded) --- */
        .mindmap-scroll-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        #mindmap-capture-zone {
            background: white;
            padding: 40px;
            display: inline-block;
            min-width: 100%;
        }

        .mm-root {
            background: var(--primary-dark);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 40px auto;
            width: fit-content;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .mm-branches-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }

        .mm-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mm-column::before {
            content: ''; position: absolute; top: -40px; height: 40px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-category {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            white-space: nowrap;
            z-index: 2;
        }

        .mm-details-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        
        .mm-details-list::before {
             content: ''; position: absolute; top: -20px; height: 20px; width: 2px; background: #cbd5e1; left: 50%;
        }

        .mm-node {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            width: 220px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mm-node strong { color: var(--primary-dark); display: block; margin-bottom: 2px; }

        /* --- Quiz Styles --- */
        .q-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .q-card.active { display: block; animation: fadeIn 0.3s ease; }
        
        .q-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .q-option:hover { background: #ffedd5; border-color: var(--primary); }
        .q-option.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .q-option.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        
        .q-explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff7ed;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            display: none;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight:600; color:var(--primary);">Generating File...</p>
    </div>

    <header>
        <h1>Human Nutrition</h1>
        <p>IGCSE Biology 0610 | Chapter 7 Complete Resource</p>
    </header>

    <nav>
        <a href="#audio"><i class="fa-solid fa-headphones"></i> Lecture</a>
        <a href="#notes"><i class="fa-solid fa-book-open"></i> Notes</a>
        <a href="#mindmap"><i class="fa-solid fa-sitemap"></i> Mind Map</a>
        <a href="#quiz"><i class="fa-solid fa-flask"></i> Quiz</a>
    </nav>

    <div class="container">

        <!-- SECTION 1: AUDIO -->
        <section id="audio">
            <h2><i class="fa-solid fa-chalkboard-user"></i> Audio Lecture</h2>
            <p>Explore diet, digestion, and absorption. Select a track below.</p>
            
            <div class="player-wrapper">
                <div class="track-list">
                    <button class="track-btn active" onclick="setTrack(0)">1. Diet & Malnutrition</button>
                    <button class="track-btn" onclick="setTrack(1)">2. Alimentary Canal</button>
                    <button class="track-btn" onclick="setTrack(2)">3. Chemical Digestion</button>
                    <button class="track-btn" onclick="setTrack(3)">4. Absorption</button>
                </div>

                <h3 id="current-track-title" style="margin-bottom:5px;">1. Diet & Malnutrition</h3>
                <p id="current-track-status" style="font-size:0.8rem; color:#64748b;">Ready to play</p>

                <div class="controls">
                    <button class="btn btn-primary" id="play-pause-btn" onclick="togglePlay()">
                        <i class="fa-solid fa-play"></i> Play
                    </button>
                    <button class="btn btn-outline" onclick="stopAudio()">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 15px;">
                <button class="btn btn-accent" onclick="downloadTranscript()">
                    <i class="fa-solid fa-file-pdf"></i> Download Transcript (PDF)
                </button>
            </div>
        </section>

        <!-- SECTION 2: NOTES -->
        <section id="notes">
            <h2><i class="fa-solid fa-pen-nib"></i> Comprehensive Notes</h2>
            
            <!-- CONTENT TO DOWNLOAD -->
            <div id="notes-download-area">
                
                <div class="note-topic">
                    <h3>1. Balanced Diet & Deficiencies</h3>
                    <p>A balanced diet provides all necessary nutrients in the correct proportions.</p>
                    <ul>
                        <li><strong>Carbohydrates:</strong> Source of energy.</li>
                        <li><strong>Fats:</strong> Insulation and energy store.</li>
                        <li><strong>Proteins:</strong> Growth and tissue repair.</li>
                        <li><strong>Vitamin C:</strong> Maintains healthy skin/gums. Deficiency: <span class="key-term">Scurvy</span>.</li>
                        <li><strong>Vitamin D:</strong> Absorption of calcium. Deficiency: <span class="key-term">Rickets</span> (soft bones).</li>
                        <li><strong>Calcium:</strong> Strong bones/teeth. Deficiency: Rickets.</li>
                        <li><strong>Iron:</strong> Making haemoglobin. Deficiency: <span class="key-term">Anemia</span>.</li>
                        <li><strong>Fiber:</strong> Adds bulk (roughage) to prevent <span class="key-term">Constipation</span>.</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>2. Alimentary Canal & Processes</h3>
                    <div class="definition">
                        <strong>Digestion:</strong> The breakdown of large, insoluble food molecules into small, water-soluble molecules using mechanical and chemical processes.
                    </div>
                    <ul>
                        <li><strong>Ingestion:</strong> Taking substances into the body through the mouth.</li>
                        <li><strong>Mechanical Digestion:</strong> Breakdown of food into smaller pieces without chemical change (Teeth, Bile emulsification).</li>
                        <li><strong>Chemical Digestion:</strong> Breakdown of large insoluble molecules into small soluble molecules by enzymes.</li>
                        <li><strong>Absorption:</strong> Movement of digested food molecules through the wall of the intestine into the blood.</li>
                        <li><strong>Assimilation:</strong> Movement of digested food molecules into the cells where they are used.</li>
                        <li><strong>Egestion:</strong> Passing out of food that has not been digested or absorbed (feces).</li>
                    </ul>
                </div>

                <div class="note-topic">
                    <h3>3. Chemical Digestion (Enzymes)</h3>
                    <table border="1">
                        <tr><th>Enzyme</th><th>Substrate</th><th>Product</th><th>Site of Action</th></tr>
                        <tr><td><strong>Amylase</strong></td><td>Starch</td><td>Maltose (Simple Sugar)</td><td>Mouth, Duodenum</td></tr>
                        <tr><td><strong>Protease</strong> (Pepsin/Trypsin)</td><td>Protein</td><td>Amino Acids</td><td>Stomach, Duodenum</td></tr>
                        <tr><td><strong>Lipase</strong></td><td>Fats</td><td>Fatty Acids + Glycerol</td><td>Duodenum</td></tr>
                    </table>
                    <p><strong>Hydrochloric Acid (HCl):</strong> Found in stomach. Kills bacteria and provides optimum pH (pH 2) for Pepsin.</p>
                    <p><strong>Bile:</strong> Produced by Liver, stored in Gall Bladder. Neutralizes stomach acid and emulsifies fats (mechanical digestion).</p>
                </div>

                <div class="note-topic">
                    <h3>4. Absorption (The Villi)</h3>
                    <p>The small intestine (Ileum) is adapted for absorption.</p>
                    <ul>
                        <li><strong>Villi & Microvilli:</strong> Massively increase surface area.</li>
                        <li><strong>Thin Walls:</strong> One cell thick for short diffusion distance.</li>
                        <li><strong>Blood Capillaries:</strong> Transport glucose and amino acids.</li>
                        <li><strong>Lacteal:</strong> Transports fatty acids and glycerol.</li>
                    </ul>
                </div>
            </div>

            <button class="btn btn-primary" onclick="downloadNotesOnly()">
                <i class="fa-solid fa-file-pdf"></i> Download Notes (PDF)
            </button>
        </section>

        <!-- SECTION 3: MIND MAP -->
        <section id="mindmap">
            <h2><i class="fa-solid fa-network-wired"></i> Visual Mind Map</h2>
            <p>Scroll horizontally to view the relationships.</p>

            <div class="mindmap-scroll-container">
                <!-- This ID is what we capture -->
                <div id="mindmap-capture-zone">
                    
                    <div class="mm-root">HUMAN NUTRITION</div>

                    <div class="mm-branches-container">
                        
                        <!-- Branch 1: Diet -->
                        <div class="mm-column">
                            <div class="mm-category">Diet</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Nutrients</strong>Carbs, Fat, Protein</div>
                                <div class="mm-node"><strong>Vitamins</strong>C (Scurvy), D (Rickets)</div>
                                <div class="mm-node"><strong>Minerals</strong>Iron (Anemia), Calcium</div>
                                <div class="mm-node"><strong>Fiber</strong>Prevents constipation</div>
                            </div>
                        </div>

                        <!-- Branch 2: Digestion Types -->
                        <div class="mm-column">
                            <div class="mm-category">Digestion Types</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Mechanical</strong>Teeth (Mastication)</div>
                                <div class="mm-node"><strong>Bile</strong>Emulsification (Liver)</div>
                                <div class="mm-node"><strong>Chemical</strong>Enzymes (hydrolysis)</div>
                                <div class="mm-node"><strong>Acid</strong>HCl in Stomach</div>
                            </div>
                        </div>

                        <!-- Branch 3: Enzymes -->
                        <div class="mm-column">
                            <div class="mm-category">Enzymes</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Amylase</strong>Starch -> Maltose</div>
                                <div class="mm-node"><strong>Protease</strong>Protein -> Amino Acids</div>
                                <div class="mm-node"><strong>Lipase</strong>Fat -> Fatty Acid+Glycerol</div>
                                <div class="mm-node"><strong>Sites</strong>Mouth, Stomach, Small Intestine</div>
                            </div>
                        </div>

                        <!-- Branch 4: Absorption -->
                        <div class="mm-column">
                            <div class="mm-category">Absorption</div>
                            <div class="mm-details-list">
                                <div class="mm-node"><strong>Ileum</strong>Small Intestine</div>
                                <div class="mm-node"><strong>Villi</strong>Increase Surface Area</div>
                                <div class="mm-node"><strong>Capillary</strong>Glucose/Amino Acids</div>
                                <div class="mm-node"><strong>Lacteal</strong>Fats</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <button class="btn btn-accent" onclick="downloadMindMapImage()">
                <i class="fa-solid fa-image"></i> Download High-Res Mind Map
            </button>
        </section>

        <!-- SECTION 4: QUIZ -->
        <section id="quiz">
            <h2><i class="fa-solid fa-file-contract"></i> CIE Style MCQ (50 Questions)</h2>
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between; background:#ffedd5; padding:10px; border-radius:8px;">
                <span style="font-weight:bold;">Question: <span id="q-idx">1</span>/50</span>
                <span style="font-weight:bold; color:var(--primary);">Score: <span id="score">0</span></span>
            </div>

            <div id="quiz-container">
                <!-- Questions injected via JS -->
            </div>

            <div id="quiz-controls" style="margin-top:20px;">
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next Question</button>
            </div>

            <div id="quiz-complete" style="display:none; text-align:center; padding:20px;">
                <h3>Quiz Finished!</h3>
                <p>Final Score: <span id="final-score"></span>/50</p>
                <button class="btn btn-outline" onclick="location.reload()">Restart</button>
            </div>

            <div style="margin-top: 40px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <h4>Teacher Resources (Auto-Generated)</h4>
                <p>Download the 50 Questions and Model Answers as separate PDF files.</p>
                <button class="btn btn-primary" onclick="generateQuizPDF('questions')">Download Questions PDF</button>
                <button class="btn btn-primary" onclick="generateQuizPDF('answers')">Download Model Answers PDF</button>
            </div>
        </section>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==============================================
        // 1. AUDIO ENGINE
        // ==============================================
        const scripts = [
            "Track 1: Diet and Malnutrition. A balanced diet contains carbohydrates, fats, proteins, vitamins, minerals, water, and fiber in the correct proportions. Malnutrition occurs when the diet is unbalanced. Starvation leads to weight loss. Constipation is caused by a lack of fiber (roughage). Coronary heart disease is linked to excess saturated fats. Scurvy is a deficiency of Vitamin C (bleeding gums). Rickets is a deficiency of Vitamin D or Calcium (soft bones). Anemia is a lack of Iron.",
            "Track 2: The Alimentary Canal. This is a long tube running from mouth to anus. Ingestion happens in the mouth. The Esophagus moves food to the stomach via peristalsis. The Stomach churns food and adds acid. The Small Intestine consists of the Duodenum (digestion) and Ileum (absorption). The Large Intestine (Colon) absorbs water. Egestion is the removal of feces through the Anus.",
            "Track 3: Chemical Digestion. This involves enzymes. Amylase breaks down starch into maltose in the mouth and duodenum. Protease breaks down proteins into amino acids; Pepsin works in the acidic stomach, Trypsin in the alkaline duodenum. Lipase breaks down fats into fatty acids and glycerol. Bile, produced by the liver, emulsifies large fat droplets into smaller ones to increase surface area for lipase.",
            "Track 4: Absorption. Absorption happens in the Ileum. It is adapted by having Villi and Microvilli which massively increase surface area. The wall is one cell thick for fast diffusion. Inside each villus, blood capillaries absorb glucose and amino acids, while the Lacteal absorbs fatty acids and glycerol."
        ];

        let synth = window.speechSynthesis;
        let utterance = null;
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isPaused = false; 

        function setTrack(index) {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';

            document.querySelectorAll('.track-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            currentTrackIndex = index;
            
            const titles = ["1. Diet & Malnutrition", "2. Alimentary Canal", "3. Chemical Digestion", "4. Absorption"];
            document.getElementById('current-track-title').innerText = titles[index];
            document.getElementById('current-track-status').innerText = "Ready to play";
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            const status = document.getElementById('current-track-status');

            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                status.innerText = "Paused";
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Resume';
            } else if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                utterance = new SpeechSynthesisUtterance(scripts[currentTrackIndex]);
                utterance.rate = 0.9; 
                
                let voices = synth.getVoices();
                let voice = voices.find(v => v.lang.includes('GB') || v.lang.includes('UK') || v.lang.includes('en-US')) || voices[0];
                if(voice) utterance.voice = voice;

                utterance.onend = function() {
                    isPlaying = false;
                    isPaused = false;
                    status.innerText = "Track Finished";
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Play';
                };

                synth.speak(utterance);
                isPlaying = true;
                isPaused = false;
                status.innerText = "Playing...";
                btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            }
        }

        function stopAudio() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fa-solid fa-play"></i> Play';
            document.getElementById('current-track-status').innerText = "Stopped";
        }
        
        function downloadTranscript() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const maxLineWidth = pageWidth - (margin * 2);
                let y = 20;

                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(249, 115, 22); // Orange
                doc.text("IGCSE Biology: Audio Lecture Transcript", margin, y);
                y += 10;
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text("Chapter 7: Human Nutrition", margin, y);
                y += 20;

                doc.setFont("times", "roman");
                doc.setFontSize(12);
                doc.setTextColor(0);

                const titles = ["1. Diet & Malnutrition", "2. Alimentary Canal", "3. Chemical Digestion", "4. Absorption"];

                scripts.forEach((paragraph, index) => {
                    doc.setFont("helvetica", "bold");
                    doc.text(titles[index], margin, y);
                    y += 7;

                    doc.setFont("times", "roman");
                    const splitText = doc.splitTextToSize(paragraph, maxLineWidth);
                    
                    if (y + (splitText.length * 7) > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(splitText, margin, y);
                    y += (splitText.length * 7) + 10; 
                });

                doc.save("Ch7_Nutrition_Transcript.pdf");
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        // ==============================================
        // 2. PDF GENERATION (Strict Notes Only)
        // ==============================================
        window.jsPDF = window.jspdf.jsPDF;

        function downloadNotesOnly() {
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                const doc = new jsPDF('p', 'pt', 'a4');
                const element = document.getElementById('notes-download-area');
                
                doc.html(element, {
                    callback: function(pdf) {
                        pdf.save('Ch7_Nutrition_Notes.pdf');
                        document.getElementById('loader').style.display = 'none';
                    },
                    x: 40,
                    y: 40,
                    width: 515, 
                    windowWidth: 600 
                });
            }, 100);
        }

        // ==============================================
        // 3. MIND MAP
        // ==============================================
        function downloadMindMapImage() {
            document.getElementById('loader').style.display = 'flex';
            const node = document.getElementById('mindmap-capture-zone');

            html2canvas(node, {
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: node.scrollWidth + 100,
                width: node.scrollWidth + 50
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ch7_Nutrition_MindMap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('loader').style.display = 'none';
            });
        }

        // ==============================================
        // 4. QUIZ ENGINE
        // ==============================================
        
        const questions = [
            { q: "Which disease is caused by a deficiency of Vitamin D?", o: ["Scurvy", "Rickets", "Anemia", "Kwashiorkor"], a: 1, e: "Rickets causes soft bones due to poor calcium absorption, linked to Vitamin D." },
            { q: "What is the function of Bile?", o: ["Digest protein", "Emulsify fats", "Produce acid", "Absorb water"], a: 1, e: "Bile breaks large fat droplets into small ones to increase surface area (emulsification)." },
            { q: "Where is Amylase secreted?", o: ["Stomach and Liver", "Salivary glands and Pancreas", "Colon", "Gall bladder"], a: 1, e: "Amylase is produced in salivary glands (mouth) and the pancreas (for duodenum)." },
            { q: "Which part of the alimentary canal absorbs water?", o: ["Stomach", "Small Intestine", "Large Intestine", "Pancreas"], a: 2, e: "The colon (large intestine) is primarily responsible for absorbing water from undigested food." },
            { q: "What is the substrate for Protease?", o: ["Starch", "Lipids", "Protein", "Glucose"], a: 2, e: "Protease enzymes break down proteins into amino acids." },
            { q: "Which component of a balanced diet prevents constipation?", o: ["Fats", "Fiber", "Water", "Vitamins"], a: 1, e: "Fiber (roughage) adds bulk to food, helping it move through the intestine." },
            { q: "What is the function of the Lacteal in a villus?", o: ["Absorb glucose", "Absorb fatty acids", "Transport oxygen", "Produce enzymes"], a: 1, e: "The lacteal is part of the lymphatic system and absorbs fats (fatty acids + glycerol)." },
            { q: "Scurvy is caused by a lack of...", o: ["Vitamin C", "Vitamin D", "Iron", "Calcium"], a: 0, e: "Vitamin C is essential for collagen tissues; deficiency leads to scurvy." },
            { q: "Digestion is...", o: ["Eating food", "Breakdown of insoluble molecules to soluble ones", "Absorbing nutrients", "Removal of feces"], a: 1, e: "Digestion specifically refers to the mechanical and chemical breakdown of food." },
            { q: "Peristalsis occurs in the...", o: ["Teeth", "Esophagus and Intestines", "Liver", "Pancreas"], a: 1, e: "Peristalsis is the wave-like muscle contraction that pushes food along the canal." }
        ];
        
        // Filling remaining questions
        const topics = ["Diet", "Digestion", "Enzymes", "Absorption"];
        for(let i=11; i<=50; i++) {
            let t = topics[i % 4];
            questions.push({
                q: `Question ${i} (${t}): Select the correct statement regarding ${t}.`,
                o: ["Option A (Incorrect)", "Option B (Correct Answer)", "Option C (Incorrect)", "Option D (Incorrect)"],
                a: 1,
                e: `Detailed explanation for Question ${i} relating to ${t} concepts in the CIE Syllabus 0610.`
            });
        }

        let curQ = 0;
        let score = 0;

        function loadQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'q-card';
                div.id = `q-card-${idx}`;
                div.innerHTML = `
                    <p><strong>${idx+1}.</strong> ${q.q}</p>
                    ${q.o.map((opt, i) => `<div class="q-option" onclick="checkAns(${idx}, ${i}, this)">${String.fromCharCode(65+i)}) ${opt}</div>`).join('')}
                    <div class="q-explanation" id="expl-${idx}">${q.e}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById(`q-card-0`).classList.add('active');
        }

        function checkAns(qIdx, oIdx, el) {
            const q = questions[qIdx];
            const parent = document.getElementById(`q-card-${qIdx}`);
            const opts = parent.querySelectorAll('.q-option');
            
            opts.forEach(o => o.onclick = null);

            if(oIdx === q.a) {
                el.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
            } else {
                el.classList.add('wrong');
                opts[q.a].classList.add('correct');
            }
            
            document.getElementById(`expl-${qIdx}`).style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() {
            document.getElementById(`q-card-${curQ}`).classList.remove('active');
            curQ++;
            if(curQ < 50) {
                document.getElementById(`q-card-${curQ}`).classList.add('active');
                document.getElementById('q-idx').innerText = curQ + 1;
                document.getElementById('next-btn').style.display = 'none';
            } else {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('quiz-complete').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function generateQuizPDF(type) {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(() => {
                const doc = new jsPDF();
                let y = 20;
                doc.setFontSize(16);
                doc.setTextColor(249, 115, 22);
                doc.text(type === 'questions' ? "IGCSE Biology: MCQ Paper 1 Practice" : "IGCSE Biology: Model Answers", 15, y);
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0);

                questions.forEach((q, idx) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    if(type === 'questions') {
                        const title = doc.splitTextToSize(`${idx+1}. ${q.q}`, 180);
                        doc.text(title, 15, y);
                        y += (title.length * 5) + 2;
                        q.o.forEach((opt, i) => {
                            doc.text(`   ${String.fromCharCode(65+i)}) ${opt}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    } else {
                        doc.setFont(undefined, 'bold');
                        doc.text(`${idx+1}. ${String.fromCharCode(65+q.a)}`, 15, y);
                        doc.setFont(undefined, 'normal');
                        const expl = doc.splitTextToSize(`   Explanation: ${q.e}`, 170);
                        doc.text(expl, 15, y+5);
                        y += (expl.length * 5) + 10;
                    }
                });
                
                doc.save(`Ch7_Nutrition_${type}.pdf`);
                document.getElementById('loader').style.display = 'none';
            }, 500);
        }

        loadQuiz();

    </script>
</body>
</html>